# Current Authentication System - Technical Specification
## Red AI Electron App - As Implemented

---

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ELECTRON APP                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚  Frontend UI    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Preload API     â”‚           â”‚
â”‚  â”‚  (HTML/JS)      â”‚         â”‚  (IPC Bridge)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚           â”‚                            â”‚                      â”‚
â”‚           â–¼                            â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚           Main Process (Electron)             â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚  â€¢ subscription-manager.js                    â”‚           â”‚
â”‚  â”‚  â€¢ mongodb-service.js                         â”‚           â”‚
â”‚  â”‚  â€¢ settings-manager.js                        â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                       â”‚                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   MongoDB Atlas      â”‚
            â”‚  Collection: users   â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ File Structure

```
electron/
â”œâ”€â”€ mongodb-service.js          # Database operations, CRUD, auth
â”œâ”€â”€ subscription-manager.js     # Feature gating, usage tracking
â”œâ”€â”€ settings-manager.js         # Local settings storage
â”œâ”€â”€ main.js                     # IPC handlers, app lifecycle
â””â”€â”€ preload.js                  # Renderer â†” Main bridge

public/
â”œâ”€â”€ subscription-settings.html  # Login/Register UI
â”œâ”€â”€ subscription-settings.js    # Login/Register logic
â””â”€â”€ frontend.html              # Settings page integration
```

---

## ğŸ—„ï¸ Database Schema

**Collection:** `users`

```javascript
{
  _id: ObjectId("..."),              // Auto-generated by MongoDB
  
  // Authentication
  email: "user@example.com",         // Unique, required
  password: "$2b$10$...",             // bcrypt hash (10 rounds)
  
  // Profile
  fullName: "John Doe",              // Display name
  
  // Timestamps
  createdAt: ISODate("2025-11-04T..."),
  lastLogin: ISODate("2025-11-04T..."),
  updatedAt: ISODate("2025-11-04T..."),
  
  // Subscription
  subscription: {
    tier: "free",                    // "free" | "super-red" | "ultra-red"
    status: "active",                // "active" | "inactive" | "expired"
    expiresAt: null                  // Date or null (lifetime)
  },
  
  // Usage Tracking
  usage: {
    messagesUsedToday: 0,            // Reset daily at midnight
    lastResetDate: ISODate("..."),   // Last midnight reset
    transcriptionMinutesUsed: 0,     // Cumulative
    activeWorkflows: 0               // Current count
  },
  
  // Settings
  preferences: {}                    // User-specific settings
}
```

**Indexes:**
- `email` (unique)

---

## ğŸ” Authentication Methods

### 1. Registration

**File:** `electron/mongodb-service.js` â†’ `registerUser()`

```javascript
// Input
{
  email: "user@example.com",
  password: "plain-text-password",
  fullName: "John Doe"
}

// Process
1. Check if email exists
2. Hash password with bcrypt (10 rounds)
3. Create user document with default values:
   - subscription.tier = 'free'
   - subscription.status = 'active'
   - usage.messagesUsedToday = 0

// Output
{
  success: true,
  user: {
    _id: "...",
    email: "...",
    fullName: "...",
    subscription: { tier: 'free', ... },
    usage: { ... }
  }
}
```

### 2. Login

**File:** `electron/mongodb-service.js` â†’ `authenticateUser()`

```javascript
// Input
{
  email: "user@example.com",
  password: "plain-text-password"
}

// Process
1. Find user by email
2. Compare password with bcrypt.compare()
3. Update lastLogin timestamp
4. Check if daily reset needed
5. Load subscription tier info

// Output
{
  success: true,
  user: {
    _id: "...",
    email: "...",
    fullName: "...",
    subscription: {
      tier: "free",
      status: "active",
      features: ["Basic chat", ...],
      limits: { messages_per_day: 20, ... }
    },
    usage: { ... }
  }
}
```

### 3. Session Management

**File:** `electron/subscription-manager.js` + `electron/settings-manager.js`

```javascript
// After successful login:
1. subscriptionManager.setCurrentUser(user)
2. settingsManager.setCurrentUser(user)
3. settingsManager.updateSubscription(subscription)

// Session stored in electron-store (persists)
// Location: ~/Library/Application Support/red-glass/config.json
```

---

## ğŸ¯ Subscription Tiers

### Tier Configuration

**File:** `electron/mongodb-service.js`

```javascript
const SUBSCRIPTION_TIERS = {
  free: {
    name: 'Free',
    messagesPerDay: 20,
    workflows: { max: 2, maxSteps: 1 },
    mcpConnections: 0,
    transcriptionHours: 0,
    features: [
      'Basic chat functionality',
      'Up to 2 simple workflows',
      'Community support'
    ]
  },
  
  'super-red': {
    name: 'Super-Red',
    messagesPerDay: 300,
    workflows: { max: Infinity, maxSteps: 3 },
    mcpConnections: 3,
    transcriptionHours: 3,
    features: [
      '300 messages per day',
      'Unlimited multi-step workflows (up to 3 steps)',
      '3 MCP connections',
      '3 hours transcription per month',
      'Priority support'
    ]
  },
  
  'ultra-red': {
    name: 'Ultra-Red',
    messagesPerDay: Infinity,
    workflows: { max: Infinity, maxSteps: Infinity },
    mcpConnections: Infinity,
    transcriptionHours: Infinity,
    features: [
      'Unlimited messages',
      'Unlimited workflows & integrations',
      'Full transcription access',
      'Behavioral analysis',
      'Dedicated support'
    ]
  }
};
```

---

## ğŸš¦ Feature Gating

**File:** `electron/subscription-manager.js`

### Check Feature Access

```javascript
// General feature check
subscriptionManager.canUseFeature('transcription')
// Returns: { allowed: true/false, reason?: string }

// Specific checks
subscriptionManager.canSendMessage()
// Returns: { allowed: true/false, remaining: 15, reason?: string }

subscriptionManager.canCreateWorkflow(stepCount)
// Returns: { allowed: true/false, reason?: string }

subscriptionManager.canAddMCPConnection(currentCount)
// Returns: { allowed: true/false, remaining: 2, reason?: string }

subscriptionManager.canUseTranscription()
// Returns: { allowed: true/false, remaining: 180 mins, reason?: string }
```

### Usage Tracking

```javascript
// Increment usage
await subscriptionManager.incrementMessageUsage()
await subscriptionManager.updateTranscriptionUsage(5) // 5 minutes
await subscriptionManager.updateWorkflowCount(3)

// Get usage stats
const stats = subscriptionManager.getUsageStats()
// Returns:
{
  tier: 'free',
  messages: { used: 5, limit: 20, remaining: 15 },
  workflows: { active: 2, limit: 2, maxSteps: 1 },
  transcription: { used: 0, limit: 0 },
  mcpConnections: { limit: 0 }
}
```

---

## ğŸ“¡ IPC API Reference

### Authentication Endpoints

```javascript
// Login
await window.electronAPI.mongodbAuthenticate(email, password)

// Register
await window.electronAPI.mongodbRegister({
  email, password, fullName
})

// Logout
await window.electronAPI.mongodbLogout()
```

### User Management

```javascript
// Get current subscription
await window.electronAPI.subscriptionGet()

// Get usage statistics
await window.electronAPI.subscriptionGetUsage()

// Refresh user data from DB
await window.electronAPI.refreshUserData()

// Update user profile
await window.electronAPI.invoke('mongodb-update-user', userId, {
  fullName: 'New Name',
  email: 'newemail@example.com'
})
```

### Feature Access Checks

```javascript
// Check specific feature
await window.electronAPI.checkFeatureAccess('transcription')

// Check message limit
await window.electronAPI.checkMessageLimit()

// Check workflow creation
await window.electronAPI.checkWorkflowLimit(stepCount)

// Check MCP connections
await window.electronAPI.checkMcpLimit(currentCount)
```

### Usage Tracking

```javascript
// Increment message count
await window.electronAPI.incrementMessageUsage()

// Track transcription
await window.electronAPI.updateTranscriptionUsage(minutes)

// Update workflow count
await window.electronAPI.updateWorkflowCount(count)
```

---

## ğŸ”„ Daily Reset Logic

**Automatic Daily Reset:**

When user logs in or when `getUserByEmail()` is called:

```javascript
const today = new Date().toISOString().split('T')[0]
const lastReset = user.usage.lastResetDate.toISOString().split('T')[0]

if (lastReset !== today) {
  // Reset daily counters
  await resetDailyUsage(userId)
  user.usage.messagesUsedToday = 0
  user.usage.lastResetDate = new Date()
}
```

---

## ğŸ¨ UI Integration

### Login Form

**Location:** Subscription Settings Tab

**Elements:**
- Email input
- Password input  
- Sign In button
- Link to registration

**Flow:**
1. User enters credentials
2. Clicks "Sign In"
3. `handleLogin()` â†’ `mongodbAuthenticate()`
4. On success â†’ Load subscription info and usage
5. Show subscription details and usage stats

### Settings Page

**Location:** Settings Window â†’ Account Section

**Behavior:**
- If logged in: Show account info
- If not logged in: Show login form
- After login: Display user profile and subscription

---

## ğŸ”§ Integration Points for Landing Page

### Option A: Direct MongoDB (Recommended)

Landing page creates users in same MongoDB:

```javascript
// Landing page backend
await mongoClient.collection('users').insertOne({
  email: req.body.email,
  password: await bcrypt.hash(req.body.password, 10),
  fullName: req.body.fullName,
  createdAt: new Date(),
  subscription: {
    tier: 'free', // or paid tier
    status: 'active',
    expiresAt: null
  },
  usage: {
    messagesUsedToday: 0,
    lastResetDate: new Date(),
    transcriptionMinutesUsed: 0,
    activeWorkflows: 0
  },
  preferences: {}
})

// App can then authenticate this user immediately
```

### Option B: API Bridge

Create shared backend API:

```
POST /api/auth/register
POST /api/auth/login
GET  /api/auth/me
PUT  /api/user/profile
GET  /api/subscription
POST /api/subscription/upgrade
```

App calls API instead of direct MongoDB.

---

## ğŸ“ Notes for Integration

1. **Password Format:** Must use bcrypt with 10 salt rounds
2. **Email Uniqueness:** Enforced at database level
3. **Default Tier:** New users get 'free' tier
4. **Session Persistence:** Stored locally, survives app restart
5. **Daily Reset:** Happens automatically on first action after midnight
6. **Tier Changes:** Immediate effect, no app restart needed

---

## ğŸ§ª Testing

**Test Account Creation:**
```javascript
{
  email: "test@example.com",
  password: "Test123!",
  fullName: "Test User"
}
```

**Verify in MongoDB:**
```javascript
db.users.findOne({ email: "test@example.com" })
```

**Expected Result:**
- User created with hashed password
- Default 'free' tier
- All usage counters at 0

---

**Last Updated:** November 4, 2025
**System Version:** 1.0
**MongoDB Connection:** Active âœ…
**Authentication:** Fully Functional âœ…
**Feature Gating:** Implemented âœ…


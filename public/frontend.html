<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Floating Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        /* CSS Variables - Light Minimal Theme */
        :root {
            --window-bg-opacity: 0.98;
            --frosted-bg: rgba(248, 246, 243, 0.95);
            --frosted-backdrop-filter: blur(40px) saturate(120%);
            --glassmorphism-bg: rgba(255, 255, 255, 0.95);
            --glassmorphism-border: rgba(0, 0, 0, 0.08);
            --glassmorphism-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            --enhanced-blur: blur(40px) saturate(120%);
            --text-primary: #1A1A1A;
            --text-secondary: #4A4A4A;
            --text-muted: #9CA3AF;
            --bg-primary: #F8F6F3;
            --bg-card: #FFFFFF;
            --bg-hover: #F0EEEB;
            --border-color: #E5E5E5;
            --accent-blue: #3B82F6;
            --accent-red: #EF4444;
        }

        /* Basic styles for the body */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: transparent;
            font-family: 'Inter', sans-serif;
            margin: 0;
        }

        /* Liquid Glass SVG Filter */
        .liquid-glass-filter {
            position: absolute;
            width: 0;
            height: 0;
        }

        /* Liquid Glass Effect for Components */
        .liquid-glass {
            position: relative;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.4) 0%,
                    rgba(255, 255, 255, 0.1) 50%,
                    rgba(255, 255, 255, 0.3) 100%) !important;
            backdrop-filter: blur(40px) saturate(200%) brightness(105%) !important;
            -webkit-backdrop-filter: blur(40px) saturate(200%) brightness(105%) !important;
            border: 1px solid rgba(255, 255, 255, 0.5) !important;
            box-shadow: none !important;
            overflow: hidden;
        }

        .liquid-glass::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg,
                    rgba(255, 255, 255, 0.3) 0%,
                    rgba(255, 255, 255, 0) 40%,
                    rgba(255, 255, 255, 0.1) 100%);
            pointer-events: none;
            z-index: 1;
        }

        .liquid-glass::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(ellipse at 30% 20%,
                    rgba(255, 255, 255, 0.3) 0%,
                    transparent 50%);
            pointer-events: none;
            z-index: 2;
            animation: liquidShimmer 8s ease-in-out infinite;
        }

        @keyframes liquidShimmer {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
                opacity: 0.5;
            }

            25% {
                transform: translate(2%, 1%) rotate(1deg);
                opacity: 0.7;
            }

            50% {
                transform: translate(0, 2%) rotate(0deg);
                opacity: 0.5;
            }

            75% {
                transform: translate(-2%, 1%) rotate(-1deg);
                opacity: 0.7;
            }
        }

        /* Edge refraction effect */
        .liquid-glass-edge {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border-radius: inherit;
            pointer-events: none;
            z-index: 3;
            background:
                linear-gradient(90deg, rgba(255, 255, 255, 0.4) 0%, transparent 3%, transparent 97%, rgba(255, 255, 255, 0.4) 100%),
                linear-gradient(180deg, rgba(255, 255, 255, 0.5) 0%, transparent 3%, transparent 97%, rgba(255, 255, 255, 0.3) 100%);
            filter: url(#liquid-distortion);
        }

        /* Main container for the floating assistant */
        .assistant-container {
            position: fixed;
            top: 20px;
            left: 0;
            right: 0;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1000;
            width: fit-content;
        }

        .navigation {
            position: relative;
            height: 70px;
            background: var(--bg-card) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 35px;
            display: flex;
            justify-content: flex-start;
            align-items: center;
            box-shadow: var(--glassmorphism-shadow) !important;
            padding: 0 10px;
            box-shadow: none !important;
            user-select: none;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: auto;
            min-width: 300px;
            overflow: hidden;
        }

        .navigation::before {
            display: none;
        }

        .navigation::after {
            display: none;
        }

        @keyframes navLiquidShimmer {

            0%,
            100% {
                transform: translate(0, 0);
                opacity: 0.6;
            }

            33% {
                transform: translate(5%, 2%);
                opacity: 0.8;
            }

            66% {
                transform: translate(-3%, 1%);
                opacity: 0.5;
            }
        }

        .navigation:hover {
            background: rgba(60, 60, 65, 0.9) !important;
            border-color: rgba(255, 255, 255, 0.25) !important;
            box-shadow: none !important;
        }

        /* Drag handle - inline button in navigation */
        .drag-handle {
            position: relative;
            width: 44px;
            height: 44px;
            cursor: grab;
            color: #fff;
            background: #ef4444;
            border: 1px solid #ef4444;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            z-index: 2;
            flex-shrink: 0;
            box-sizing: border-box;
        }

        .drag-handle:hover {
            color: #fff;
            background: #ef4444;
            border-color: #ef4444;
            transform: translateY(-1px) scale(1.02);
            box-shadow: none;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .drag-handle svg {
            width: 20px;
            height: 20px;
            pointer-events: none;
        }

        .navbar-nav {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 0;
            width: 100%;
            height: 100%;
            position: relative;
            z-index: 10;
            align-items: center;
        }

        .nav-item {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 50px;
            cursor: pointer;
            border-radius: 25px;
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1),
                background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            margin: 0 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
            transition: color 0.3s ease;
            white-space: nowrap;
            overflow: hidden;
            height: 100%;
            padding: 0 20px;
        }

        .nav-link i {
            font-size: 1.3em;
            min-width: 30px;
            text-align: center;
            transition: color 0.3s ease;
            color: rgba(255, 255, 255, 0.8);
        }

        .nav-text {
            opacity: 0;
            max-width: 0;
            margin-left: 0;
            overflow: hidden;
            transition: opacity 0.2s ease 0.1s, max-width 0.3s ease, margin-left 0.3s ease;
        }

        .nav-item.active {
            background-color: #ef4444;
        }

        .nav-item.active .nav-link {
            color: #fff;
        }

        .nav-item:not(.active):hover .nav-link {
            color: var(--text-primary);
        }

        .nav-item.active .nav-text {
            opacity: 1;
            max-width: 150px;
            margin-left: 8px;
        }

        /* Content window container - positioned below horizontal bar */
        .window-container {
            width: 800px;
            max-width: 95vw;
            position: absolute;
            top: calc(100% + 40px);
            left: 50%;
            transform: translateX(-50%);
            max-height: calc(100vh - 160px);
            overflow: visible;
        }

        .window {
            position: relative;
            background: var(--bg-primary) !important;
            backdrop-filter: blur(20px) !important;
            -webkit-backdrop-filter: blur(20px) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 20px;
            padding: 0;
            display: none;
            color: var(--text-primary);
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            scrollbar-width: none;
            box-sizing: border-box;
            box-shadow: var(--glassmorphism-shadow) !important;
        }

        .window::before {
            display: none;
        }

        .window::after {
            display: none;
        }

        @keyframes windowLiquidShimmer {

            0%,
            100% {
                transform: translate(0, 0);
                opacity: 0.5;
            }

            50% {
                transform: translate(3%, 2%);
                opacity: 0.7;
            }
        }

        .window>* {
            position: relative;
            z-index: 1;
        }

        .window::-webkit-scrollbar {
            display: none;
        }

        .window.visible {
            display: block;
            animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        #chat-window.visible {
            display: flex;
        }

        #mcp-window {
            width: 100%;
            border-radius: 20px;
        }

        #settings-window {
            min-height: auto;
            height: auto;
            max-height: 600px;
            border-radius: 20px;
            overflow: hidden;
        }

        #workflows-window.visible {
            display: block;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Typing indicator container - enhanced with status text */
        .typing-indicator-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            margin: 8px 0;
            padding: 4px 0;
            gap: 10px;
        }

        /* Typing indicator styles - Red logo with circular spinner */
        .typing-indicator {
            position: relative;
            width: 32px;
            height: 32px;
            flex-shrink: 0;
        }

        .typing-logo {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .typing-logo svg {
            width: 18px;
            height: 18px;
        }

        .typing-spinner {
            position: absolute;
            top: 0;
            left: 0;
            width: 32px;
            height: 32px;
            border: 2px solid transparent;
            border-top-color: #ef4444;
            border-right-color: #ef4444;
            border-radius: 50%;
            animation: spinLoader 0.8s linear infinite;
            z-index: 1;
            box-sizing: border-box;
        }

        @keyframes spinLoader {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Thinking status text - clean minimal layout */
        .thinking-status {
            display: inline-flex;
            align-items: center;
        }

        .thinking-text {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.85);
            display: inline-flex;
            align-items: center;
        }

        .thinking-text-word {
            display: inline-block;
            animation: thinkingFadeIn 0.4s ease-out forwards;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }

        @keyframes thinkingFadeIn {
            from {
                opacity: 0;
                transform: translateX(-4px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* Hide dots, separator, and hint for cleaner look */
        .thinking-dots,
        .thinking-separator,
        .thinking-hint {
            display: none;
        }

        /* Screen capture indicator - uses same thinking animation styles */

        /* Screen capture response badge */
        .screen-capture-context-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.06));
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 16px;
            font-size: 11px;
            font-weight: 500;
            color: rgba(239, 68, 68, 0.9);
            margin-bottom: 10px;
            animation: badgeFadeIn 0.3s ease-out;
        }

        .screen-capture-context-badge svg {
            width: 12px;
            height: 12px;
            opacity: 0.9;
        }

        /* Transcription attached tag for user messages */
        .transcription-attached-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 3px 8px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.25);
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            color: rgba(239, 68, 68, 0.85);
            margin-bottom: 6px;
            animation: badgeFadeIn 0.3s ease-out;
        }

        .transcription-attached-tag svg {
            width: 10px;
            height: 10px;
            opacity: 0.9;
        }

        @keyframes badgeFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Workflow execution animation styles */
        .workflow-indicator-container {
            display: flex;
            align-items: flex-start;
            margin: 10px 0;
            align-self: flex-start;
            padding: 0;
        }

        .workflow-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(79, 70, 229, 0.15));
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }

        .workflow-indicator::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(147, 51, 234, 0.2), transparent);
            animation: workflowShimmer 2s infinite;
        }

        @keyframes workflowShimmer {
            0% {
                left: -100%;
            }

            100% {
                left: 100%;
            }
        }

        .workflow-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .workflow-icon-inner {
            font-size: 20px;
            animation: workflowPulse 1s ease-in-out infinite;
        }

        @keyframes workflowPulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }

        .workflow-spinner {
            position: absolute;
            top: -4px;
            left: -4px;
            width: 40px;
            height: 40px;
            border: 2px solid transparent;
            border-top-color: #9333ea;
            border-right-color: #4f46e5;
            border-radius: 50%;
            animation: spinLoader 1s linear infinite;
        }

        .workflow-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .workflow-name {
            color: #c084fc;
            font-weight: 600;
            font-size: 13px;
        }

        .workflow-status {
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
        }

        .workflow-complete {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.15), rgba(16, 185, 129, 0.15));
            border-color: rgba(34, 197, 94, 0.3);
        }

        .workflow-complete .workflow-name {
            color: #4ade80;
        }

        /* Voice Workflow Preview Card */
        .voice-workflow-preview {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.12), rgba(79, 70, 229, 0.12));
            border: 1px solid rgba(147, 51, 234, 0.35);
            border-radius: 14px;
            margin: 12px 0;
            max-width: 400px;
            align-self: flex-start;
            animation: voicePreviewSlideIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        @keyframes voicePreviewSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .voice-workflow-preview-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(147, 51, 234, 0.2);
        }

        .voice-workflow-preview-header .preview-icon {
            font-size: 20px;
            animation: voiceIconPulse 1.5s ease-in-out infinite;
        }

        @keyframes voiceIconPulse {

            0%,
            100% {
                transform: scale(1);
                filter: brightness(1);
            }

            50% {
                transform: scale(1.15);
                filter: brightness(1.3);
            }
        }

        .voice-workflow-preview-header .preview-title {
            font-size: 14px;
            font-weight: 600;
            color: #c084fc;
        }

        .voice-workflow-preview-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .voice-workflow-preview-content .preview-name {
            font-size: 16px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
        }

        .voice-workflow-preview-content .preview-description {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.4;
        }

        .voice-workflow-preview-content .preview-trigger,
        .voice-workflow-preview-content .preview-actions {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            padding: 6px 10px;
            background: rgba(147, 51, 234, 0.1);
            border-radius: 8px;
        }

        .voice-workflow-preview-content .preview-trigger strong,
        .voice-workflow-preview-content .preview-actions strong {
            color: #7c3aed;
        }

        .voice-workflow-preview-hint {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            padding-top: 10px;
            border-top: 1px solid rgba(147, 51, 234, 0.15);
            animation: voiceHintPulse 2s ease-in-out infinite;
        }

        @keyframes voiceHintPulse {

            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        /* Transcription Preview Modal */
        .transcription-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: transparent;
            display: none;
            align-items: center;
            pointer-events: none;
            justify-content: center;
            z-index: 10000;
        }

        .transcription-preview-modal.visible {
            display: flex;
            animation: fadeIn 0.2s ease;
        }

        .transcription-modal-content {
            background: rgba(50, 50, 55, 0.92);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            width: 90%;
            max-width: 480px;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            animation: slideInUp 0.25s ease;
            box-shadow: none;
            pointer-events: auto;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .transcription-modal-content .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .transcription-modal-content .modal-header h3 {
            margin: 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .transcription-modal-content .modal-header h3 svg {
            color: #ef4444;
            width: 16px;
            height: 16px;
        }

        .transcription-modal-content .close-modal-btn {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.4);
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .transcription-modal-content .close-modal-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.8);
        }

        .transcription-modal-content .modal-body {
            padding: 16px 18px;
            overflow-y: auto;
            flex: 1;
        }

        .transcription-modal-content .modal-body::-webkit-scrollbar {
            width: 4px;
        }

        .transcription-modal-content .modal-body::-webkit-scrollbar-track {
            background: transparent;
        }

        .transcription-modal-content .modal-body::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .transcription-modal-content .transcription-text-preview {
            font-family: inherit;
            font-size: 13px;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.75);
            white-space: pre-wrap;
        }

        .transcription-modal-content .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .transcription-modal-content .word-count-info {
            color: rgba(255, 255, 255, 0.4);
            font-size: 12px;
        }

        .transcription-modal-content .remove-transcription-btn {
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 8px 14px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .transcription-modal-content .remove-transcription-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .workflow-complete .workflow-spinner {
            display: none;
        }

        .workflow-complete .workflow-icon-inner {
            animation: none;
        }

        .capture-success-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }

        .capture-success-icon svg {
            width: 100%;
            height: 100%;
            stroke: #10b981;
            stroke-width: 1.5;
        }

        /* Notification Sticker Animations */
        @keyframes stickerSlideIn {
            0% {
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes stickerSlideOut {
            0% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateX(20px) scale(0.95);
            }
        }

        .notification-sticker {
            transition: all 0.2s ease;
        }

        .notification-sticker:hover {
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* ================================
           WORKFLOW PREVIEW CARD
           ================================ */
        .workflow-preview-card {
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.1), rgba(79, 70, 229, 0.1));
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 16px;
            padding: 20px;
            margin: 16px 0;
            animation: cardSlideIn 0.3s ease-out;
        }

        @keyframes cardSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .preview-icon {
            font-size: 20px;
        }

        .preview-title {
            font-weight: 600;
            color: #c084fc;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .preview-name {
            font-size: 18px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 4px;
        }

        .preview-description {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 16px;
        }

        .preview-details {
            background: rgba(147, 51, 234, 0.08);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 16px;
            font-size: 13px;
        }

        .preview-trigger,
        .preview-actions {
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.8);
        }

        .preview-trigger strong,
        .preview-actions strong {
            color: #9333ea;
        }

        .preview-buttons {
            display: flex;
            gap: 10px;
        }

        .preview-buttons button {
            flex: 1;
            padding: 10px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 13px;
        }

        .btn-create-workflow {
            background: linear-gradient(135deg, #9333ea, #4f46e5);
            color: white;
        }

        .btn-create-workflow:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
        }

        .btn-modify-workflow {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .btn-modify-workflow:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .btn-cancel-workflow {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        .btn-cancel-workflow:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        .workflow-generating {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 16px;
            margin: 12px 0;
            background: linear-gradient(135deg, rgba(147, 51, 234, 0.15), rgba(79, 70, 229, 0.15));
            border: 1px solid rgba(147, 51, 234, 0.3);
            border-radius: 12px;
            color: #c084fc;
            font-size: 14px;
        }

        .workflow-generating .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(147, 51, 234, 0.3);
            border-top-color: #c084fc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Typewriter animation styles */
        .typewriter-text {
            overflow: hidden;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .typewriter-cursor {
            display: inline-block;
            background-color: rgba(0, 0, 0, 0.7);
            width: 2px;
            height: 1em;
            animation: blink 1s infinite;
            margin-left: 1px;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* Chat window specific styles */
        #chat-window {
            display: none;
            /* Overridden by .visible */
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .conversation-view {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            padding: 24px;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }

        /* Scrollbar styling */
        .conversation-view::-webkit-scrollbar {
            width: 6px;
        }

        .conversation-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversation-view::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        .conversation-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .conversation-view::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.4);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 3px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-radius: 18px;
            max-width: 75%;
            word-wrap: break-word;
            width: fit-content;
        }

        .message .text-content {
            flex-grow: 1;
        }

        .message .screen-capture-icon {
            flex-shrink: 0;
            width: 16px;
            height: 16px;
            color: #ef4444;
        }

        .user-message {
            background: var(--text-primary);
            border: none;
            color: #fff;
            align-self: flex-end;
            border-radius: 16px;
            border-bottom-right-radius: 4px;
            padding: 12px 16px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .ai-message {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            align-self: flex-start;
            padding: 16px;
            border-radius: 16px;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
        }

        .ai-message-icon {
            flex-shrink: 0;
            width: 28px;
            height: 28px;
            margin-top: 4px;
        }

        .ai-message-icon svg {
            width: 100%;
            height: 100%;
        }

        .ai-message .text-content {
            padding: 6px 0;
            line-height: 1.5;
        }
        
        .ai-message .text-content br {
            display: block;
            content: "";
            margin: 4px 0;
        }

        /* Markdown Rendering Styles - Compact */
        .md-h1 {
            font-size: 1.4em;
            font-weight: 700;
            margin: 8px 0 4px 0;
            color: rgba(255, 255, 255, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 4px;
        }

        .md-h2 {
            font-size: 1.2em;
            font-weight: 600;
            margin: 6px 0 3px 0;
            color: rgba(255, 255, 255, 0.95);
        }

        .md-h3 {
            font-size: 1.1em;
            font-weight: 600;
            margin: 4px 0 2px 0;
            color: rgba(255, 255, 255, 0.9);
        }

        .md-hr {
            border: none;
            height: 1px;
            background: rgba(255, 255, 255, 0.15);
            margin: 8px 0;
        }

        .md-link {
            color: #ef4444;
            text-decoration: none;
            border-bottom: 1px solid rgba(239, 68, 68, 0.3);
            transition: all 0.2s;
        }

        .md-link:hover {
            color: #f87171;
            border-bottom-color: rgba(239, 68, 68, 0.6);
        }

        .md-list {
            margin: 2px 0;
            padding-left: 20px;
            list-style-position: outside;
        }

        .md-list li {
            margin: 2px 0;
            line-height: 1.4;
        }

        ol.md-list {
            list-style-type: decimal;
        }

        ul.md-list {
            list-style-type: disc;
        }

        .md-list li.md-indent-1 {
            margin-left: 12px;
        }

        .md-list li.md-indent-2 {
            margin-left: 24px;
        }

        .md-list li.md-indent-3 {
            margin-left: 36px;
        }

        .md-list li.md-indent-4 {
            margin-left: 48px;
        }

        .md-indent {
            margin-left: 20px;
            padding: 1px 0;
        }

        .md-indent-sm {
            margin-left: 12px;
            padding: 1px 0;
        }

        .code-block {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px 12px;
            margin: 6px 0;
            overflow-x: auto;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            font-size: 13px;
            line-height: 1.4;
        }

        .code-block code {
            background: none;
            padding: 0;
            color: rgba(255, 255, 255, 0.9);
        }

        .inline-code {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 4px;
            padding: 1px 5px;
            font-family: 'SF Mono', 'Monaco', 'Menlo', monospace;
            font-size: 0.9em;
            color: #f87171;
        }

        /* ðŸ†• MCP TOOL USAGE INDICATORS */
        /* Tool Calling Indicator Animation - Red themed minimal */
        .tool-calling-indicator-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            padding: 8px 16px;
            margin: 8px 0;
            animation: toolFadeIn 0.3s ease-out;
        }

        @keyframes toolFadeIn {
            from {
                opacity: 0;
                transform: translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .tool-calling-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .tool-calling-icon {
            display: flex;
            align-items: center;
            color: #ef4444;
            animation: toolIconPulse 2s ease-in-out infinite;
        }

        .tool-calling-icon svg {
            width: 14px;
            height: 14px;
            color: #ef4444;
        }

        @keyframes toolIconPulse {
            0%, 100% {
                opacity: 0.7;
                transform: scale(1);
            }
            50% {
                opacity: 1;
                transform: scale(1.1);
            }
        }

        .tool-calling-text {
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.8);
            display: inline-block;
            animation: toolTextFade 0.4s ease-out forwards;
        }

        @keyframes toolTextFade {
            from {
                opacity: 0;
                transform: translateX(-4px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .tool-calling-dots {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin-left: 2px;
        }

        .tool-calling-dot {
            width: 3px;
            height: 3px;
            background: #ef4444;
            border-radius: 50%;
            animation: toolDotPulse 1.4s ease-in-out infinite;
        }

        .tool-calling-dot:nth-child(1) {
            animation-delay: 0s;
        }

        .tool-calling-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .tool-calling-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes toolDotPulse {
            0%, 60%, 100% {
                opacity: 0.3;
                transform: scale(1);
            }
            30% {
                opacity: 1;
                transform: scale(1.3);
            }
        }

        .mcp-tools-container {
            margin-bottom: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .mcp-tool-usage {
            background: rgba(102, 126, 234, 0.08);
            border-left: 2px solid rgba(102, 126, 234, 0.4);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.6;
        }

        .mcp-tool-usage.mcp-tool-error {
            background: rgba(239, 68, 68, 0.08);
            border-left-color: rgba(239, 68, 68, 0.4);
        }

        .tool-result {
            color: rgba(255, 255, 255, 0.85);
            font-size: 13px;
            font-weight: 400;
            line-height: 1.6;
        }

        .tool-result a,
        .tool-result .tool-link {
            color: #60a5fa;
            text-decoration: none;
            word-break: break-all;
            transition: color 0.2s ease;
            cursor: pointer;
        }

        .tool-result a:hover,
        .tool-result .tool-link:hover {
            color: #93c5fd;
            text-decoration: underline;
        }

        .tool-error-msg {
            color: #ef4444;
            font-size: 13px;
            font-weight: 400;
            line-height: 1.6;
        }

        /* Chat window input styling moved to chat-window.html */
        
        #chat-window input:disabled,
        #chat-window textarea:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Premium Send Button with Icon */
        #chat-window .send-button {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #ef4444;
            cursor: pointer;
            background: #ef4444;
            color: #fff;
            border-radius: 50%;
            height: 42px;
            width: 42px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #chat-window .send-button:hover {
            transform: translateY(-2px) scale(1.05);
            background: #ef4444;
            border-color: #ef4444;
        }

        #chat-window .send-button:active {
            transform: translateY(0) scale(0.98);
        }

        #chat-window .send-button svg {
            width: 20px;
            height: 20px;
        }

        /* Premium Menu Button */
        #chat-window .menu-button {
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            height: 32px;
            width: 32px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        #chat-window .menu-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            transform: scale(1.1);
        }

        #chat-window .menu-button.active {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            transform: rotate(45deg);
        }

        /* Chat History Panel - Fixed at bottom of screen */
        .chat-dropdown-menu {
            position: fixed !important;
            left: 50% !important;
            bottom: 0 !important;
            transform: translateX(-50%) translateY(100%);
            width: 500px;
            max-width: 90vw;
            height: 320px;
            background: rgba(50, 50, 55, 0.92);
            backdrop-filter: blur(40px) saturate(150%);
            -webkit-backdrop-filter: blur(40px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-bottom: none;
            border-radius: 16px 16px 0 0;
            box-shadow: none;
            overflow: hidden;
            pointer-events: none;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1),
                opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            visibility: hidden;
            z-index: 99999;
            display: flex;
            flex-direction: column;
        }

        .chat-dropdown-menu.active {
            opacity: 1;
            visibility: visible;
            pointer-events: all;
            transform: translateX(-50%) translateY(0);
        }
        
        /* Panel header */
        .chat-dropdown-menu::before {
            content: 'Chat History';
            display: block;
            padding: 14px 16px 12px;
            font-size: 12px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            letter-spacing: 0.5px;
            text-transform: uppercase;
            flex-shrink: 0;
            background: rgba(40, 40, 45, 0.6);
        }
        
        /* Hide the default content when showing history */
        .chat-dropdown-menu.active .chat-dropdown-content {
            display: none !important;
        }
        
        /* Ensure history list shows */
        .chat-dropdown-menu.active .chat-history-list {
            display: block !important;
        }

        /* Capture Screen Button */
        #chat-window .capture-button {
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            background: transparent;
            color: rgba(255, 255, 255, 0.7);
            border-radius: 50%;
            height: 42px;
            width: 42px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #chat-window .capture-button:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            transform: scale(1.05);
        }

        #chat-window .capture-button.active {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.4);
        }

        #chat-window .capture-button.active:hover {
            background: rgba(239, 68, 68, 0.3);
            transform: scale(1.05);
        }

        /* ChatGPT-style Quick Actions Overlay Dropdown */
        .quick-action-buttons {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px) scale(0.95);
            width: 320px;
            max-width: 90vw;
            background: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 8px;
            box-shadow:
                0 0 0 1px rgba(255, 255, 255, 0.1),
                0 4px 12px rgba(0, 0, 0, 0.3),
                0 10px 24px rgba(0, 0, 0, 0.4);
            opacity: 0;
            pointer-events: none;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 999999;
        }

        .quick-action-buttons.active {
            opacity: 1;
            pointer-events: all;
            visibility: visible;
            transform: translateX(-50%) translateY(0) scale(1);
        }

        .quick-action-btn {
            display: flex;
            align-items: center;
            gap: 12px;
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 14px;
            font-weight: 400;
            text-align: left;
            line-height: 1.5;
        }

        .quick-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quick-action-btn.active {
            background: rgba(255, 255, 255, 0.15);
        }

        .quick-action-btn svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            opacity: 0.7;
        }

        .quick-action-btn span {
            flex: 1;
        }

        /* Dropdown content area */
        .chat-dropdown-content {
            padding: 16px;
        }

        .chat-dropdown-message {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            padding: 20px 0;
        }


        /* Chat History Items - Panel style */
        .chat-history-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            overscroll-behavior: contain;
            min-height: 0;
        }

        .chat-history-list::-webkit-scrollbar {
            width: 5px;
        }

        .chat-history-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }

        .chat-history-list::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.4);
            border-radius: 3px;
        }

        .chat-history-list::-webkit-scrollbar-thumb:hover {
            background: rgba(239, 68, 68, 0.6);
        }
        
        .chat-dropdown-empty {
            padding: 40px 20px;
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 13px;
        }

        .chat-history-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            padding: 10px 12px;
            cursor: pointer;
            transition: all 0.15s ease;
            border-radius: 8px;
            margin-bottom: 4px;
            background: transparent;
            border: 1px solid transparent;
        }

        .chat-history-item:hover {
            background: rgba(239, 68, 68, 0.08);
            border-color: rgba(239, 68, 68, 0.15);
        }

        .chat-history-item-info {
            flex-grow: 1;
            overflow: hidden;
            padding-right: 8px;
        }

        .chat-history-item-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 4px;
        }

        .chat-history-item-date {
            font-size: 10px;
            color: rgba(239, 68, 68, 0.7);
            font-weight: 500;
        }

        .chat-history-item-count {
            font-size: 9px;
            color: rgba(255, 255, 255, 0.35);
            padding: 1px 5px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 3px;
        }

        .chat-history-item-title {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 400;
            line-height: 1.35;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .chat-history-item-preview {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.4);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
        }

        .chat-history-item-delete {
            opacity: 0;
            transition: all 0.15s;
            padding: 6px;
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.4);
            cursor: pointer;
            flex-shrink: 0;
        }

        .chat-history-item:hover .chat-history-item-delete {
            opacity: 1;
            color: #ef4444;
        }

        .chat-history-item-delete:hover {
            background-color: rgba(239, 68, 68, 0.15);
        }


        #chat-window .icon-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        #chat-window .icon-button.active {
            color: #ef4444;
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
        }


        /* Settings/Authentication Window Styles */
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .auth-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-header h2 {
            color: #fff;
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 600;
        }

        .auth-header p {
            color: rgba(255, 255, 255, 0.7);
            margin: 0;
            font-size: 14px;
        }

        .auth-tabs {
            display: flex;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 4px;
            margin-bottom: 30px;
        }

        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: transparent;
            color: rgba(255, 255, 255, 0.6);
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .auth-tab.active {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid #ef4444;
            color: #ef4444;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: rgba(255, 255, 255, 0.8);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .form-group input:focus {
            border-color: #ef4444;
            background: rgba(255, 255, 255, 0.05);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .auth-button {
            width: 100%;
            padding: 14px;
            background: transparent;
            border: 1px solid #ef4444;
            border-radius: 10px;
            color: #ef4444;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 16px;
        }

        .auth-button:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
        }

        .auth-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-divider {
            display: flex;
            align-items: center;
            margin: 24px 0;
            color: rgba(255, 255, 255, 0.5);
            font-size: 12px;
        }

        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .auth-divider span {
            padding: 0 16px;
        }

        .user-profile {
            display: none;
            text-align: center;
        }

        .user-profile.active {
            display: block;
        }

        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #ef4444;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 600;
            margin: 0 auto 20px;
        }

        .user-info h3 {
            color: #fff;
            margin: 0 0 8px 0;
            font-size: 20px;
        }

        .user-info p {
            color: rgba(255, 255, 255, 0.7);
            margin: 0 0 24px 0;
            font-size: 14px;
        }

        .profile-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .profile-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: transparent;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .profile-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .profile-btn.danger {
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .profile-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #ef4444;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }

        .auth-success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #22c55e;
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Compact Workflows Window Styles */
        #workflows-window {
            padding: 16px !important;
            overflow-y: auto !important;
            overflow-x: hidden !important;
            width: 100%;
            height: 100%;
            box-sizing: border-box;
        }

        #workflows-window .workflow-builder-container {
            width: 100%;
            height: 100%;
        }

        /* Custom scrollbar for workflows window */
        #workflows-window::-webkit-scrollbar {
            width: 6px;
        }

        #workflows-window::-webkit-scrollbar-track {
            background: transparent;
            border-radius: 3px;
        }

        #workflows-window::-webkit-scrollbar-thumb {
            background: rgba(239, 68, 68, 0.3);
            border: 1px solid rgba(239, 68, 68, 0.5);
            border-radius: 3px;
        }

        #workflows-window::-webkit-scrollbar-thumb:hover {
            background: rgba(239, 68, 68, 0.5);
            border-color: rgba(239, 68, 68, 0.7);
        }

        .workflow-container {
            width: 100%;
        }

        .workflow-create-section {
            background: rgba(38, 38, 38, 0.95);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid rgba(74, 74, 74, 0.5);
        }

        .workflow-create-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .workflow-create-header h3 {
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .workflow-field {
            margin-bottom: 14px;
        }

        .workflow-field-label {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            display: block;
        }

        .workflow-input {
            width: 100%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .workflow-input:focus {
            border-color: #ef4444;
            background: rgba(255, 255, 255, 0.05);
        }

        .workflow-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .workflow-select {
            width: 100%;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 36px;
        }

        .workflow-select:focus {
            border-color: #ef4444;
            background-color: rgba(58, 58, 58, 0.95);
        }

        .workflow-select option {
            background: rgba(38, 38, 38, 1);
            color: #fff;
            padding: 8px;
        }

        .workflow-textarea {
            width: 100%;
            background: rgba(58, 58, 58, 0.8);
            border: 1px solid rgba(74, 74, 74, 0.6);
            border-radius: 10px;
            padding: 10px 12px;
            color: #fff;
            font-size: 13px;
            outline: none;
            transition: all 0.3s ease;
            box-sizing: border-box;
            resize: vertical;
            min-height: 70px;
            font-family: inherit;
            line-height: 1.5;
        }

        .workflow-textarea:focus {
            border-color: #ef4444;
            background: rgba(58, 58, 58, 0.95);
        }

        .workflow-textarea::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .workflow-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 16px;
        }

        .workflow-btn {
            padding: 9px 18px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .workflow-btn svg {
            width: 14px;
            height: 14px;
        }

        .workflow-btn-primary {
            background: #ef4444;
            color: white;
        }

        .workflow-btn-primary:hover {
            transform: translateY(-2px);
        }

        .workflow-btn-secondary {
            background: rgba(74, 74, 74, 0.8);
            color: #fff;
        }

        .workflow-btn-secondary:hover {
            background: rgba(90, 90, 90, 0.9);
        }

        .workflows-list-section {
            background: rgba(38, 38, 38, 0.95);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(74, 74, 74, 0.5);
        }

        .workflows-list-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(74, 74, 74, 0.3);
        }

        .workflows-list-header h3 {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            margin: 0;
        }

        .workflow-list-items {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .workflow-list-item {
            background: rgba(58, 58, 58, 0.6);
            border: 1px solid rgba(74, 74, 74, 0.4);
            border-radius: 10px;
            padding: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .workflow-list-item:hover {
            background: rgba(74, 74, 74, 0.6);
            border-color: rgba(239, 68, 68, 0.4);
            transform: translateX(4px);
        }

        .workflow-list-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .workflow-list-item-name {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        .workflow-list-item-actions {
            display: flex;
            gap: 6px;
        }

        .workflow-action-icon {
            background: rgba(74, 74, 74, 0.6);
            border: none;
            border-radius: 6px;
            padding: 5px 8px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 11px;
        }

        .workflow-action-icon:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        .workflow-action-icon.delete:hover {
            background: rgba(220, 38, 38, 0.8);
        }

        .workflow-list-item-trigger {
            color: rgba(255, 255, 255, 0.7);
            font-size: 12px;
            margin-bottom: 3px;
        }

        .workflow-list-item-action {
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
        }

        .workflow-empty-state {
            text-align: center;
            padding: 30px 16px;
            color: rgba(255, 255, 255, 0.5);
        }

        .workflow-empty-state svg {
            width: 40px;
            height: 40px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        .workflow-empty-state p {
            font-size: 13px;
            margin: 0;
        }

        .workflow-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(239, 68, 68, 0.2);
        }

        .workflow-header h3 {
            color: #fff;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workflow-header h3 .icon {
            color: #ef4444;
        }

        .create-workflow-btn {
            background: #ef4444;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            color: white;
            font-weight: 500;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .create-workflow-btn:hover {
            transform: translateY(-2px);
        }

        .create-workflow-btn:active {
            transform: translateY(0);
        }

        .create-workflow-btn .icon {
            width: 16px;
            height: 16px;
        }

        /* Workflow Form - HIDDEN BY DEFAULT */
        .workflow-form {
            background-color: rgba(239, 68, 68, 0.08);
            border: 2px dashed rgba(239, 68, 68, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none !important;
            /* Force hidden by default */
            animation: slideDown 0.3s ease-out;
        }

        .workflow-form.visible {
            display: block !important;
            /* Override hidden default */
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
                max-height: 0;
            }

            to {
                opacity: 1;
                transform: translateY(0);
                max-height: 200px;
            }
        }

        .workflow-form-field {
            margin-bottom: 15px;
        }

        .workflow-form-field label {
            display: block;
            color: #fff;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .workflow-form-field input,
        .workflow-form-field textarea {
            width: 100%;
            background-color: rgba(44, 44, 44, 0.6);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            padding: 10px 12px;
            color: #fff;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s, box-shadow 0.3s;
            box-sizing: border-box;
        }

        .workflow-form-field input:focus,
        .workflow-form-field textarea:focus {
            border-color: #ef4444;
        }

        .workflow-form-field textarea {
            resize: vertical;
            min-height: 60px;
        }

        .workflow-form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .form-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .form-btn-primary {
            background-color: #ef4444;
            color: white;
        }

        .form-btn-primary:hover {
            background-color: #ef4444;
        }

        .form-btn-secondary {
            background-color: rgba(74, 74, 74, 0.9);
            color: #fff;
        }

        .form-btn-secondary:hover {
            background-color: rgba(90, 90, 90, 0.9);
        }

        /* Workflow List */
        .workflow-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .workflow-item {
            background: linear-gradient(135deg, rgba(58, 58, 58, 0.4), rgba(44, 44, 44, 0.6));
            padding: 16px 18px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(74, 74, 74, 0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .workflow-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #ef4444;
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .workflow-item:hover::before {
            transform: scaleY(1);
        }

        .workflow-item:hover {
            background: linear-gradient(135deg, rgba(74, 74, 74, 0.6), rgba(58, 58, 58, 0.8));
            border-color: rgba(239, 68, 68, 0.3);
            transform: translateX(4px);
            box-shadow: none;
        }

        .workflow-item-content {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .workflow-item-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.1));
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .workflow-item-icon .icon {
            width: 18px;
            height: 18px;
            color: #ef4444;
        }

        .workflow-item-details {
            flex: 1;
        }

        .workflow-item-title {
            color: #fff;
            font-weight: 500;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .workflow-item-subtitle {
            color: #a0a0a0;
            font-size: 12px;
            font-weight: 400;
        }

        .workflow-item-actions {
            display: flex;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .workflow-item:hover .workflow-item-actions {
            opacity: 1;
        }

        .workflow-action-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: none;
            background-color: rgba(74, 74, 74, 0.8);
            color: #a0a0a0;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .workflow-action-btn:hover {
            background-color: rgba(90, 90, 90, 0.9);
            color: #fff;
        }

        .workflow-action-btn.danger:hover {
            background-color: #ef4444;
            color: #fff;
        }

        .workflow-action-btn .icon {
            width: 16px;
            height: 16px;
        }

        .empty-workflows {
            text-align: center;
            padding: 40px 20px;
            color: #a0a0a0;
        }

        .empty-workflows .icon {
            width: 48px;
            height: 48px;
            color: rgba(239, 68, 68, 0.4);
            margin: 0 auto 15px;
        }

        .empty-workflows p {
            margin: 0;
            font-size: 16px;
            font-weight: 500;
        }

        .empty-workflows span {
            font-size: 14px;
            color: #808080;
        }

        /* Enhanced Workflows Window Styles - Legacy (keeping for compatibility) */
        .workflows-header {
            padding: 24px 28px;
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.08) 0%,
                    rgba(255, 255, 255, 0.03) 100%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.12);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .workflows-title h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            letter-spacing: 0.3px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .workflows-subtitle {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 2px;
            display: block;
        }

        .workflows-actions {
            display: flex;
            gap: 8px;
        }

        .workflows-btn {
            padding: 10px 18px;
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.8) 0%, rgba(30, 30, 30, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            letter-spacing: 0.2px;
        }

        .workflows-btn:hover {
            background: linear-gradient(135deg, rgba(50, 50, 50, 0.9) 0%, rgba(40, 40, 40, 0.8) 100%);
            transform: translateY(-2px) scale(1.03);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .workflows-btn .icon {
            width: 16px;
            height: 16px;
        }

        .quick-create-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .quick-create-header h4 {
            margin-top: 0;
            margin-bottom: 8px;
            color: #fff;
            font-size: 16px;
        }

        .quick-create-subtitle {
            font-size: 13px;
            color: #a0a0a0;
            display: block;
            margin-bottom: 15px;
        }

        .quick-create-input {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: rgba(58, 58, 58, 0.9);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 10px;
            padding: 10px 14px;
            margin-bottom: 15px;
        }

        .quick-create-input input {
            flex-grow: 1;
            background-color: transparent;
            border: none;
            color: #fff;
            font-size: 14px;
            outline: none;
        }

        .quick-create-input input::placeholder {
            color: #a0a0a0;
        }

        .create-prompt-btn {
            background-color: #ef4444;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .create-prompt-btn:hover {
            background-color: #ef4444;
        }

        .create-prompt-btn .icon {
            width: 16px;
            height: 16px;
            margin-right: 5px;
        }

        .quick-examples {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .example-tag {
            background-color: rgba(74, 74, 74, 0.9);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 6px;
            padding: 4px 10px;
            font-size: 12px;
            color: #a0a0a0;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .example-tag:hover {
            background-color: rgba(90, 90, 90, 0.9);
            border-color: rgba(90, 90, 90, 0.9);
        }

        .example-tag.active {
            background-color: #ef4444;
            border-color: #ef4444;
            color: #fff;
        }

        .workflows-list-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workflows-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .workflows-list-header h4 {
            margin: 0;
            color: #fff;
            font-size: 16px;
        }

        .workflow-count {
            font-size: 14px;
            color: #a0a0a0;
        }

        .workflows-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
            animation: workflowListFadeIn 0.6s ease-out;
        }

        .workflow-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.03) 100%);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            animation: workflowCardSlideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            box-shadow:
                0 4px 20px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .workflow-item:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            transform: translateY(-4px) scale(1.02);
            box-shadow:
                0 12px 32px rgba(0, 0, 0, 0.2),
                0 4px 16px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .workflow-item .workflow-name {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.2px;
        }

        .workflow-item .workflow-description {
            margin: 0 0 12px 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.75);
            line-height: 1.5;
            font-weight: 400;
        }

        .workflow-item .workflow-schedule {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            font-weight: 500;
        }

        .workflow-item .workflow-actions {
            display: flex;
            gap: 8px;
            opacity: 0.7;
            transition: opacity 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }

        .workflow-item:hover .workflow-actions {
            opacity: 1;
        }

        .workflow-item .workflow-actions button {
            padding: 8px 12px;
            background: linear-gradient(135deg, rgba(40, 40, 40, 0.8) 0%, rgba(30, 30, 30, 0.6) 100%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow:
                0 2px 8px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .workflow-item .workflow-actions button:hover {
            background: linear-gradient(135deg, rgba(50, 50, 50, 0.9) 0%, rgba(40, 40, 40, 0.8) 100%);
            transform: translateY(-1px) scale(1.05);
            box-shadow:
                0 4px 16px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .workflow-item .workflow-actions .edit-btn {
            width: 20px;
            height: 20px;
        }

        .workflow-item .workflow-actions .delete-btn {
            width: 20px;
            height: 20px;
        }

        .empty-workflows {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 40px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            background: linear-gradient(135deg,
                    rgba(255, 255, 255, 0.03) 0%,
                    rgba(255, 255, 255, 0.01) 100%);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            margin: 20px;
        }

        .empty-workflows .empty-icon {
            width: 48px;
            height: 48px;
            margin-bottom: 20px;
            opacity: 0.7;
            color: rgba(255, 255, 255, 0.7);
            animation: emptyIconFloat 3s ease-in-out infinite;
        }

        .empty-workflows .empty-text {
            text-align: center;
        }

        .empty-workflows .empty-text p {
            margin: 0 0 12px 0;
            font-size: 20px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            letter-spacing: 0.2px;
        }

        .empty-workflows .empty-text span {
            margin: 0 0 24px 0;
            font-size: 15px;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.65);
            max-width: 280px;
            display: block;
        }

        /* Workflow Creation Modal Styles */
        .workflow-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .workflow-modal-content {
            background-color: rgba(44, 44, 44, 0.95);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: none;
            overflow-y: auto;
        }

        .workflow-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workflow-modal-header h3 {
            margin: 0;
            color: #fff;
            font-size: 24px;
        }

        .workflow-modal-close {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            color: #a0a0a0;
            transition: color 0.3s;
        }

        .workflow-modal-close:hover {
            color: #fff;
        }

        .workflow-modal-close .icon {
            width: 20px;
            height: 20px;
        }

        .workflow-modal-body {
            flex-grow: 1;
            overflow-y: auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 14px;
            color: #a0a0a0;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            background-color: rgba(58, 58, 58, 0.9);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 10px;
            padding: 10px 14px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            border-color: #ef4444;
            /* Red accent */
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .schedule-options {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .schedule-type-selector select {
            background-color: rgba(58, 58, 58, 0.9);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 10px;
            padding: 10px 14px;
            color: #fff;
            font-size: 15px;
            outline: none;
            transition: border-color 0.3s;
        }

        .schedule-type-selector select:focus {
            border-color: #ef4444;
            /* Red accent */
        }

        .schedule-time-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .schedule-time-selector input {
            width: 80px;
        }

        .schedule-interval-selector {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .schedule-interval-selector input {
            width: 60px;
        }

        .schedule-interval-selector span {
            font-size: 14px;
            color: #a0a0a0;
        }

        .workflow-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(74, 74, 74, 0.9);
        }

        .workflow-step {
            background-color: rgba(58, 58, 58, 0.9);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 10px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .workflow-step .step-name {
            flex-grow: 1;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
        }

        .workflow-step .step-actions {
            display: flex;
            gap: 8px;
        }

        .workflow-step .step-actions button {
            background-color: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            color: #a0a0a0;
            transition: color 0.3s;
        }

        .workflow-step .step-actions button:hover {
            color: #fff;
        }

        .workflow-step .step-actions .edit-step-btn {
            width: 20px;
            height: 20px;
        }

        .workflow-step .step-actions .delete-step-btn {
            width: 20px;
            height: 20px;
        }

        .add-step-btn {
            background-color: rgba(74, 74, 74, 0.9);
            border: 1px solid rgba(74, 74, 74, 0.9);
            border-radius: 10px;
            padding: 10px 14px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .add-step-btn:hover {
            background-color: rgba(90, 90, 90, 0.9);
            border-color: rgba(90, 90, 90, 0.9);
        }

        .add-step-btn .icon {
            width: 16px;
            height: 16px;
        }

        .workflow-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .workflow-btn-secondary,
        .workflow-btn-primary {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .workflow-btn-secondary {
            background-color: transparent;
            border: 1px solid rgba(74, 74, 74, 0.9);
            color: #a0a0a0;
        }

        .workflow-btn-secondary:hover {
            background-color: rgba(74, 74, 74, 0.9);
            border-color: rgba(90, 90, 90, 0.9);
        }

        .workflow-btn-primary {
            background-color: #ef4444;
            border: none;
            color: #fff;
        }

        .workflow-btn-primary:hover {
            background-color: #ef4444;
        }

        /* Status Indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            position: relative;
            box-shadow: none;
        }

        .status-indicator.active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            box-shadow:
                0 0 12px rgba(34, 197, 94, 0.4),
                0 0 4px rgba(34, 197, 94, 0.6);
            animation: statusPulse 2s infinite;
        }

        .status-indicator.inactive {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow:
                0 0 8px rgba(107, 114, 128, 0.3),
                0 0 4px rgba(107, 114, 128, 0.5);
        }

        /* Animations */
        @keyframes statusPulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        @keyframes emptyIconFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-8px);
            }
        }

        @keyframes workflowListFadeIn {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes workflowCardSlideIn {
            0% {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }

            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Settings Styles */
        .settings-container {
            display: flex;
            height: 100%;
            min-height: 500px;
            max-height: 700px;
        }

        .settings-sidebar {
            width: 240px;
            background: linear-gradient(135deg,
                    rgba(30, 30, 30, var(--window-bg-opacity)),
                    rgba(20, 20, 20, calc(var(--window-bg-opacity) - 0.05)));
            border-right: 1px solid rgba(239, 68, 68, 0.2);
            padding: 24px 0;
            overflow-y: auto;
            scrollbar-width: none;
        }

        .settings-sidebar::-webkit-scrollbar {
            display: none;
        }

        .settings-sidebar-header {
            padding: 0 24px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 16px;
        }

        .settings-sidebar-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            color: #fff;
        }

        .settings-nav {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            color: rgba(255, 255, 255, 0.7);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .settings-nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.9);
        }

        .settings-nav-item.active {
            background: rgba(239, 68, 68, 0.15);
            color: #fff;
            border-left-color: #ef4444;
        }

        .settings-nav-item svg {
            flex-shrink: 0;
        }

        .settings-nav-item span {
            font-size: 14px;
            font-weight: 500;
        }

        .settings-content {
            flex: 1;
            padding: 32px;
            overflow-y: auto;
            max-height: 700px;
            scrollbar-width: none;
        }

        .settings-content::-webkit-scrollbar {
            display: none;
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel-title {
            margin: 0 0 24px 0;
            font-size: 24px;
            font-weight: 600;
            color: #fff;
        }

        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section-title {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .settings-group {
            margin-bottom: 20px;
        }

        .settings-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 8px;
        }

        .settings-description {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
            margin-top: 4px;
        }

        .settings-select,
        .settings-input {
            width: 100%;
            padding: 10px 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.2s;
        }

        .settings-select:hover,
        .settings-input:hover {
            border-color: rgba(239, 68, 68, 0.3);
            background: rgba(255, 255, 255, 0.08);
        }

        .settings-select:focus,
        .settings-input:focus {
            outline: none;
            border-color: #ef4444;
            background: rgba(255, 255, 255, 0.08);
        }

        .settings-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .settings-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ef4444;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-slider::-webkit-slider-thumb:hover {
            background: #ef4444;
            transform: scale(1.1);
        }

        .settings-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #ef4444;
            cursor: pointer;
            border: none;
        }

        .settings-toggle-group {
            margin-bottom: 16px;
        }

        .settings-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            position: relative;
        }

        .settings-toggle input[type="checkbox"] {
            display: none;
        }

        .settings-toggle-slider {
            width: 44px;
            height: 24px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            position: relative;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .settings-toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #fff;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .settings-toggle input[type="checkbox"]:checked+.settings-toggle-slider {
            background: #ef4444;
        }

        .settings-toggle input[type="checkbox"]:checked+.settings-toggle-slider::before {
            transform: translateX(20px);
        }

        .settings-toggle-label {
            flex: 1;
        }

        .settings-toggle-label {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        .settings-toggle-description {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 400;
            margin-top: 2px;
        }

        .settings-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .settings-btn {
            padding: 10px 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .settings-btn.primary {
            background: #ef4444;
            border-color: #ef4444;
        }

        .settings-btn.primary:hover {
            background: #ef4444;
            border-color: #ef4444;
        }

        .settings-btn.danger {
            background: rgba(220, 38, 38, 0.2);
            border-color: #ef4444;
            color: #fca5a5;
        }

        .settings-btn.danger:hover {
            background: #ef4444;
            color: #fff;
        }

        .shortcut-input {
            background: rgba(255, 255, 255, 0.05) !important;
            cursor: default;
        }

        .integration-config {
            margin-top: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .integration-status {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.7);
            font-size: 13px;
        }

        .data-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }

        .data-stat-item {
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .data-stat-label {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 8px;
        }

        .data-stat-value {
            font-size: 18px;
            font-weight: 600;
            color: #fff;
        }

        .clear-data-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 16px 0;
        }

        .clear-data-option {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            color: rgba(255, 255, 255, 0.8);
        }

        .clear-data-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }


        /* Account Settings Styles - Compact Layout */
        .account-settings-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            border-radius: 12px;
        }

        .account-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .account-header-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .account-avatar {
            width: 44px;
            height: 44px;
            background: #ef4444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-shrink: 0;
        }

        .account-header-info h2 {
            margin: 0 0 2px 0;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }

        .account-header-info p {
            margin: 0;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
        }

        .account-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 14px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 11px;
            font-weight: 500;
            flex-shrink: 0;
        }

        .status-indicator {
            width: 6px;
            height: 6px;
            background: #6b7280;
            border-radius: 50%;
        }

        .account-settings-content {
            flex: 1;
            padding: 16px 20px 24px 20px;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
        }

        .account-settings-content::-webkit-scrollbar {
            width: 6px;
        }

        .account-settings-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .account-settings-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .account-section {
            margin-bottom: 16px;
            flex-shrink: 0;
        }

        .account-section:last-child {
            margin-bottom: 16px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .account-section-title {
            margin: 0 0 10px 0;
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .account-section-title::before {
            display: none;
        }

        .subscription-card {
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px 14px;
        }

        .subscription-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .subscription-tier {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
        }

        .subscription-status {
            padding: 3px 8px;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 8px;
            color: #4ade80;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            border: none;
        }

        .subscription-details {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .subscription-detail {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .detail-label {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
        }

        .detail-value {
            font-size: 13px;
            font-weight: 600;
            color: #fff;
        }

        .refresh-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            margin-top: 12px;
            padding: 8px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refresh-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
        }

        .refresh-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .refresh-btn .spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }

        .sign-out-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 8px;
            color: #ef4444;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sign-out-btn:hover {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.5);
        }

        .account-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .account-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }

        .account-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.15);
        }

        .account-btn.danger {
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        .account-btn.danger:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        /* Custom Confirm Modal */
        .custom-confirm-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .custom-confirm-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .custom-confirm-dialog {
            background: rgba(30, 30, 30, 0.95);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            width: 90%;
            max-width: 380px;
            overflow: hidden;
            box-shadow: none;
            transform: scale(0.95) translateY(-10px);
            transition: transform 0.2s ease;
        }

        .custom-confirm-overlay.visible .custom-confirm-dialog {
            transform: scale(1) translateY(0);
        }

        .custom-confirm-header {
            padding: 20px 20px 0 20px;
            text-align: center;
        }

        .custom-confirm-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .custom-confirm-icon.warning {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
        }

        .custom-confirm-icon.danger {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        .custom-confirm-icon.info {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .custom-confirm-icon svg {
            width: 24px;
            height: 24px;
        }

        .custom-confirm-title {
            margin: 0 0 8px 0;
            font-size: 17px;
            font-weight: 600;
            color: #ffffff;
        }

        .custom-confirm-message {
            margin: 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
            padding: 0 20px 20px;
            text-align: center;
        }

        .custom-confirm-actions {
            display: flex;
            border-top: 1px solid rgba(255, 255, 255, 0.08);
        }

        .custom-confirm-btn {
            flex: 1;
            padding: 14px 20px;
            background: transparent;
            border: none;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.15s ease;
        }

        .custom-confirm-btn:first-child {
            border-right: 1px solid rgba(255, 255, 255, 0.08);
        }

        .custom-confirm-btn.cancel {
            color: rgba(255, 255, 255, 0.7);
        }

        .custom-confirm-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .custom-confirm-btn.confirm {
            color: #ef4444;
        }

        .custom-confirm-btn.confirm:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .custom-confirm-btn.confirm.primary {
            color: #3b82f6;
        }

        .custom-confirm-btn.confirm.primary:hover {
            background: rgba(59, 130, 246, 0.1);
        }
    </style>
</head>

<body>
    <!-- Liquid Glass SVG Filter -->
    <svg class="liquid-glass-filter">
        <defs>
            <filter id="liquid-distortion">
                <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" result="noise" seed="1" />
                <feDisplacementMap in="SourceGraphic" in2="noise" scale="3" xChannelSelector="R" yChannelSelector="G" />
            </filter>
        </defs>
    </svg>

    <div class="assistant-container">
        <div class="window-container"></div>
    </div>

    <script src="component-loader.js"></script>
    <script src="components-config.js"></script>

    <script>
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
        console.log('ðŸ“± RED GLASS APP - MAIN SCRIPT LOADING');
        console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

        // âš¡ DEFINE LOGIN FUNCTION IMMEDIATELY (before components load)
        window.handleSettingsLogin = async function () {
            console.log('ðŸ” ===== LOGIN STARTED =====');

            const email = document.getElementById('settings-login-email');
            const password = document.getElementById('settings-login-password');
            const errorDiv = document.getElementById('settings-login-error');
            const loginBtn = document.getElementById('settings-login-btn');

            if (!email || !password) {
                console.error('âŒ Form elements not found');
                return;
            }

            const emailValue = email.value.trim();
            const passwordValue = password.value;

            if (!emailValue || !passwordValue) {
                errorDiv.textContent = 'Please enter both email and password';
                errorDiv.style.display = 'block';
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Signing in...';
            errorDiv.style.display = 'none';

            try {
                console.log('ðŸ” Authenticating:', emailValue);
                const result = await window.electronAPI.mongodbAuthenticate(emailValue, passwordValue);

                if (result.success) {
                    console.log('âœ… Login successful!');
                    loginBtn.textContent = 'âœ“ Success!';

                    // Hide login form, show account sections
                    setTimeout(() => {
                        const loginForm = document.getElementById('settings-login-form');
                        const accountSections = document.querySelectorAll('.account-section');

                        if (loginForm) loginForm.style.display = 'none';
                        accountSections.forEach(section => section.style.display = 'block');

                        // Update header
                        const accountName = document.getElementById('account-name');
                        const accountEmail = document.getElementById('account-email');
                        if (accountName) accountName.textContent = result.user.fullName || result.user.name || emailValue;
                        if (accountEmail) accountEmail.textContent = emailValue;

                        // Reload account data
                        if (window.loadAccountData) {
                            window.loadAccountData();
                        }
                    }, 500);
                } else {
                    console.error('âŒ Login failed:', result.error);
                    errorDiv.textContent = result.error || 'Invalid email or password';
                    errorDiv.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            } catch (error) {
                console.error('âŒ Login error:', error);
                errorDiv.textContent = 'Connection error. Please try again.';
                errorDiv.style.display = 'block';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Sign In';
            }
        };
        console.log('âœ… handleSettingsLogin function defined globally');

        (async function initializeApp() {
            console.log('ðŸš€ Initialising RED AI App...');

            try {
                for (const { name, config } of COMPONENTS_CONFIG) {
                    console.log(`ðŸ“¦ Loading component: ${name}`);
                    await ComponentLoader.loadComponent(name, config);
                }

                console.log('âœ… All core components loaded');

                await ComponentLoader.loadComponent('mcp-settings', {
                    js: 'load-mcp.js'
                });

                await ComponentLoader.loadComponent('workflow-builder', {
                    js: 'load-workflow-builder.js'
                });

                console.log('âœ… App initialization complete');
                console.log('ðŸ”§ About to call initializeNavigationUI...');

                // Initialize navigation after components are loaded
                // Use setTimeout to ensure DOM has finished parsing the inserted HTML
                setTimeout(() => {
                    if (window.initializeNavigationUI) {
                        console.log('âœ… initializeNavigationUI exists, calling it...');
                        window.initializeNavigationUI();
                    } else {
                        console.error('âŒ initializeNavigationUI NOT FOUND!');
                    }
                }, 100);

            } catch (error) {
                console.error('âŒ Failed to initialize app:', error);
            }
        })();
    </script>

    <script>
        let assistantContainer, navigationPill, listItems, windows;

        console.log('ðŸ“ Defining initializeNavigationUI function...');

        window.initializeNavigationUI = function () {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸŽ¯ INITIALIZE NAVIGATION UI CALLED');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            assistantContainer = document.querySelector('.assistant-container');
            navigationPill = document.querySelector('.navigation');
            listItems = document.querySelectorAll('.nav-item');
            windows = document.querySelectorAll('.window');
            const conversationView = document.querySelector('.conversation-view');
            const chatInput = document.getElementById('chat-input');
            const sendBtn = document.getElementById('send-btn');
            const menuBtn = document.getElementById('menu-btn');
            const captureBtn = document.getElementById('capture-btn');
            const chatDropdown = document.getElementById('chat-dropdown');
            const newChatItem = document.getElementById('new-chat-item');
            const historyToggleItem = document.getElementById('history-toggle-item');
            const chatHistoryList = document.getElementById('chat-history-list');

            console.log('ðŸ” Button element detection:', {
                conversationView: !!conversationView,
                chatInput: !!chatInput,
                sendBtn: !!sendBtn,
                menuBtn: !!menuBtn,
                captureBtn: !!captureBtn,
                chatDropdown: !!chatDropdown,
                newChatItem: !!newChatItem,
                historyToggleItem: !!historyToggleItem,
                chatHistoryList: !!chatHistoryList
            });

            // Chat history storage
            let chatHistory = JSON.parse(localStorage.getItem('redGlassChatHistory') || '[]');
            let currentChatId = `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            let screenCaptureActive = false;
            let autoSaveTimeout = null;

            // Transcription attachment state
            let transcriptionAttachment = null;

            // Handle transcription attachment from transcription window
            window.addEventListener('transcription-attached', (event) => {
                console.log('ðŸ“Ž Transcription attached event received:', event.detail);
                transcriptionAttachment = event.detail;
                showTranscriptionAttachmentBadge();
            });

            // Show transcription attachment card
            function showTranscriptionAttachmentBadge() {
                const card = document.getElementById('transcription-attachment-card');
                const titleEl = document.getElementById('attachment-card-title');
                const wordsEl = document.getElementById('attachment-card-words');
                const attachmentsArea = document.getElementById('attachments-area');
                const inlineIndicator = document.getElementById('inline-attachment-indicator');

                if (card && transcriptionAttachment) {
                    // Show the attachments area
                    if (attachmentsArea) attachmentsArea.classList.remove('hidden');
                    card.classList.remove('hidden');
                    
                    // Show inline indicator in input
                    if (inlineIndicator) inlineIndicator.classList.remove('hidden');
                    
                    // Set title - use first line or preview of the transcription
                    if (titleEl) {
                        const title = transcriptionAttachment.title || 
                            (transcriptionAttachment.text ? 
                                transcriptionAttachment.text.split('\n')[0].substring(0, 50) + 
                                (transcriptionAttachment.text.length > 50 ? '...' : '') :
                                'Meeting Transcription');
                        titleEl.textContent = title;
                    }
                    
                    if (wordsEl) {
                        wordsEl.textContent = `${transcriptionAttachment.wordCount || 0} words`;
                    }
                    console.log('âœ… Transcription attachment card shown');
                }
            }

            // Hide transcription attachment card
            function hideTranscriptionAttachmentBadge() {
                const card = document.getElementById('transcription-attachment-card');
                const attachmentsArea = document.getElementById('attachments-area');
                const inlineIndicator = document.getElementById('inline-attachment-indicator');
                
                if (card) {
                    card.classList.add('hidden');
                }
                
                // Hide inline indicator
                if (inlineIndicator) inlineIndicator.classList.add('hidden');
                
                // Check if we should hide the attachments area (if no other attachments)
                const screenCaptureCard = document.getElementById('screen-capture-card');
                const hasScreenCapture = screenCaptureCard && !screenCaptureCard.classList.contains('hidden');
                
                if (attachmentsArea && !hasScreenCapture) {
                    attachmentsArea.classList.add('hidden');
                }
                
                transcriptionAttachment = null;
                window.chatAttachment = null;
                console.log('âŒ Transcription attachment removed');
            }

            // Setup transcription attachment card click handlers
            function setupTranscriptionAttachmentHandlers() {
                const removeBtn = document.getElementById('remove-attachment-btn');
                if (removeBtn) {
                    removeBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        hideTranscriptionAttachmentBadge();
                    });
                }

                const card = document.getElementById('transcription-attachment-card');
                if (card) {
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.attachment-remove')) return;
                        // Show transcription preview on click
                        if (transcriptionAttachment) {
                            showTranscriptionPreviewModal();
                        }
                    });
                }
            }

            // Show transcription preview modal
            function showTranscriptionPreviewModal() {
                if (!transcriptionAttachment) return;

                // Create modal if not exists
                let modal = document.getElementById('transcription-preview-modal');
                if (!modal) {
                    modal = document.createElement('div');
                    modal.id = 'transcription-preview-modal';
                    modal.className = 'transcription-preview-modal';
                    modal.innerHTML = `
                    <div class="transcription-modal-content">
                        <div class="modal-header">
                            <h3>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/>
                                </svg>
                                Transcription
                            </h3>
                            <button class="close-modal-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="transcription-text-preview"></div>
                        </div>
                        <div class="modal-footer">
                            <span class="word-count-info"></span>
                            <button class="remove-transcription-btn">Remove</button>
                        </div>
                    </div>
                `;
                    document.body.appendChild(modal);

                    // Add event listeners
                    modal.querySelector('.close-modal-btn').addEventListener('click', () => {
                        modal.classList.remove('visible');
                    });
                    modal.querySelector('.remove-transcription-btn').addEventListener('click', () => {
                        hideTranscriptionAttachmentBadge();
                        modal.classList.remove('visible');
                    });
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) modal.classList.remove('visible');
                    });
                }

                // Populate content
                modal.querySelector('.transcription-text-preview').textContent = transcriptionAttachment.content;
                modal.querySelector('.word-count-info').textContent = `${transcriptionAttachment.wordCount} words`;
                modal.classList.add('visible');
            }

            // Initialize transcription attachment handlers when DOM is ready
            setTimeout(setupTranscriptionAttachmentHandlers, 500);


            // Workflow variables
            let workflows = JSON.parse(localStorage.getItem('redGlassWorkflows') || '[]');

            // Function to apply window opacity via CSS variable
            function applyWindowOpacity(opacityValue) {
                document.documentElement.style.setProperty('--window-bg-opacity', opacityValue);
                console.log('Applied window background opacity:', opacityValue);
            }

            // Function to apply background transparency
            function applyBackgroundTransparency(transparencyValue) {
                document.documentElement.style.setProperty('--app-bg-transparency', transparencyValue);

                // Always maintain translucency and blur for light frosted glass effect
                const currentBlur = document.documentElement.style.getPropertyValue('--app-blur-amount') || '20';

                // Calculate alpha based on transparency (0.65 to 0.85 range for frosted glass)
                const alpha = Math.max(0.65, Math.min(0.85, 0.65 + (0.2 * transparencyValue)));

                document.documentElement.style.setProperty('--app-bg-color', `rgba(180, 180, 180, ${alpha})`);
                document.documentElement.style.setProperty('--app-backdrop-filter', `blur(${currentBlur}px) saturate(180%)`);

                console.log('Applied background transparency:', transparencyValue, 'alpha:', alpha);
            }

            // Function to apply background blur
            function applyBackgroundBlur(blurValue) {
                document.documentElement.style.setProperty('--app-blur-amount', blurValue);

                // Always apply blur for light frosted glass effect
                const filterValue = `blur(${blurValue}px) saturate(180%)`;
                document.documentElement.style.setProperty('--app-backdrop-filter', filterValue);

                // Update background color to maintain translucency
                const currentTransparency = parseFloat(document.documentElement.style.getPropertyValue('--app-bg-transparency')) || 1.0;
                const alpha = Math.max(0.65, Math.min(0.85, 0.65 + (0.2 * currentTransparency)));
                document.documentElement.style.setProperty('--app-bg-color', `rgba(180, 180, 180, ${alpha})`);

                console.log('Applied background blur:', blurValue, 'alpha:', alpha);
            }

            // Load and apply initial opacity setting
            async function loadInitialOpacity() {
                try {
                    const result = await window.electronAPI.invoke('settings-get-setting', {
                        category: 'general',
                        key: 'windowOpacity'
                    });
                    if (result.success && result.value !== undefined && result.value !== null) {
                        applyWindowOpacity(result.value);
                    }
                } catch (error) {
                    console.error('Failed to load opacity setting:', error);
                }
            }

            // Load and apply initial transparency setting
            async function loadInitialTransparency() {
                try {
                    const result = await window.electronAPI.invoke('settings-get-setting', {
                        category: 'general',
                        key: 'backgroundTransparency'
                    });
                    if (result.success && result.value !== undefined && result.value !== null) {
                        applyBackgroundTransparency(result.value);
                    } else {
                        // Default to full transparency
                        applyBackgroundTransparency(1.0);
                    }
                } catch (error) {
                    console.error('Failed to load transparency setting:', error);
                    // Default to full transparency
                    applyBackgroundTransparency(1.0);
                }
            }

            // Load and apply initial blur setting
            async function loadInitialBlur() {
                try {
                    const result = await window.electronAPI.invoke('settings-get-setting', {
                        category: 'general',
                        key: 'backgroundBlur'
                    });
                    if (result.success && result.value !== undefined && result.value !== null) {
                        applyBackgroundBlur(result.value);
                    } else {
                        // Default to 60px blur for frosted glass
                        applyBackgroundBlur(60);
                    }
                } catch (error) {
                    console.error('Failed to load blur setting:', error);
                    // Default to 60px blur for frosted glass
                    applyBackgroundBlur(60);
                }
            }

            // Listen for opacity changes from main process
            if (window.ipcRenderer) {
                window.ipcRenderer.on('opacity-changed', (event, newOpacity) => {
                    applyWindowOpacity(newOpacity);
                });

                // Listen for notification events from main process
                window.ipcRenderer.on('show-notification', (event, data) => {
                    console.log('ðŸ“© Received notification IPC:', data);
                    addNotificationToChat(data.title, data.message, data.type);
                });
                console.log('âœ… Notification IPC listener registered');
            }

            // ================================
            // NOTIFICATION STICKER SYSTEM
            // ================================
            function addNotificationToChat(title, message, type = 'info') {
                const chatMessages = document.querySelector('.conversation-view');
                if (!chatMessages) {
                    console.error('Chat messages container (.conversation-view) not found');
                    return;
                }

                // Get icon and colors based on type
                const typeConfig = {
                    success: { icon: 'âœ“', color: '#4ade80', bg: 'rgba(34, 197, 94, 0.15)', border: 'rgba(34, 197, 94, 0.3)' },
                    error: { icon: 'âœ•', color: '#f87171', bg: 'rgba(239, 68, 68, 0.15)', border: 'rgba(239, 68, 68, 0.3)' },
                    info: { icon: 'â„¹', color: '#60a5fa', bg: 'rgba(59, 130, 246, 0.15)', border: 'rgba(59, 130, 246, 0.3)' },
                    workflow: { icon: 'âš¡', color: '#c084fc', bg: 'rgba(147, 51, 234, 0.15)', border: 'rgba(147, 51, 234, 0.3)' }
                };

                const config = typeConfig[type] || typeConfig.info;

                // Create notification sticker element
                const sticker = document.createElement('div');
                sticker.className = 'notification-sticker';
                sticker.style.cssText = `
                display: flex;
                align-items: flex-start;
                gap: 12px;
                padding: 14px 16px;
                margin: 12px 0;
                background: ${config.bg};
                border: 1px solid ${config.border};
                border-radius: 12px;
                animation: stickerSlideIn 0.3s ease-out;
                position: relative;
            `;

                sticker.innerHTML = `
                <div style="
                    width: 36px;
                    height: 36px;
                    border-radius: 10px;
                    background: ${config.bg};
                    border: 1px solid ${config.border};
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    color: ${config.color};
                    flex-shrink: 0;
                ">${config.icon}</div>
                <div style="flex: 1; min-width: 0;">
                    <div style="
                        font-weight: 600;
                        font-size: 14px;
                        color: ${config.color};
                        margin-bottom: 4px;
                    ">${escapeHtml(title)}</div>
                    ${message ? `<div style="
                        font-size: 13px;
                        color: rgba(255, 255, 255, 0.7);
                        line-height: 1.4;
                    ">${escapeHtml(message)}</div>` : ''}
                </div>
                <button onclick="dismissNotification(this)" style="
                    width: 28px;
                    height: 28px;
                    border: none;
                    background: rgba(255, 255, 255, 0.1);
                    border-radius: 8px;
                    color: rgba(255, 255, 255, 0.6);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 14px;
                    transition: all 0.2s ease;
                    flex-shrink: 0;
                " onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.color='#fff';"
                   onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.color='rgba(255,255,255,0.6)';">âœ•</button>
            `;

                chatMessages.appendChild(sticker);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                console.log(`ðŸ”” Notification sticker added: ${title}`);
            }

            // Dismiss notification with animation
            function dismissNotification(button) {
                const sticker = button.closest('.notification-sticker');
                if (sticker) {
                    sticker.style.animation = 'stickerSlideOut 0.25s ease-in forwards';
                    setTimeout(() => sticker.remove(), 250);
                }
            }

            // Helper to escape HTML
            function escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Make functions globally accessible
            window.dismissNotification = dismissNotification;
            window.addNotificationToChat = addNotificationToChat;

            // ================================
            // CHAT-BASED WORKFLOW CREATION
            // ================================

            // Patterns that indicate user wants to create a workflow
            const workflowCreationPatterns = [
                /create\s+(a\s+)?workflow/i,
                /make\s+(a\s+)?workflow/i,
                /set\s+up\s+(a\s+)?workflow/i,
                /build\s+(a\s+)?workflow/i,
                /new\s+workflow/i,
                /automate\s+(.+)/i,
                /when\s+I\s+say\s+["']?(.+?)["']?\s*(,\s*)?(then\s+)?(.+)/i,
                /every\s+(day|morning|evening|night|hour|monday|tuesday|wednesday|thursday|friday|saturday|sunday)/i,
                /remind\s+me\s+to/i,
                /schedule\s+(a\s+)?(.+)/i
            ];

            // Check if message is a workflow creation request
            function isWorkflowCreationRequest(message) {
                return workflowCreationPatterns.some(pattern => pattern.test(message));
            }

            // Handle workflow creation from chat
            async function handleWorkflowCreation(message) {
                if (!isWorkflowCreationRequest(message)) {
                    return false;
                }

                console.log('ðŸ”§ Detected workflow creation request:', message);

                // Show generating indicator
                const generatingEl = showWorkflowGenerating();

                try {
                    // Call AI to generate workflow
                    const result = await window.electronAPI.generateWorkflowFromText(message);

                    // Remove generating indicator
                    if (generatingEl) generatingEl.remove();

                    if (result.valid && result.workflow) {
                        // Show preview card
                        showWorkflowPreviewCard(result.workflow, result.usageHint);
                        return true;
                    } else {
                        // Generation failed
                        addNotificationToChat(
                            'âŒ Could not create workflow',
                            result.errors?.join(', ') || 'Please try describing it differently',
                            'error'
                        );
                        return true; // Still handled
                    }
                } catch (error) {
                    console.error('Workflow generation error:', error);
                    if (generatingEl) generatingEl.remove();
                    addNotificationToChat(
                        'âŒ Error creating workflow',
                        error.message,
                        'error'
                    );
                    return true;
                }
            }

            // Show "generating workflow" indicator
            function showWorkflowGenerating() {
                const conversationView = document.querySelector('.conversation-view');
                if (!conversationView) return null;

                const el = document.createElement('div');
                el.className = 'workflow-generating';
                el.innerHTML = `
                <div class="spinner"></div>
                <span>ðŸ”§ Creating your workflow...</span>
            `;

                conversationView.appendChild(el);
                conversationView.scrollTop = conversationView.scrollHeight;

                return el;
            }

            // Show workflow preview card
            function showWorkflowPreviewCard(workflow, usageHint) {
                const conversationView = document.querySelector('.conversation-view');
                if (!conversationView) return;

                const card = document.createElement('div');
                card.className = 'workflow-preview-card';
                card.id = 'workflow-preview-card';

                // Format trigger for display
                let triggerText = 'Manual (click to run)';
                if (workflow.trigger.type === 'keyword') {
                    triggerText = `Keyword: "${workflow.trigger.keywords.join('", "')}"`;
                } else if (workflow.trigger.type === 'schedule') {
                    const sched = workflow.trigger.schedule;
                    triggerText = `Schedule: ${sched.frequency} at ${sched.time}`;
                }

                // Format actions for display
                const actionsHtml = workflow.actions.map((action, i) => {
                    let actionText = '';
                    if (action.type === 'ai_prompt') {
                        const promptPreview = action.prompt.length > 40
                            ? action.prompt.substring(0, 40) + '...'
                            : action.prompt;
                        actionText = `AI: ${promptPreview}`;
                    } else if (action.type === 'notification') {
                        actionText = `Notify: "${action.title}"`;
                    } else if (action.type === 'clipboard') {
                        actionText = `Clipboard: ${action.operation}`;
                    } else if (action.type === 'http_request') {
                        actionText = `HTTP: ${action.method} ${action.url}`;
                    } else {
                        actionText = action.type;
                    }
                    return `<div>â€¢ ${actionText}</div>`;
                }).join('');

                card.innerHTML = `
                <div class="preview-header">
                    <span class="preview-icon">ðŸ”§</span>
                    <span class="preview-title">New Workflow</span>
                </div>
                <div class="preview-name">${escapeHtml(workflow.name)}</div>
                <div class="preview-description">${escapeHtml(workflow.description || '')}</div>
                <div class="preview-details">
                    <div class="preview-trigger">
                        <strong>Trigger:</strong> ${escapeHtml(triggerText)}
                    </div>
                    <div class="preview-actions">
                        <strong>Actions:</strong>
                        ${actionsHtml}
                    </div>
                </div>
                <div class="preview-buttons">
                    <button class="btn-create-workflow" onclick="confirmCreateWorkflow()">
                        âœ“ Create Workflow
                    </button>
                    <button class="btn-cancel-workflow" onclick="cancelWorkflowPreview()">
                        âœ• Cancel
                    </button>
                </div>
            `;

                // Store workflow for confirmation
                window.pendingGeneratedWorkflow = workflow;
                window.pendingWorkflowUsageHint = usageHint;

                conversationView.appendChild(card);
                conversationView.scrollTop = conversationView.scrollHeight;
            }

            // Confirm and create the workflow
            async function confirmCreateWorkflow() {
                const workflow = window.pendingGeneratedWorkflow;
                const usageHint = window.pendingWorkflowUsageHint;

                if (!workflow) {
                    console.error('No pending workflow to create');
                    return;
                }

                // Remove preview card
                const card = document.getElementById('workflow-preview-card');
                if (card) card.remove();

                try {
                    // Create the workflow
                    const result = await window.electronAPI.createGeneratedWorkflow(workflow);

                    if (result.success) {
                        addNotificationToChat(
                            `âœ… Workflow "${workflow.name}" Created!`,
                            usageHint || 'Your workflow is ready to use',
                            'success'
                        );
                    } else {
                        addNotificationToChat(
                            'âŒ Failed to create workflow',
                            result.error || 'Please try again',
                            'error'
                        );
                    }
                } catch (error) {
                    console.error('Error creating workflow:', error);
                    addNotificationToChat(
                        'âŒ Error creating workflow',
                        error.message,
                        'error'
                    );
                }

                // Clear pending
                window.pendingGeneratedWorkflow = null;
                window.pendingWorkflowUsageHint = null;
            }

            // Cancel workflow preview
            function cancelWorkflowPreview() {
                const card = document.getElementById('workflow-preview-card');
                if (card) {
                    card.style.animation = 'stickerSlideOut 0.25s ease-in forwards';
                    setTimeout(() => card.remove(), 250);
                }

                window.pendingGeneratedWorkflow = null;
                window.pendingWorkflowUsageHint = null;

                addMessage('No problem! Let me know if you need anything else.', 'ai', true);
            }

            // Make workflow functions globally accessible
            window.handleWorkflowCreation = handleWorkflowCreation;
            window.confirmCreateWorkflow = confirmCreateWorkflow;
            window.cancelWorkflowPreview = cancelWorkflowPreview;

            // Apply opacity, transparency, and blur on page load
            // loadInitialOpacity();
            // loadInitialTransparency();
            // loadInitialBlur();

            // Initialize CSS variables with defaults if not set
            // if (!document.documentElement.style.getPropertyValue('--app-blur-amount')) {
            //     document.documentElement.style.setProperty('--app-blur-amount', '60');
            //     console.log('Initialized --app-blur-amount to 60');
            // }
            // if (!document.documentElement.style.getPropertyValue('--app-bg-transparency')) {
            //     document.documentElement.style.setProperty('--app-bg-transparency', '1');
            //     console.log('Initialized --app-bg-transparency to 1');
            // }

            // Force initial backdrop filter setting with light frosted glass effect
            // const initialBlur = document.documentElement.style.getPropertyValue('--app-blur-amount') || '20';
            // const initialTransparency = document.documentElement.style.getPropertyValue('--app-bg-transparency') || '1';
            // const initialFilter = `blur(${initialBlur}px) saturate(180%)`;

            // Set light frosted background color
            // const alpha = Math.max(0.65, Math.min(0.85, 0.65 + (0.2 * parseFloat(initialTransparency))));
            // document.documentElement.style.setProperty('--app-bg-color', `rgba(180, 180, 180, ${alpha})`);
            // document.documentElement.style.setProperty('--app-backdrop-filter', initialFilter);

            // console.log('Force set initial values - backdrop-filter:', initialFilter, 'bg-color alpha:', alpha);

            // Add a global function for testing blur changes
            window.testBlur = function (value) {
                console.log('Testing blur with value:', value);
                applyBackgroundBlur(value);
                console.log('Current CSS variables:');
                console.log('--app-blur-amount:', document.documentElement.style.getPropertyValue('--app-blur-amount'));
                console.log('--app-backdrop-filter:', document.documentElement.style.getPropertyValue('--app-backdrop-filter'));
                console.log('--app-bg-transparency:', document.documentElement.style.getPropertyValue('--app-bg-transparency'));
            };

            function setActive(e) {
                e.preventDefault();
                const clickedItem = e.currentTarget;
                const isAlreadyActive = clickedItem.classList.contains('active');
                const allNavItems = document.querySelectorAll('.nav-item');
                const allWindows = document.querySelectorAll('.window');

                // If clicking on already active item, COLLAPSE it (toggle off)
                if (isAlreadyActive) {
                    // Hide the current window
                    const targetId = clickedItem.dataset.target;
                    const targetWindow = document.getElementById(targetId);
                    if (targetWindow) {
                        targetWindow.classList.remove('visible');
                        targetWindow.style.display = 'none';
                    }

                    // Remove active state from the clicked item
                    clickedItem.classList.remove('active');
                    const inactiveWidth = clickedItem.dataset.itemWidthInactive || '70px';
                    clickedItem.style.width = inactiveWidth;

                    console.log('ðŸ“¦ Collapsed window:', targetId);
                    return;
                }

                // Hide ALL windows including dynamically loaded ones (MCP, Workflows, etc.)
                allWindows.forEach(win => {
                    win.classList.remove('visible');
                    win.style.display = 'none';
                });

                // Update nav items: remove active from all, add to clicked
                allNavItems.forEach(item => {
                    const activeWidth = item.dataset.itemWidthActive || '140px';
                    const inactiveWidth = item.dataset.itemWidthInactive || '70px';

                    if (item === clickedItem) {
                        item.classList.add('active');
                        item.style.width = activeWidth;
                    } else {
                        item.classList.remove('active');
                        item.style.width = inactiveWidth;
                    }
                });

                // Show the clicked window
                const targetId = clickedItem.dataset.target;
                const targetWindow = document.getElementById(targetId);
                if (targetWindow) {
                    // Set display based on window type
                    if (targetId === 'chat-window') {
                        targetWindow.style.display = 'flex';
                    } else {
                        targetWindow.style.display = 'block';
                    }
                    targetWindow.classList.add('visible');

                    // If workflows window, refresh the workflow list
                    if (targetId === 'workflows-window') {
                        console.log('ðŸ“‚ Workflows window opened, refreshing list...');
                        // Always dispatch event to refresh workflows when window is opened
                        window.dispatchEvent(new CustomEvent('workflow-window-activated'));
                    }

                } else {
                    console.error(`âŒ Window not found: ${targetId}`);
                }
            }

            // Helper function to collapse all windows (can be called from close buttons)
            function collapseAllWindows() {
                const allWindows = document.querySelectorAll('.window');
                const allNavItems = document.querySelectorAll('.nav-item');

                allWindows.forEach(win => {
                    win.classList.remove('visible');
                    win.style.display = 'none';
                });

                allNavItems.forEach(item => {
                    item.classList.remove('active');
                    const inactiveWidth = item.dataset.itemWidthInactive || '70px';
                    item.style.width = inactiveWidth;
                });

                console.log('ðŸ“¦ All windows collapsed');
            }


            function renderMarkdown(text) {
                if (!text) return '';
                
                // Escape HTML first
                let html = text
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Handle code blocks first (```)
                html = html.replace(/```(\w*)\n?([\s\S]*?)```/g, (match, lang, code) => {
                    return `<pre class="code-block"><code>${code.trim()}</code></pre>`;
                });
                
                // Handle inline code (`)
                html = html.replace(/`([^`]+)`/g, '<code class="inline-code">$1</code>');
                
                // Handle headers (### Header)
                html = html.replace(/^### (.+)$/gm, '<h3 class="md-h3">$1</h3>');
                html = html.replace(/^## (.+)$/gm, '<h2 class="md-h2">$1</h2>');
                html = html.replace(/^# (.+)$/gm, '<h1 class="md-h1">$1</h1>');
                
                // Handle horizontal rules (---)
                html = html.replace(/^---+$/gm, '<hr class="md-hr">');
                
                // Handle links [text](url)
                html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="md-link">$1</a>');
                
                // Handle bold (**text** or __text__)
                html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
                html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
                
                // Handle italic (*text* or _text_) - but not in the middle of words
                html = html.replace(/(?<!\w)\*([^*\n]+)\*(?!\w)/g, '<em>$1</em>');
                html = html.replace(/(?<!\w)_([^_\n]+)_(?!\w)/g, '<em>$1</em>');
                
                // Process lines for lists and paragraphs
                const lines = html.split('\n');
                let result = [];
                let inList = false;
                let listType = null;
                let lastWasEmpty = false;
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i];
                    
                    // Check for numbered list (1. item, 2. item, etc.)
                    const numberedMatch = line.match(/^(\d+)\.\s+(.+)$/);
                    // Check for bullet list (* item or - item)
                    const bulletMatch = line.match(/^[\*\-]\s+(.+)$/);
                    // Check for indented bullet list (    * item or    - item)
                    const indentedBulletMatch = line.match(/^(\s{2,})[\*\-]\s+(.+)$/);
                    
                    if (numberedMatch) {
                        lastWasEmpty = false;
                        if (listType !== 'ol') {
                            if (inList) {
                                result.push(listType === 'ul' ? '</ul>' : '</ol>');
                            }
                            result.push('<ol class="md-list">');
                            listType = 'ol';
                            inList = true;
                        }
                        result.push(`<li>${numberedMatch[2]}</li>`);
                    } else if (bulletMatch) {
                        lastWasEmpty = false;
                        if (listType !== 'ul') {
                            if (inList) {
                                result.push(listType === 'ol' ? '</ol>' : '</ul>');
                            }
                            result.push('<ul class="md-list">');
                            listType = 'ul';
                            inList = true;
                        }
                        result.push(`<li>${bulletMatch[1]}</li>`);
                    } else if (indentedBulletMatch) {
                        lastWasEmpty = false;
                        const indent = indentedBulletMatch[1].length;
                        const content = indentedBulletMatch[2];
                        if (!inList) {
                            result.push('<ul class="md-list">');
                            listType = 'ul';
                            inList = true;
                        }
                        result.push(`<li class="md-indent-${Math.min(Math.floor(indent / 2), 4)}">${content}</li>`);
                    } else {
                        // Close any open list
                        if (inList && line.trim() !== '') {
                            result.push(listType === 'ol' ? '</ol>' : '</ul>');
                            inList = false;
                            listType = null;
                        }
                        
                        // Handle empty lines - collapse multiple into one small break
                        if (line.trim() === '') {
                            if (!inList && !lastWasEmpty) {
                                result.push('<br>');
                                lastWasEmpty = true;
                            }
                            // Skip additional empty lines
                        } else if (line.startsWith('<h') || line.startsWith('<hr') || line.startsWith('<pre')) {
                            lastWasEmpty = false;
                            result.push(line);
                        } else {
                            lastWasEmpty = false;
                            // Check for indented content
                            const indentMatch = line.match(/^(\s{4,})(.+)$/);
                            if (indentMatch) {
                                result.push(`<span class="md-indent">${indentMatch[2]}</span>`);
                            } else {
                                result.push(line);
                            }
                        }
                    }
                }
                
                // Close any remaining open list
                if (inList) {
                    result.push(listType === 'ol' ? '</ol>' : '</ul>');
                }
                
                return result.join('');
            }

            function addMessage(text, type, useTypewriter = false, options = {}) {
                const showScreenCaptureIcon = options.showScreenCaptureIcon || false;
                const isScreenCapture = options.isScreenCapture || false;
                const toolsUsed = options.toolsUsed || [];
                const hasTranscription = options.hasTranscription || false;
                const transcriptionWords = options.transcriptionWords || 0;
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', `${type}-message`);

                // Create content wrapper for all messages
                const contentWrapper = document.createElement('div');
                contentWrapper.style.flex = '1';

                // Add transcription attached tag for user messages
                if (type === 'user' && hasTranscription) {
                    const transcriptionTag = document.createElement('div');
                    transcriptionTag.classList.add('transcription-attached-tag');
                    transcriptionTag.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                        <span>Transcription${transcriptionWords ? ` â€¢ ${transcriptionWords} words` : ''}</span>
                    `;
                    contentWrapper.appendChild(transcriptionTag);
                }

                // Add screen capture context badge for vision responses
                if (type === 'ai' && isScreenCapture) {
                    const contextBadge = document.createElement('div');
                    contextBadge.classList.add('screen-capture-context-badge');
                    contextBadge.innerHTML = `
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                            <circle cx="12" cy="13" r="4"></circle>
                        </svg>
                        <span>Screen Analysis</span>
                    `;
                    contentWrapper.appendChild(contextBadge);
                }

                // Add red icon for AI messages
                if (type === 'ai') {
                    const iconElement = document.createElement('div');
                    iconElement.classList.add('ai-message-icon');
                    iconElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 375 374.999991" preserveAspectRatio="xMidYMid meet"><defs><clipPath id="clip1"><path d="M 45.136719 88 L 330 88 L 330 307 L 45.136719 307 Z M 45.136719 88 " clip-rule="nonzero"/></clipPath><clipPath id="clip2"><path d="M 45.136719 68 L 330 68 L 330 286.890625 L 45.136719 286.890625 Z M 45.136719 68 " clip-rule="nonzero"/></clipPath></defs><g clip-path="url(#clip1)"><path fill="#921e1e" d="M 193.53125 97.371094 L 193.53125 124.734375 C 193.53125 129.769531 197.617188 133.855469 202.652344 133.855469 L 226.242188 133.855469 L 261.578125 169.183594 C 261.570312 169.421875 261.507812 169.660156 261.507812 169.894531 L 261.507812 210.941406 C 261.507812 211.1875 261.5625 211.417969 261.578125 211.652344 L 234.570312 238.664062 C 234.332031 238.652344 234.105469 238.589844 233.859375 238.589844 L 192.8125 238.589844 C 192.566406 238.589844 192.335938 238.644531 192.101562 238.664062 L 178.453125 225.015625 C 178.855469 223.519531 179.128906 221.96875 179.128906 220.347656 L 179.128906 165.617188 C 179.128906 155.539062 170.964844 147.375 160.886719 147.375 L 106.15625 147.375 C 96.078125 147.375 87.914062 155.539062 87.914062 165.617188 L 87.914062 220.347656 C 87.914062 221.96875 88.195312 223.519531 88.589844 225.015625 L 77.890625 235.714844 L 54.300781 235.714844 C 49.265625 235.714844 45.179688 239.804688 45.179688 244.839844 L 45.179688 272.203125 C 45.179688 277.238281 49.265625 281.324219 54.300781 281.324219 L 81.664062 281.324219 C 86.699219 281.324219 90.785156 277.238281 90.785156 272.203125 L 90.785156 248.625 L 101.496094 237.914062 C 102.992188 238.316406 104.535156 238.589844 106.15625 238.589844 L 160.886719 238.589844 C 162.511719 238.589844 164.050781 238.308594 165.546875 237.914062 L 179.195312 251.5625 C 179.183594 251.796875 179.121094 252.027344 179.121094 252.273438 L 179.121094 293.320312 C 179.121094 300.871094 185.25 307 192.804688 307 L 233.851562 307 C 241.402344 307 247.53125 300.871094 247.53125 293.320312 L 247.53125 252.273438 C 247.53125 252.027344 247.476562 251.796875 247.460938 251.5625 L 274.46875 224.550781 C 274.707031 224.5625 274.933594 224.625 275.179688 224.625 L 316.226562 224.625 C 323.78125 224.625 329.910156 218.496094 329.910156 210.941406 L 329.910156 169.894531 C 329.910156 162.34375 323.78125 156.214844 316.226562 156.214844 L 275.179688 156.214844 C 274.933594 156.214844 274.707031 156.269531 274.46875 156.285156 L 239.132812 120.957031 L 239.132812 97.371094 C 239.132812 92.335938 235.046875 88.25 230.011719 88.25 L 202.644531 88.25 C 197.609375 88.25 193.523438 92.335938 193.523438 97.371094 Z M 193.53125 97.371094 " fill-opacity="1" fill-rule="nonzero"/></g><g clip-path="url(#clip2)"><path fill="#ed3030" d="M 193.53125 77.257812 L 193.53125 104.621094 C 193.53125 109.65625 197.617188 113.746094 202.652344 113.746094 L 226.242188 113.746094 L 261.578125 149.070312 C 261.570312 149.308594 261.507812 149.546875 261.507812 149.785156 L 261.507812 190.832031 C 261.507812 191.078125 261.5625 191.304688 261.578125 191.542969 L 234.570312 218.550781 C 234.332031 218.542969 234.105469 218.476562 233.859375 218.476562 L 192.8125 218.476562 C 192.566406 218.476562 192.335938 218.53125 192.101562 218.550781 L 178.453125 204.90625 C 178.855469 203.410156 179.128906 201.859375 179.128906 200.234375 L 179.128906 145.503906 C 179.128906 135.425781 170.964844 127.261719 160.886719 127.261719 L 106.15625 127.261719 C 96.078125 127.261719 87.914062 135.425781 87.914062 145.503906 L 87.914062 200.234375 C 87.914062 201.859375 88.195312 203.410156 88.589844 204.90625 L 77.890625 215.605469 L 54.300781 215.605469 C 49.265625 215.605469 45.179688 219.691406 45.179688 224.726562 L 45.179688 252.089844 C 45.179688 257.125 49.265625 261.210938 54.300781 261.210938 L 81.664062 261.210938 C 86.699219 261.210938 90.785156 257.125 90.785156 252.089844 L 90.785156 228.511719 L 101.496094 217.804688 C 102.992188 218.203125 104.535156 218.476562 106.15625 218.476562 L 160.886719 218.476562 C 162.511719 218.476562 164.050781 218.195312 165.546875 217.804688 L 179.195312 231.449219 C 179.183594 231.6875 179.121094 231.914062 179.121094 232.160156 L 179.121094 273.207031 C 179.121094 280.761719 185.25 286.890625 192.804688 286.890625 L 233.851562 286.890625 C 241.402344 286.890625 247.53125 280.761719 247.53125 273.207031 L 247.53125 232.160156 C 247.53125 231.914062 247.476562 231.6875 247.460938 231.449219 L 274.46875 204.441406 C 274.707031 204.449219 274.933594 204.511719 275.179688 204.511719 L 316.226562 204.511719 C 323.78125 204.511719 329.910156 198.382812 329.910156 190.832031 L 329.910156 149.785156 C 329.910156 142.230469 323.78125 136.101562 316.226562 136.101562 L 275.179688 136.101562 C 274.933594 136.101562 274.707031 136.15625 274.46875 136.175781 L 239.132812 100.847656 L 239.132812 77.257812 C 239.132812 72.222656 235.046875 68.136719 230.011719 68.136719 L 202.644531 68.136719 C 197.609375 68.136719 193.523438 72.222656 193.523438 77.257812 Z M 193.53125 77.257812 " fill-opacity="1" fill-rule="nonzero"/></g></svg>`;
                    messageElement.appendChild(iconElement);

                    // ðŸ†• MCP TOOL USAGE - Only show errors for AI messages
                    if (toolsUsed.length > 0) {
                        // Only show tool indicators if there are errors
                        const hasErrors = toolsUsed.some(tool => !tool.success);

                        if (hasErrors) {
                            const toolsContainer = document.createElement('div');
                            toolsContainer.classList.add('mcp-tools-container');

                            toolsUsed.forEach(tool => {
                                if (!tool.success && tool.error) {
                                    const toolElement = document.createElement('div');
                                    toolElement.classList.add('mcp-tool-usage');
                                    toolElement.classList.add('mcp-tool-error');

                                    const toolError = document.createElement('div');
                                    toolError.classList.add('tool-error-msg');
                                    toolError.textContent = tool.error;
                                    toolElement.appendChild(toolError);

                                    toolsContainer.appendChild(toolElement);
                                }
                            });

                            if (toolsContainer.children.length > 0) {
                                contentWrapper.appendChild(toolsContainer);
                            }
                        }
                    }
                }

                const textElement = document.createElement('span');
                textElement.classList.add('text-content');

                if (useTypewriter && type === 'ai') {
                    textElement.classList.add('typewriter-text');
                    textElement.dataset.rawText = text;
                    textElement.innerHTML = ''; // Start empty for typewriter effect
                    contentWrapper.appendChild(textElement);
                    messageElement.appendChild(contentWrapper);

                    // Add to conversation view first
                    conversationView.appendChild(messageElement);
                    conversationView.scrollTop = conversationView.scrollHeight;

                    // Start typewriter animation
                    typewriterEffect(textElement, renderMarkdown(text));
                } else {
                    textElement.innerHTML = renderMarkdown(text);
                    contentWrapper.appendChild(textElement);

                    if (showScreenCaptureIcon) {
                        const iconElement = document.createElement('span');
                        iconElement.classList.add('screen-capture-icon');
                        iconElement.title = "Screen capture was attached";
                        iconElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>`;
                        contentWrapper.appendChild(iconElement);
                    }

                    messageElement.appendChild(contentWrapper);
                    conversationView.appendChild(messageElement);
                    conversationView.scrollTop = conversationView.scrollHeight;
                }

                // Return the message element for potential manipulation (like removing loading messages)
                return messageElement;
            }

            // Expose addMessage globally so workflow-builder can use it
            window.addMessage = addMessage;

            function typewriterEffect(element, htmlText, speed = 1) {
                let index = 0;
                const cursor = document.createElement('span');
                cursor.classList.add('typewriter-cursor');
                element.appendChild(cursor);

                // For very long messages, process multiple characters at once for better performance
                const chunkSize = htmlText.length > 500 ? 3 : 1;

                function typeNextCharacter() {
                    if (index < htmlText.length) {
                        const nextIndex = Math.min(index + chunkSize, htmlText.length);
                        element.innerHTML = htmlText.substring(0, nextIndex);
                        element.appendChild(cursor); // Re-add cursor after text update
                        index = nextIndex;

                        // Auto-scroll as text appears
                        conversationView.scrollTop = conversationView.scrollHeight;

                        setTimeout(typeNextCharacter, speed);
                    } else {
                        // Remove cursor when done
                        setTimeout(() => {
                            if (cursor.parentNode) {
                                cursor.remove();
                            }
                        }, 1000);
                    }
                }

                typeNextCharacter();
            }

            // Streaming typewriter effect for Gemini Live responses
            function streamingTypewriterEffect(element, getBufferFn, speed = 2) {
                let displayedLength = 0;
                const cursor = document.createElement('span');
                cursor.classList.add('typewriter-cursor');
                element.appendChild(cursor);

                function typeNextCharacter() {
                    const buffer = getBufferFn();

                    if (displayedLength < buffer.length) {
                        // Type next character(s)
                        const nextLength = Math.min(displayedLength + 1, buffer.length);
                        const htmlToDisplay = renderMarkdown(buffer.substring(0, nextLength));
                        element.innerHTML = htmlToDisplay;
                        element.appendChild(cursor); // Re-add cursor after text update
                        displayedLength = nextLength;

                        // Auto-scroll as text appears
                        conversationView.scrollTop = conversationView.scrollHeight;

                        setTimeout(typeNextCharacter, speed);
                    } else if (geminiTypewriterActive) {
                        // Check again for more text after a short delay
                        setTimeout(typeNextCharacter, 50);
                    } else {
                        // Streaming complete, remove cursor after delay
                        setTimeout(() => {
                            if (cursor.parentNode) {
                                cursor.remove();
                            }
                        }, 1000);
                    }
                }

                typeNextCharacter();
            }

            function addTypingIndicator() {
                const messageElement = document.createElement('div');
                messageElement.classList.add('typing-indicator-container');

                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('typing-indicator');

                // Create red logo
                const logoElement = document.createElement('div');
                logoElement.classList.add('typing-logo');
                logoElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 375 374.999991" preserveAspectRatio="xMidYMid meet"><defs><clipPath id="clip1"><path d="M 45.136719 88 L 330 88 L 330 307 L 45.136719 307 Z M 45.136719 88 " clip-rule="nonzero"/></clipPath><clipPath id="clip2"><path d="M 45.136719 68 L 330 68 L 330 286.890625 L 45.136719 286.890625 Z M 45.136719 68 " clip-rule="nonzero"/></clipPath></defs><g clip-path="url(#clip1)"><path fill="#921e1e" d="M 193.53125 97.371094 L 193.53125 124.734375 C 193.53125 129.769531 197.617188 133.855469 202.652344 133.855469 L 226.242188 133.855469 L 261.578125 169.183594 C 261.570312 169.421875 261.507812 169.660156 261.507812 169.894531 L 261.507812 210.941406 C 261.507812 211.1875 261.5625 211.417969 261.578125 211.652344 L 234.570312 238.664062 C 234.332031 238.652344 234.105469 238.589844 233.859375 238.589844 L 192.8125 238.589844 C 192.566406 238.589844 192.335938 238.644531 192.101562 238.664062 L 178.453125 225.015625 C 178.855469 223.519531 179.128906 221.96875 179.128906 220.347656 L 179.128906 165.617188 C 179.128906 155.539062 170.964844 147.375 160.886719 147.375 L 106.15625 147.375 C 96.078125 147.375 87.914062 155.539062 87.914062 165.617188 L 87.914062 220.347656 C 87.914062 221.96875 88.195312 223.519531 88.589844 225.015625 L 77.890625 235.714844 L 54.300781 235.714844 C 49.265625 235.714844 45.179688 239.804688 45.179688 244.839844 L 45.179688 272.203125 C 45.179688 277.238281 49.265625 281.324219 54.300781 281.324219 L 81.664062 281.324219 C 86.699219 281.324219 90.785156 277.238281 90.785156 272.203125 L 90.785156 248.625 L 101.496094 237.914062 C 102.992188 238.316406 104.535156 238.589844 106.15625 238.589844 L 160.886719 238.589844 C 162.511719 238.589844 164.050781 238.308594 165.546875 237.914062 L 179.195312 251.5625 C 179.183594 251.796875 179.121094 252.027344 179.121094 252.273438 L 179.121094 293.320312 C 179.121094 300.871094 185.25 307 192.804688 307 L 233.851562 307 C 241.402344 307 247.53125 300.871094 247.53125 293.320312 L 247.53125 252.273438 C 247.53125 252.027344 247.476562 251.796875 247.460938 251.5625 L 274.46875 224.550781 C 274.707031 224.5625 274.933594 224.625 275.179688 224.625 L 316.226562 224.625 C 323.78125 224.625 329.910156 218.496094 329.910156 210.941406 L 329.910156 169.894531 C 329.910156 162.34375 323.78125 156.214844 316.226562 156.214844 L 275.179688 156.214844 C 274.933594 156.214844 274.707031 156.269531 274.46875 156.285156 L 239.132812 120.957031 L 239.132812 97.371094 C 239.132812 92.335938 235.046875 88.25 230.011719 88.25 L 202.644531 88.25 C 197.609375 88.25 193.523438 92.335938 193.523438 97.371094 Z M 193.53125 97.371094 " fill-opacity="1" fill-rule="nonzero"/></g><g clip-path="url(#clip2)"><path fill="#ed3030" d="M 193.53125 77.257812 L 193.53125 104.621094 C 193.53125 109.65625 197.617188 113.746094 202.652344 113.746094 L 226.242188 113.746094 L 261.578125 149.070312 C 261.570312 149.308594 261.507812 149.546875 261.507812 149.785156 L 261.507812 190.832031 C 261.507812 191.078125 261.5625 191.304688 261.578125 191.542969 L 234.570312 218.550781 C 234.332031 218.542969 234.105469 218.476562 233.859375 218.476562 L 192.8125 218.476562 C 192.566406 218.476562 192.335938 218.53125 192.101562 218.550781 L 178.453125 204.90625 C 178.855469 203.410156 179.128906 201.859375 179.128906 200.234375 L 179.128906 145.503906 C 179.128906 135.425781 170.964844 127.261719 160.886719 127.261719 L 106.15625 127.261719 C 96.078125 127.261719 87.914062 135.425781 87.914062 145.503906 L 87.914062 200.234375 C 87.914062 201.859375 88.195312 203.410156 88.589844 204.90625 L 77.890625 215.605469 L 54.300781 215.605469 C 49.265625 215.605469 45.179688 219.691406 45.179688 224.726562 L 45.179688 252.089844 C 45.179688 257.125 49.265625 261.210938 54.300781 261.210938 L 81.664062 261.210938 C 86.699219 261.210938 90.785156 257.125 90.785156 252.089844 L 90.785156 228.511719 L 101.496094 217.804688 C 102.992188 218.203125 104.535156 218.476562 106.15625 218.476562 L 160.886719 218.476562 C 162.511719 218.476562 164.050781 218.195312 165.546875 217.804688 L 179.195312 231.449219 C 179.183594 231.6875 179.121094 231.914062 179.121094 232.160156 L 179.121094 273.207031 C 179.121094 280.761719 185.25 286.890625 192.804688 286.890625 L 233.851562 286.890625 C 241.402344 286.890625 247.53125 280.761719 247.53125 273.207031 L 247.53125 232.160156 C 247.53125 231.914062 247.476562 231.6875 247.460938 231.449219 L 274.46875 204.441406 C 274.707031 204.449219 274.933594 204.511719 275.179688 204.511719 L 316.226562 204.511719 C 323.78125 204.511719 329.910156 198.382812 329.910156 190.832031 L 329.910156 149.785156 C 329.910156 142.230469 323.78125 136.101562 316.226562 136.101562 L 275.179688 136.101562 C 274.933594 136.101562 274.707031 136.15625 274.46875 136.175781 L 239.132812 100.847656 L 239.132812 77.257812 C 239.132812 72.222656 235.046875 68.136719 230.011719 68.136719 L 202.644531 68.136719 C 197.609375 68.136719 193.523438 72.222656 193.523438 77.257812 Z M 193.53125 77.257812 " fill-opacity="1" fill-rule="nonzero"/></g></svg>`;

                // Create circular spinner
                const spinnerElement = document.createElement('div');
                spinnerElement.classList.add('typing-spinner');

                typingIndicator.appendChild(logoElement);
                typingIndicator.appendChild(spinnerElement);
                messageElement.appendChild(typingIndicator);

                // Create thinking status text - inline layout
                const thinkingStatus = document.createElement('div');
                thinkingStatus.classList.add('thinking-status');

                const thinkingText = document.createElement('div');
                thinkingText.classList.add('thinking-text');

                const thinkingWord = document.createElement('span');
                thinkingWord.classList.add('thinking-text-word');
                thinkingWord.textContent = 'Thinking';

                const thinkingDots = document.createElement('span');
                thinkingDots.classList.add('thinking-dots');
                thinkingDots.innerHTML = '<span class="thinking-dot"></span><span class="thinking-dot"></span><span class="thinking-dot"></span>';

                thinkingText.appendChild(thinkingWord);
                thinkingText.appendChild(thinkingDots);

                const separator = document.createElement('span');
                separator.classList.add('thinking-separator');

                const thinkingHint = document.createElement('span');
                thinkingHint.classList.add('thinking-hint');
                thinkingHint.textContent = 'Processing your request';

                thinkingStatus.appendChild(thinkingText);
                thinkingStatus.appendChild(separator);
                thinkingStatus.appendChild(thinkingHint);
                messageElement.appendChild(thinkingStatus);

                conversationView.appendChild(messageElement);
                conversationView.scrollTop = conversationView.scrollHeight;

                // Cycle through thinking states
                const thinkingStates = [
                    { text: 'Thinking', hint: 'Processing your request' },
                    { text: 'Analysing', hint: 'Understanding context' },
                    { text: 'Reasoning', hint: 'Evaluating options' },
                    { text: 'Generating', hint: 'Crafting response' }
                ];
                let stateIndex = 0;

                messageElement.thinkingInterval = setInterval(() => {
                    stateIndex = (stateIndex + 1) % thinkingStates.length;
                    const state = thinkingStates[stateIndex];
                    
                    // Animate text change
                    thinkingWord.style.opacity = '0';
                    thinkingWord.style.transform = 'translateY(-4px)';
                    
                    setTimeout(() => {
                        thinkingWord.textContent = state.text;
                        thinkingHint.textContent = state.hint;
                        thinkingWord.style.opacity = '1';
                        thinkingWord.style.transform = 'translateY(0)';
                    }, 200);
                }, 2500);

                return messageElement;
            }

            function removeTypingIndicator(indicatorElement) {
                if (indicatorElement) {
                    if (indicatorElement.thinkingInterval) {
                        clearInterval(indicatorElement.thinkingInterval);
                    }
                    indicatorElement.remove();
                }
            }

            // Add workflow execution indicator to chat
            function addWorkflowIndicator(workflowName) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('workflow-indicator-container');

                const workflowIndicator = document.createElement('div');
                workflowIndicator.classList.add('workflow-indicator');

                // Workflow icon with spinner
                const iconContainer = document.createElement('div');
                iconContainer.classList.add('workflow-icon');

                const iconInner = document.createElement('span');
                iconInner.classList.add('workflow-icon-inner');
                iconInner.textContent = 'âš¡';

                const spinner = document.createElement('div');
                spinner.classList.add('workflow-spinner');

                iconContainer.appendChild(iconInner);
                iconContainer.appendChild(spinner);

                // Workflow info
                const infoContainer = document.createElement('div');
                infoContainer.classList.add('workflow-info');

                const nameElement = document.createElement('div');
                nameElement.classList.add('workflow-name');
                nameElement.textContent = workflowName;

                const statusElement = document.createElement('div');
                statusElement.classList.add('workflow-status');
                statusElement.textContent = 'Running workflow...';

                infoContainer.appendChild(nameElement);
                infoContainer.appendChild(statusElement);

                workflowIndicator.appendChild(iconContainer);
                workflowIndicator.appendChild(infoContainer);
                messageElement.appendChild(workflowIndicator);
                conversationView.appendChild(messageElement);
                conversationView.scrollTop = conversationView.scrollHeight;

                return messageElement;
            }

            // Mark workflow indicator as complete
            function markWorkflowComplete(indicatorElement, success = true) {
                if (!indicatorElement) return;

                const indicator = indicatorElement.querySelector('.workflow-indicator');
                if (indicator) {
                    indicator.classList.add('workflow-complete');

                    const iconInner = indicator.querySelector('.workflow-icon-inner');
                    if (iconInner) {
                        iconInner.textContent = success ? 'âœ“' : 'âœ—';
                    }

                    const status = indicator.querySelector('.workflow-status');
                    if (status) {
                        status.textContent = success ? 'Completed successfully' : 'Failed';
                    }
                }
            }

            function addToolCallingIndicator() {
                const messageElement = document.createElement('div');
                messageElement.classList.add('tool-calling-indicator-container');

                const toolIndicator = document.createElement('div');
                toolIndicator.classList.add('tool-calling-indicator');

                // Tool icon - wrench/tool SVG
                const toolIcon = document.createElement('span');
                toolIcon.classList.add('tool-calling-icon');
                toolIcon.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                </svg>`;

                // Tool text
                const toolText = document.createElement('span');
                toolText.classList.add('tool-calling-text');
                toolText.textContent = 'Using tool';

                // Animated dots (styled like thinking dots)
                const dotsContainer = document.createElement('span');
                dotsContainer.classList.add('tool-calling-dots');
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('span');
                    dot.classList.add('tool-calling-dot');
                    dotsContainer.appendChild(dot);
                }

                toolIndicator.appendChild(toolIcon);
                toolIndicator.appendChild(toolText);
                toolIndicator.appendChild(dotsContainer);
                messageElement.appendChild(toolIndicator);
                conversationView.appendChild(messageElement);
                conversationView.scrollTop = conversationView.scrollHeight;

                return messageElement;
            }

            function addCaptureIndicator() {
                const messageElement = document.createElement('div');
                messageElement.classList.add('typing-indicator-container');

                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('typing-indicator');

                // Create red logo (same as thinking animation)
                const logoElement = document.createElement('div');
                logoElement.classList.add('typing-logo');
                logoElement.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 375 374.999991" preserveAspectRatio="xMidYMid meet"><defs><clipPath id="clip1"><path d="M 45.136719 88 L 330 88 L 330 307 L 45.136719 307 Z M 45.136719 88 " clip-rule="nonzero"/></clipPath><clipPath id="clip2"><path d="M 45.136719 68 L 330 68 L 330 286.890625 L 45.136719 286.890625 Z M 45.136719 68 " clip-rule="nonzero"/></clipPath></defs><g clip-path="url(#clip1)"><path fill="#921e1e" d="M 193.53125 97.371094 L 193.53125 124.734375 C 193.53125 129.769531 197.617188 133.855469 202.652344 133.855469 L 226.242188 133.855469 L 261.578125 169.183594 C 261.570312 169.421875 261.507812 169.660156 261.507812 169.894531 L 261.507812 210.941406 C 261.507812 211.1875 261.5625 211.417969 261.578125 211.652344 L 234.570312 238.664062 C 234.332031 238.652344 234.105469 238.589844 233.859375 238.589844 L 192.8125 238.589844 C 192.566406 238.589844 192.335938 238.644531 192.101562 238.664062 L 178.453125 225.015625 C 178.855469 223.519531 179.128906 221.96875 179.128906 220.347656 L 179.128906 165.617188 C 179.128906 155.539062 170.964844 147.375 160.886719 147.375 L 106.15625 147.375 C 96.078125 147.375 87.914062 155.539062 87.914062 165.617188 L 87.914062 220.347656 C 87.914062 221.96875 88.195312 223.519531 88.589844 225.015625 L 77.890625 235.714844 L 54.300781 235.714844 C 49.265625 235.714844 45.179688 239.804688 45.179688 244.839844 L 45.179688 272.203125 C 45.179688 277.238281 49.265625 281.324219 54.300781 281.324219 L 81.664062 281.324219 C 86.699219 281.324219 90.785156 277.238281 90.785156 272.203125 L 90.785156 248.625 L 101.496094 237.914062 C 102.992188 238.316406 104.535156 238.589844 106.15625 238.589844 L 160.886719 238.589844 C 162.511719 238.589844 164.050781 238.308594 165.546875 237.914062 L 179.195312 251.5625 C 179.183594 251.796875 179.121094 252.027344 179.121094 252.273438 L 179.121094 293.320312 C 179.121094 300.871094 185.25 307 192.804688 307 L 233.851562 307 C 241.402344 307 247.53125 300.871094 247.53125 293.320312 L 247.53125 252.273438 C 247.53125 252.027344 247.476562 251.796875 247.460938 251.5625 L 274.46875 224.550781 C 274.707031 224.5625 274.933594 224.625 275.179688 224.625 L 316.226562 224.625 C 323.78125 224.625 329.910156 218.496094 329.910156 210.941406 L 329.910156 169.894531 C 329.910156 162.34375 323.78125 156.214844 316.226562 156.214844 L 275.179688 156.214844 C 274.933594 156.214844 274.707031 156.269531 274.46875 156.285156 L 239.132812 120.957031 L 239.132812 97.371094 C 239.132812 92.335938 235.046875 88.25 230.011719 88.25 L 202.644531 88.25 C 197.609375 88.25 193.523438 92.335938 193.523438 97.371094 Z M 193.53125 97.371094 " fill-opacity="1" fill-rule="nonzero"/></g><g clip-path="url(#clip2)"><path fill="#ed3030" d="M 193.53125 77.257812 L 193.53125 104.621094 C 193.53125 109.65625 197.617188 113.746094 202.652344 113.746094 L 226.242188 113.746094 L 261.578125 149.070312 C 261.570312 149.308594 261.507812 149.546875 261.507812 149.785156 L 261.507812 190.832031 C 261.507812 191.078125 261.5625 191.304688 261.578125 191.542969 L 234.570312 218.550781 C 234.332031 218.542969 234.105469 218.476562 233.859375 218.476562 L 192.8125 218.476562 C 192.566406 218.476562 192.335938 218.53125 192.101562 218.550781 L 178.453125 204.90625 C 178.855469 203.410156 179.128906 201.859375 179.128906 200.234375 L 179.128906 145.503906 C 179.128906 135.425781 170.964844 127.261719 160.886719 127.261719 L 106.15625 127.261719 C 96.078125 127.261719 87.914062 135.425781 87.914062 145.503906 L 87.914062 200.234375 C 87.914062 201.859375 88.195312 203.410156 88.589844 204.90625 L 77.890625 215.605469 L 54.300781 215.605469 C 49.265625 215.605469 45.179688 219.691406 45.179688 224.726562 L 45.179688 252.089844 C 45.179688 257.125 49.265625 261.210938 54.300781 261.210938 L 81.664062 261.210938 C 86.699219 261.210938 90.785156 257.125 90.785156 252.089844 L 90.785156 228.511719 L 101.496094 217.804688 C 102.992188 218.203125 104.535156 218.476562 106.15625 218.476562 L 160.886719 218.476562 C 162.511719 218.476562 164.050781 218.195312 165.546875 217.804688 L 179.195312 231.449219 C 179.183594 231.6875 179.121094 231.914062 179.121094 232.160156 L 179.121094 273.207031 C 179.121094 280.761719 185.25 286.890625 192.804688 286.890625 L 233.851562 286.890625 C 241.402344 286.890625 247.53125 280.761719 247.53125 273.207031 L 247.53125 232.160156 C 247.53125 231.914062 247.476562 231.6875 247.460938 231.449219 L 274.46875 204.441406 C 274.707031 204.449219 274.933594 204.511719 275.179688 204.511719 L 316.226562 204.511719 C 323.78125 204.511719 329.910156 198.382812 329.910156 190.832031 L 329.910156 149.785156 C 329.910156 142.230469 323.78125 136.101562 316.226562 136.101562 L 275.179688 136.101562 C 274.933594 136.101562 274.707031 136.15625 274.46875 136.175781 L 239.132812 100.847656 L 239.132812 77.257812 C 239.132812 72.222656 235.046875 68.136719 230.011719 68.136719 L 202.644531 68.136719 C 197.609375 68.136719 193.523438 72.222656 193.523438 77.257812 Z M 193.53125 77.257812 " fill-opacity="1" fill-rule="nonzero"/></g></svg>`;

                // Create circular spinner (same as thinking animation)
                const spinnerElement = document.createElement('div');
                spinnerElement.classList.add('typing-spinner');

                typingIndicator.appendChild(logoElement);
                typingIndicator.appendChild(spinnerElement);
                messageElement.appendChild(typingIndicator);

                // Create thinking status text - inline layout (same structure as thinking animation)
                const thinkingStatus = document.createElement('div');
                thinkingStatus.classList.add('thinking-status');

                const thinkingText = document.createElement('div');
                thinkingText.classList.add('thinking-text');

                const thinkingWord = document.createElement('span');
                thinkingWord.classList.add('thinking-text-word');
                thinkingWord.textContent = 'Capturing';

                const thinkingDots = document.createElement('span');
                thinkingDots.classList.add('thinking-dots');
                thinkingDots.innerHTML = '<span class="thinking-dot"></span><span class="thinking-dot"></span><span class="thinking-dot"></span>';

                thinkingText.appendChild(thinkingWord);
                thinkingText.appendChild(thinkingDots);

                const separator = document.createElement('span');
                separator.classList.add('thinking-separator');

                const thinkingHint = document.createElement('span');
                thinkingHint.classList.add('thinking-hint');
                thinkingHint.textContent = 'Taking screenshot';

                thinkingStatus.appendChild(thinkingText);
                thinkingStatus.appendChild(separator);
                thinkingStatus.appendChild(thinkingHint);
                messageElement.appendChild(thinkingStatus);

                conversationView.appendChild(messageElement);
                conversationView.scrollTop = conversationView.scrollHeight;

                // Cycle through capture states (same timing as thinking animation - 2500ms)
                const captureStates = [
                    { text: 'Capturing', hint: 'Taking screenshot' },
                    { text: 'Analyzing', hint: 'Processing image' },
                    { text: 'Thinking', hint: 'Understanding context' },
                    { text: 'Generating', hint: 'Crafting response' }
                ];
                let stateIndex = 0;

                // Change state every 2500ms to match thinking animation
                messageElement.captureInterval = setInterval(() => {
                    stateIndex = (stateIndex + 1) % captureStates.length;
                    const state = captureStates[stateIndex];
                    
                    // Animate text change (same as thinking animation)
                    thinkingWord.style.opacity = '0';
                    thinkingWord.style.transform = 'translateY(-4px)';
                    
                    setTimeout(() => {
                        thinkingWord.textContent = state.text;
                        thinkingHint.textContent = state.hint;
                        thinkingWord.style.opacity = '1';
                        thinkingWord.style.transform = 'translateY(0)';
                    }, 200);
                }, 2500);

                return messageElement;
            }

            function removeCaptureIndicator(indicatorElement) {
                if (indicatorElement) {
                    if (indicatorElement.captureInterval) {
                        clearInterval(indicatorElement.captureInterval);
                    }
                    indicatorElement.remove();
                }
            }

            function getConversationHistory() {
                const messages = [];
                const messageElements = conversationView.querySelectorAll('.message');

                messageElements.forEach(element => {
                    const isUser = element.classList.contains('user-message');
                    const textContent = element.querySelector('.text-content');
                    if (textContent && textContent.textContent.trim() !== 'Thinking...') {
                        messages.push({
                            isUser: isUser,
                            text: textContent.textContent,
                            timestamp: Date.now()
                        });
                    }
                });

                return messages.slice(-10); // Return last 10 messages for context
            }

            function updateConversationHistory() {
                const history = getConversationHistory();
                if (window.electronAPI && window.electronAPI.updateConversationHistory) {
                    window.electronAPI.updateConversationHistory(history);
                }
                
                // Auto-save chat to history with debounce
                if (autoSaveTimeout) {
                    clearTimeout(autoSaveTimeout);
                }
                autoSaveTimeout = setTimeout(() => {
                    saveCurrentChat();
                }, 1000);
            }

            // Rate limit state
            let isRateLimited = false;
            
            // Check rate limit status and update UI
            async function checkRateLimitStatus() {
                try {
                    const result = await window.electronAPI.checkMessageLimit();
                    if (result && !result.allowed) {
                        lockChatInput(result.reason || 'Daily limit reached');
                        return false;
                    } else {
                        unlockChatInput();
                        return true;
                    }
                } catch (error) {
                    console.error('Error checking rate limit:', error);
                    return true;
                }
            }
            
            // Lock chat input when rate limited
            function lockChatInput(reason) {
                isRateLimited = true;
                const sendBtn = document.getElementById('send-btn');
                const chatInput = document.getElementById('chat-input');
                
                if (sendBtn) {
                    sendBtn.disabled = true;
                    sendBtn.style.opacity = '0.4';
                    sendBtn.style.cursor = 'not-allowed';
                    sendBtn.title = reason;
                }
                
                if (chatInput) {
                    chatInput.disabled = true;
                    chatInput.style.opacity = '0.7';
                    chatInput.style.textAlign = 'center';
                    chatInput.placeholder = 'â±ï¸ ' + reason;
                }
                
                console.log('ðŸ”’ Chat locked:', reason);
            }
            
            // Unlock chat input
            function unlockChatInput() {
                if (!isRateLimited) return;
                
                isRateLimited = false;
                const sendBtn = document.getElementById('send-btn');
                const chatInput = document.getElementById('chat-input');
                
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.style.opacity = '1';
                    sendBtn.style.cursor = 'pointer';
                    sendBtn.title = 'Send message';
                }
                
                if (chatInput) {
                    chatInput.disabled = false;
                    chatInput.style.opacity = '1';
                    chatInput.style.textAlign = 'left';
                    chatInput.placeholder = 'Message RED AI...';
                }
                
                console.log('ðŸ”“ Chat unlocked');
            }
            
            // Check rate limit on page load and periodically
            setTimeout(checkRateLimitStatus, 1000);
            setInterval(checkRateLimitStatus, 60000); // Check every minute

            async function handleSendMessage() {
                if (!chatInput) {
                    console.error('âŒ chatInput not found');
                    return;
                }
                
                // Check if rate limited before sending
                if (isRateLimited) {
                    console.log('âš ï¸ Message blocked - rate limited');
                    return;
                }

                const text = chatInput.value.trim();
                if (text === '') return;

                const isCaptureActive = currentCapturedScreenshot !== null;
                
                // Track if transcription was attached for this message
                const hasTranscriptionAttached = transcriptionAttachment !== null;
                const transcriptionWordCount = transcriptionAttachment?.wordCount || 0;

                addMessage(text, 'user', isCaptureActive, { 
                    hasTranscription: hasTranscriptionAttached,
                    transcriptionWords: transcriptionWordCount
                });
                chatInput.value = '';
                chatInput.placeholder = 'Message RED AI...';

                chatInput.style.height = 'auto';
                chatInput.rows = 1;

                if (isCaptureActive) {
                    // Clear capture and remove button highlight after sending
                    currentCapturedScreenshot = null;
                    if (captureBtn) {
                        captureBtn.classList.remove('active');
                    }
                }

                // STEP 1: Check if user is responding to a workflow confirmation
                if (window.pendingWorkflow) {
                    const lowerText = text.toLowerCase();
                    if (lowerText === 'yes' || lowerText === 'y' || lowerText === 'sure' || lowerText === 'ok' || lowerText === 'okay') {
                        // User confirmed - run the workflow
                        const workflowId = window.pendingWorkflow.id;
                        await runWorkflow(workflowId);
                        return; // STOP HERE - don't do anything else
                    } else if (lowerText === 'no' || lowerText === 'n' || lowerText === 'nope' || lowerText === 'cancel') {
                        // User declined
                        addMessage('No problem! Let me know if you need anything else.', 'ai', true);
                        window.pendingWorkflow = null;
                        return; // STOP HERE
                    }
                    // If it's neither yes nor no, clear pending workflow and continue normally
                    window.pendingWorkflow = null;
                }

                // STEP 2: Check if user wants to CREATE a workflow
                const isWorkflowCreation = await handleWorkflowCreation(text);
                if (isWorkflowCreation) {
                    return; // STOP HERE - workflow creation in progress
                }

                // STEP 3: Check if message triggers any existing workflow
                const triggeredWorkflow = await checkWorkflowTriggers(text);
                if (triggeredWorkflow) {
                    // Workflow was triggered, animation shown
                    return; // STOP HERE - don't call regular API
                }

                // STEP 3: No workflow triggered, proceed with Gemini Live conversation
                // Show appropriate indicator based on whether capture is active
                const loadingMessage = isCaptureActive ? addCaptureIndicator() : addTypingIndicator();

                try {
                    if (!isCaptureActive) {
                        // Build message with transcription context if attached
                        let messageToSend = text;

                        if (transcriptionAttachment && transcriptionAttachment.content) {
                            console.log('ðŸ“Ž Including transcription context in message');
                            messageToSend = `[ATTACHED TRANSCRIPTION - Use this as context when answering]\n${transcriptionAttachment.content}\n[END TRANSCRIPTION]\n\nUser Question: ${text}`;
                        }
                        
                        // Clear transcription attachment after using it
                        if (hasTranscriptionAttached) {
                            hideTranscriptionAttachmentBadge();
                            console.log('âœ… Transcription detached after sending');
                        }

                        // Get conversation history for context (last 10 messages)
                        const history = getConversationHistory();

                        const res = await window.electronAPI.callAiText(messageToSend, null, undefined, history);

                        // Remove loading indicator
                        removeTypingIndicator(loadingMessage);

                        if (res?.success) {
                            // Check if MCP tools were used
                            const toolsUsed = res.toolsUsed || [];

                            // If tools were used, show tool calling animation briefly
                            if (toolsUsed.length > 0) {
                                const toolIndicator = addToolCallingIndicator();

                                // Show animation for 800ms then remove and show actual message
                                await new Promise(resolve => setTimeout(resolve, 800));
                                if (toolIndicator && toolIndicator.remove) {
                                    toolIndicator.remove();
                                }
                            }

                            addMessage(res.result || '', 'ai', true, { toolsUsed });
                        } else if (res?.rateLimited) {
                            const limitMessage = res?.error || 'Daily message limit reached';
                            addMessage(`â±ï¸ **Limit Reached**\n\n${limitMessage}\n\nYour limit resets at midnight. Upgrade your plan for unlimited messages.`, 'ai', false, false);
                            lockChatInput(limitMessage);
                        } else {
                            addMessage(`âŒ ${res?.error || 'AI error'}`, 'ai', false, false);
                        }
                    } else {
                        // Use captured screenshot if available
                        const apiStart = performance.now();
                        let screenshot = currentCapturedScreenshot;

                        if (!screenshot) {
                            console.log('âš ï¸ No captured screenshot available, capturing now...');
                            const captureStart = performance.now();
                            screenshot = await window.electronAPI.captureScreenshot('medium');
                            console.log(`ðŸ“¸ Screenshot captured in ${(performance.now() - captureStart).toFixed(0)}ms`);
                        }

                        // Clear captured screenshot after use
                        currentCapturedScreenshot = null;

                        const res = await window.electronAPI.callAiVision({ text: text, imageBase64: screenshot, mimeType: 'image/jpeg' });
                        const totalTime = performance.now() - apiStart;
                        console.log(`ðŸ¤– Total response time: ${totalTime.toFixed(0)}ms`);

                        // Remove the capture indicator (uses same structure as typing indicator)
                        removeCaptureIndicator(loadingMessage);

                        if (res?.success) {
                            // Add the response with screen capture context badge
                            addMessage(res.result || '', 'ai', true, { showScreenCaptureIcon: true, isScreenCapture: true });
                        } else if (res?.rateLimited) {
                            const limitMessage = res?.error || 'Daily message limit reached';
                            addMessage(`â±ï¸ **Limit Reached**\n\n${limitMessage}\n\nYour limit resets at midnight. Upgrade your plan for unlimited messages.`, 'ai', false, false);
                            lockChatInput(limitMessage);
                        } else {
                            addMessage(`âŒ ${res?.error || 'AI error'}`, 'ai', false, false);
                        }
                    }

                    if (!isCaptureActive) {
                        removeTypingIndicator(loadingMessage);
                    }

                    // Update conversation history
                    updateConversationHistory();

                } catch (error) {
                    console.error('Error getting Gemini Live response:', error);
                    // Remove indicator properly based on type
                    if (isCaptureActive) {
                        removeCaptureIndicator(loadingMessage);
                    } else {
                        removeTypingIndicator(loadingMessage);
                    }
                    addMessage("Sorry, I encountered an error. Please try again.", 'ai', true);
                }
            }

            // --- Ultra-Smooth Absolute Position Dragging ---
            let isDragging = false;
            let dragStartMouseX, dragStartMouseY;
            let dragStartWindowX, dragStartWindowY;
            let animationFrameId = null;
            let pendingPosition = null;

            const dragHandle = document.getElementById('drag-handle');

            async function onMouseDown(e) {
                e.preventDefault();
                isDragging = true;

                // Store initial mouse position
                dragStartMouseX = e.screenX;
                dragStartMouseY = e.screenY;

                // Get initial window position
                if (window.electronAPI && window.electronAPI.getWindowPosition) {
                    try {
                        const position = await window.electronAPI.getWindowPosition();
                        dragStartWindowX = position.x;
                        dragStartWindowY = position.y;
                    } catch (error) {
                        console.error('Failed to get window position:', error);
                        isDragging = false;
                        return;
                    }
                }

                // Visual feedback
                dragHandle.style.transform = 'scale(0.95)';
                dragHandle.style.color = '#ef4444';
                document.body.style.cursor = 'grabbing';

                document.addEventListener('mousemove', onMouseMove, { passive: false });
                document.addEventListener('mouseup', onMouseUp, { passive: true });
            }

            function onMouseMove(e) {
                if (!isDragging) return;
                e.preventDefault();

                // Calculate absolute window position based on cursor movement
                const newWindowX = dragStartWindowX + (e.screenX - dragStartMouseX);
                const newWindowY = dragStartWindowY + (e.screenY - dragStartMouseY);

                // Store the target position
                pendingPosition = { x: newWindowX, y: newWindowY };

                // Use requestAnimationFrame for smooth updates
                if (!animationFrameId) {
                    animationFrameId = requestAnimationFrame(() => {
                        if (pendingPosition && window.electronAPI && window.electronAPI.setWindowPosition) {
                            window.electronAPI.setWindowPosition(pendingPosition.x, pendingPosition.y).catch(error => {
                                console.error('Failed to set window position:', error);
                            });
                            pendingPosition = null;
                        }
                        animationFrameId = null;
                    });
                }
            }

            function onMouseUp() {
                isDragging = false;

                // Cancel any pending animation frame
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }

                // Process any final pending position
                if (pendingPosition && window.electronAPI && window.electronAPI.setWindowPosition) {
                    window.electronAPI.setWindowPosition(pendingPosition.x, pendingPosition.y).catch(error => {
                        console.error('Failed to set window position:', error);
                    });
                    pendingPosition = null;
                }

                // Reset visual feedback
                dragHandle.style.transform = '';
                dragHandle.style.color = '';
                document.body.style.cursor = '';

                document.removeEventListener('mousemove', onMouseMove, { passive: false });
                document.removeEventListener('mouseup', onMouseUp, { passive: true });
            }

            // Initialize navigation pill widths
            function initializeNavigation() {
                const allNavItems = document.querySelectorAll('.nav-item');
                let currentActiveItem = document.querySelector('.nav-item.active');

                if (!currentActiveItem && allNavItems.length > 0) {
                    currentActiveItem = allNavItems[0];
                    currentActiveItem.classList.add('active');
                }

                allNavItems.forEach(item => {
                    const activeWidth = item.dataset.itemWidthActive || '140px';
                    const inactiveWidth = item.dataset.itemWidthInactive || '70px';

                    if (item === currentActiveItem) {
                        item.style.width = activeWidth;
                    } else {
                        item.style.width = inactiveWidth;
                    }
                });
            }

            // --- Event Listeners ---
            if (dragHandle) {
                dragHandle.addEventListener('mousedown', onMouseDown);
            } else {
                console.error('âŒ dragHandle not found');
            }

            if (listItems && listItems.length > 0) {
                listItems.forEach(item => item.addEventListener('click', setActive));
            } else {
                console.error('âŒ listItems not found');
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', handleSendMessage);
            } else {
                console.error('âŒ sendBtn not found');
            }

            // Initialize navigation widths
            initializeNavigation();

            if (chatInput) {
                chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        handleSendMessage();
                    }
                });
            } else {
                console.error('âŒ chatInput not found');
            }

            // Current captured screenshot
            let currentCapturedScreenshot = null;

            // Capture button functionality - toggle between capture and cancel
            if (captureBtn) {
                captureBtn.addEventListener('click', async () => {
                    // Check if already captured - if so, cancel/undo
                    if (currentCapturedScreenshot !== null) {
                        console.log('ðŸ”„ Canceling screenshot capture...');
                        currentCapturedScreenshot = null;
                        captureBtn.classList.remove('active');

                        // Brief visual feedback for cancel
                        captureBtn.style.transform = 'scale(0.9)';
                        setTimeout(() => {
                            captureBtn.style.transform = '';
                        }, 150);

                        return; // Exit early - toggle off complete
                    }

                    // Not captured yet - proceed with capture
                    const originalOpacity = captureBtn.style.opacity;
                    captureBtn.style.opacity = '0.5';

                    try {
                        console.log('ðŸ“¸ Capturing screenshot...');
                        const captureStart = performance.now();
                        const screenshotBuffer = await window.electronAPI.captureScreenshot('high');
                        const captureTime = performance.now() - captureStart;
                        console.log(`âœ… Screenshot captured in ${captureTime.toFixed(0)}ms`);

                        // Store screenshot data
                        currentCapturedScreenshot = screenshotBuffer;

                        // Highlight button to indicate capture is ready
                        captureBtn.classList.add('active');

                        // Brief visual pulse to confirm capture
                        captureBtn.style.opacity = '1';
                        captureBtn.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            captureBtn.style.transform = '';
                        }, 150);
                    } catch (error) {
                        console.error('Failed to capture screenshot:', error);
                        currentCapturedScreenshot = null;
                        captureBtn.classList.remove('active');
                        captureBtn.style.opacity = originalOpacity;
                    }
                });
            } else {
                console.error('âŒ captureBtn not found');
            }

            // Remove capture button handler - clears screenshot and removes button highlight
            const removeCaptureBtn = document.getElementById('remove-capture');
            if (removeCaptureBtn) {
                removeCaptureBtn.addEventListener('click', function () {
                    currentCapturedScreenshot = null;
                    if (captureBtn) {
                        captureBtn.classList.remove('active');
                    }
                });
            }
            const quickActionButtons = document.getElementById('quick-action-buttons');
            const newChatBtn = document.getElementById('new-chat-btn');
            const historyBtn = document.getElementById('history-btn');
            const chatDropdownContent = document.getElementById('chat-dropdown-content');

            // ChatGPT-style Menu & Dropdown Logic
            if (menuBtn && quickActionButtons) {
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();

                    // Toggle quick action buttons visibility
                    const isActive = quickActionButtons.classList.contains('active');
                    if (!isActive) {
                        quickActionButtons.classList.add('active');
                        menuBtn.classList.add('active');
                    } else {
                        quickActionButtons.classList.remove('active');
                        menuBtn.classList.remove('active');

                        // Hide dropdown and reset buttons
                        if (chatDropdown) chatDropdown.classList.remove('active');
                        const chatWindow = document.getElementById('chat-window');
                        if (chatWindow) chatWindow.classList.remove('dropdown-active');

                        // Reset all quick action buttons
                        document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
                    }
                });
            } else {
                console.warn('âš ï¸ menuBtn or quickActionButtons not found - menu functionality disabled');
            }

            // Quick action button handlers
            if (newChatBtn) {
                newChatBtn.addEventListener('click', (e) => {
                    e.stopPropagation();

                    // Reset other buttons
                    document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
                    newChatBtn.classList.add('active');

                    // Show dropdown with new chat content
                    if (chatDropdownContent) chatDropdownContent.innerHTML = '<div class="chat-dropdown-message">Starting a new chat will save your current conversation.</div><div style="text-align: center; margin-top: 12px;"><button id="confirm-new-chat" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">Start New Chat</button></div>';
                    if (chatDropdown) chatDropdown.classList.add('active');
                    const chatWindow = document.getElementById('chat-window');
                    if (chatWindow) {
                        chatWindow.classList.add('dropdown-active');
                    }

                    // Add handler for confirm button
                    const confirmNewChatBtn = document.getElementById('confirm-new-chat');
                    if (confirmNewChatBtn) {
                        confirmNewChatBtn.addEventListener('click', () => {
                            // Trigger new chat functionality
                            saveCurrentChat();
                            if (conversationView) conversationView.innerHTML = '';
                            if (chatInput) chatInput.value = '';
                            currentChatId = generateChatId();
                            addMessage('How can I help you today?', 'ai', true);

                            // Hide dropdown
                            if (chatDropdown) chatDropdown.classList.remove('active');
                            if (chatWindow) {
                                chatWindow.classList.remove('dropdown-active');
                            }
                            if (newChatBtn) newChatBtn.classList.remove('active');
                        });
                    }
                });
            } else {
                console.warn('âš ï¸ newChatBtn not found - new chat menu disabled');
            }

            if (historyBtn) {
                historyBtn.addEventListener('click', (e) => {
                    e.stopPropagation();

                    // Toggle panel
                    if (chatDropdown && chatDropdown.classList.contains('active')) {
                        chatDropdown.classList.remove('active');
                        historyBtn.classList.remove('active');
                        document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
                    } else {
                        document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));
                        historyBtn.classList.add('active');
                        loadChatHistory();
                        if (chatDropdownContent) chatDropdownContent.innerHTML = '';
                        if (chatHistoryList) chatHistoryList.style.display = 'block';
                        if (chatDropdown) chatDropdown.classList.add('active');
                    }
                });
            } else {
                console.warn('âš ï¸ historyBtn not found - history menu disabled');
            }

            // Inline option buttons - Chat History
            const historyBtnInline = document.getElementById('history-btn-inline');
            if (historyBtnInline) {
                historyBtnInline.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // Simulate history button click
                    if (historyBtn) {
                        historyBtn.click();
                    }

                    // Close extended options
                    const extendedOptions = document.getElementById('extended-options');
                    if (extendedOptions) {
                        extendedOptions.classList.remove('active');
                        if (menuBtn) {
                            menuBtn.classList.remove('active');
                        }
                    }
                });
            }

            // Inline option buttons - Clear Chat
            const clearBtnInline = document.getElementById('clear-btn-inline');
            if (clearBtnInline) {
                clearBtnInline.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    // Confirm before clearing
                    const confirmed = await customConfirm({
                        title: 'Clear Conversation',
                        message: 'Are you sure you want to clear the current conversation?',
                        confirmText: 'Clear',
                        type: 'warning'
                    });
                    
                    if (confirmed) {
                        saveCurrentChat();
                        conversationView.innerHTML = '';
                        chatInput.value = '';
                        currentChatId = generateChatId();
                        addMessage('How can I help you today?', 'ai', true);
                    }

                    // Close extended options
                    const extendedOptions = document.getElementById('extended-options');
                    if (extendedOptions) {
                        extendedOptions.classList.remove('active');
                        if (menuBtn) {
                            menuBtn.classList.remove('active');
                        }
                    }
                });
            }

            // Setup chat window buttons handlers (Chat History and Clear Chat)
            function setupChatWindowButtons() {
                const chatHistoryBtn = document.getElementById('chat-history-btn');
                const chatClearBtn = document.getElementById('chat-clear-btn');

                console.log('ðŸ”§ Setting up chat window buttons:', {
                    chatHistoryBtn: !!chatHistoryBtn,
                    chatClearBtn: !!chatClearBtn,
                    chatHistoryBtnExists: chatHistoryBtn !== null,
                    chatClearBtnExists: chatClearBtn !== null,
                    chatHistoryBtnHandlerAttached: chatHistoryBtn?.dataset?.handlerAttached,
                    chatClearBtnHandlerAttached: chatClearBtn?.dataset?.handlerAttached
                });

                if (chatHistoryBtn && !chatHistoryBtn.dataset.handlerAttached) {
                    console.log('âœ… Attaching handler to chat-history-btn');
                    chatHistoryBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ“œ Chat History button clicked');

                        const chatDropdown = document.getElementById('chat-dropdown');
                        const chatHistoryList = document.getElementById('chat-history-list');
                        const chatDropdownContent = document.getElementById('chat-dropdown-content');
                        
                        // Toggle panel
                        if (chatDropdown && chatDropdown.classList.contains('active')) {
                            // Close panel
                            chatDropdown.classList.remove('active');
                            chatDropdown.style.transform = 'translateX(-50%) translateY(100%)';
                            chatDropdown.style.opacity = '0';
                            chatDropdown.style.visibility = 'hidden';
                            chatHistoryBtn.classList.remove('active');
                            console.log('ðŸ“œ History panel closed');
                        } else {
                            // Open panel
                            loadChatHistory();
                            if (chatDropdownContent) chatDropdownContent.style.display = 'none';
                            if (chatHistoryList) chatHistoryList.style.display = 'block';
                            if (chatDropdown) {
                                chatDropdown.classList.add('active');
                                // Force styles inline as fallback
                                chatDropdown.style.transform = 'translateX(-50%) translateY(0)';
                                chatDropdown.style.opacity = '1';
                                chatDropdown.style.visibility = 'visible';
                                chatDropdown.style.pointerEvents = 'all';
                            }
                            chatHistoryBtn.classList.add('active');
                            console.log('ðŸ“œ History panel opened');
                        }
                    });
                    chatHistoryBtn.dataset.handlerAttached = 'true';
                }

                if (chatClearBtn && !chatClearBtn.dataset.handlerAttached) {
                    console.log('âœ… Attaching handler to chat-clear-btn');
                    chatClearBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ—‘ï¸ Clear Chat button clicked');

                        // Confirm before clearing
                        const confirmed = await customConfirm({
                            title: 'Clear Conversation',
                            message: 'Are you sure you want to clear the current conversation?',
                            confirmText: 'Clear',
                            type: 'warning'
                        });
                        
                        if (confirmed) {
                            console.log('âœ… User confirmed clear chat');
                            if (typeof saveCurrentChat === 'function') {
                                saveCurrentChat();
                            }
                            const conversationView = document.querySelector('.conversation-view');
                            const chatInput = document.getElementById('chat-input');
                            if (conversationView) {
                                conversationView.innerHTML = '';
                            }
                            if (chatInput) {
                                chatInput.value = '';
                            }
                            if (typeof currentChatId !== 'undefined' && typeof generateChatId === 'function') {
                                currentChatId = generateChatId();
                            }
                            if (typeof addMessage === 'function') {
                                addMessage('How can I help you today?', 'ai', true);
                            }
                        }
                    });
                    chatClearBtn.dataset.handlerAttached = 'true';
                }
            }

            // Handle chat buttons with direct attachment (no global delegation)
            function attachChatButtonListeners() {
                const historyBtn = document.getElementById('chat-history-btn');
                const clearBtn = document.getElementById('chat-clear-btn');

                if (historyBtn && !historyBtn.dataset.listenerAttached) {
                    historyBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        console.log('ðŸ“œ Chat History button clicked');

                        const chatDropdown = document.getElementById('chat-dropdown');
                        const chatHistoryList = document.getElementById('chat-history-list');
                        const chatDropdownContent = document.getElementById('chat-dropdown-content');
                        
                        // Toggle panel
                        if (chatDropdown && chatDropdown.classList.contains('active')) {
                            chatDropdown.classList.remove('active');
                            chatDropdown.style.transform = 'translateX(-50%) translateY(100%)';
                            chatDropdown.style.opacity = '0';
                            chatDropdown.style.visibility = 'hidden';
                            historyBtn.classList.remove('active');
                        } else {
                            loadChatHistory();
                            if (chatDropdownContent) chatDropdownContent.style.display = 'none';
                            if (chatHistoryList) chatHistoryList.style.display = 'block';
                            if (chatDropdown) {
                                chatDropdown.classList.add('active');
                                chatDropdown.style.transform = 'translateX(-50%) translateY(0)';
                                chatDropdown.style.opacity = '1';
                                chatDropdown.style.visibility = 'visible';
                                chatDropdown.style.pointerEvents = 'all';
                            }
                            historyBtn.classList.add('active');
                        }
                    });
                    historyBtn.dataset.listenerAttached = 'true';
                }

                if (clearBtn && !clearBtn.dataset.listenerAttached) {
                    clearBtn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        console.log('ðŸ—‘ï¸ Clear Chat button clicked');

                        const confirmed = await customConfirm({
                            title: 'Clear Conversation',
                            message: 'Are you sure you want to clear the current conversation?',
                            confirmText: 'Clear',
                            type: 'warning'
                        });
                        
                        if (confirmed) {
                            saveCurrentChat();
                            const conversationView = document.querySelector('.conversation-view');
                            const chatInput = document.getElementById('chat-input');
                            if (conversationView) {
                                conversationView.innerHTML = '';
                            }
                            if (chatInput) {
                                chatInput.value = '';
                            }
                            currentChatId = generateChatId();
                            addMessage('How can I help you today?', 'ai', true);
                        }
                    });
                    clearBtn.dataset.listenerAttached = 'true';
                }
            }

            // Attach listeners after components load
            setTimeout(attachChatButtonListeners, 1000);
            // Also attach on window click in case buttons load late
            window.addEventListener('click', () => {
                attachChatButtonListeners();
            }, { once: true, capture: true });

            // Setup buttons immediately if they exist
            setupChatWindowButtons();

            // Debug function to test chat buttons manually
            window.testChatButtons = function () {
                console.log('ðŸ§ª Testing chat buttons...');
                const chatHistoryBtn = document.getElementById('chat-history-btn');
                const chatClearBtn = document.getElementById('chat-clear-btn');

                console.log('Button elements found:', {
                    chatHistoryBtn: !!chatHistoryBtn,
                    chatClearBtn: !!chatClearBtn,
                    chatHistoryBtnVisible: chatHistoryBtn ? getComputedStyle(chatHistoryBtn).display !== 'none' : false,
                    chatClearBtnVisible: chatClearBtn ? getComputedStyle(chatClearBtn).display !== 'none' : false
                });

                if (chatHistoryBtn) {
                    console.log('ðŸ“œ Manually triggering chat history button');
                    chatHistoryBtn.click();
                } else {
                    console.log('âŒ Chat history button not found');
                }

                setTimeout(() => {
                    if (chatClearBtn) {
                        console.log('ðŸ—‘ï¸ Manually triggering clear chat button');
                        chatClearBtn.click();
                    } else {
                        console.log('âŒ Clear chat button not found');
                    }
                }, 2000);
            };

            // Debug function to check all elements
            window.debugChatElements = function () {
                console.log('ðŸ” Debugging chat elements...');
                console.log('All elements with chat-history-btn ID:', document.querySelectorAll('#chat-history-btn'));
                console.log('All elements with chat-clear-btn ID:', document.querySelectorAll('#chat-clear-btn'));
                console.log('Chat window element:', document.getElementById('chat-window'));
                console.log('Chat input area:', document.querySelector('.chat-input-area'));
                console.log('Window container:', document.querySelector('.window-container'));

                // Check if buttons have event listeners
                const historyBtn = document.getElementById('chat-history-btn');
                const clearBtn = document.getElementById('chat-clear-btn');

                if (historyBtn) {
                    console.log('History button details:', {
                        element: historyBtn,
                        handlerAttached: historyBtn.dataset.handlerAttached,
                        visible: getComputedStyle(historyBtn).display !== 'none',
                        pointerEvents: getComputedStyle(historyBtn).pointerEvents,
                        zIndex: getComputedStyle(historyBtn).zIndex,
                        position: getComputedStyle(historyBtn).position
                    });
                }
                if (clearBtn) {
                    console.log('Clear button details:', {
                        element: clearBtn,
                        handlerAttached: clearBtn.dataset.handlerAttached,
                        visible: getComputedStyle(clearBtn).display !== 'none',
                        pointerEvents: getComputedStyle(clearBtn).pointerEvents,
                        zIndex: getComputedStyle(clearBtn).zIndex,
                        position: getComputedStyle(clearBtn).position
                    });
                }
            };

            // Function to simulate button clicks programmatically
            window.simulateButtonClicks = function () {
                console.log('ðŸŽ¯ Simulating button clicks...');
                const historyBtn = document.getElementById('chat-history-btn');
                const clearBtn = document.getElementById('chat-clear-btn');

                if (historyBtn) {
                    console.log('ðŸ“œ Simulating history button click');
                    historyBtn.dispatchEvent(new MouseEvent('click', {
                        bubbles: true,
                        cancelable: true,
                        view: window
                    }));
                }

                setTimeout(() => {
                    if (clearBtn) {
                        console.log('ðŸ—‘ï¸ Simulating clear button click');
                        clearBtn.dispatchEvent(new MouseEvent('click', {
                            bubbles: true,
                            cancelable: true,
                            view: window
                        }));
                    }
                }, 1000);
            };

            // Listen for component-loaded event
            window.addEventListener('component-loaded', (e) => {
                if (e.detail.component === 'chat-window') {
                    console.log('ðŸ“¦ Chat window component loaded, setting up buttons');
                    setTimeout(() => {
                        console.log('ðŸ”„ Setting up buttons after chat-window component loaded');
                        setupChatWindowButtons();
                    }, 50);
                }
            });

            // Also setup buttons after delays to catch dynamically loaded components
            setTimeout(() => {
                console.log('ðŸ”„ Setting up buttons after 100ms delay');
                setupChatWindowButtons();
            }, 100);
            setTimeout(() => {
                console.log('ðŸ”„ Setting up buttons after 500ms delay');
                setupChatWindowButtons();
            }, 500);
            setTimeout(() => {
                console.log('ðŸ”„ Setting up buttons after 1000ms delay');
                setupChatWindowButtons();
            }, 1000);

            // Add MutationObserver to watch for dynamically added buttons
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList') {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeType === Node.ELEMENT_NODE) {
                                if (node.id === 'chat-history-btn' || node.id === 'chat-clear-btn' ||
                                    node.querySelector && (node.querySelector('#chat-history-btn') || node.querySelector('#chat-clear-btn'))) {
                                    console.log('ðŸ” Chat buttons detected via MutationObserver, setting up handlers');
                                    setTimeout(setupChatWindowButtons, 10);
                                }
                            }
                        });
                    }
                });
            });

            // Start observing
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            // Close dropdown and extended options when clicking outside
            document.addEventListener('click', (e) => {
                const extendedOptions = document.getElementById('extended-options');
                const chatInputArea = document.getElementById('chat-input-area') || document.querySelector('.input-card');

                // Close dropdown - with null checks
                if (chatDropdown && menuBtn && quickActionButtons &&
                    !chatDropdown.contains(e.target) && e.target !== menuBtn && !quickActionButtons.contains(e.target)) {
                    chatDropdown.classList.remove('active');
                    menuBtn.classList.remove('active');
                    quickActionButtons.classList.remove('active');
                    
                    // Reset dropdown state
                    resetDropdownState();

                    // Remove dropdown-active class from chat window
                    const chatWindow = document.getElementById('chat-window');
                    if (chatWindow) {
                        chatWindow.classList.remove('dropdown-active');
                    }

                    // Reset all quick action buttons
                    document.querySelectorAll('.quick-action-btn').forEach(btn => btn.classList.remove('active'));

                    // Hide lists
                    if (chatHistoryList) {
                        chatHistoryList.style.display = 'none';
                    }
                }

                // Close extended options panel if clicking outside
                if (extendedOptions && chatInputArea && !chatInputArea.contains(e.target) && !extendedOptions.contains(e.target)) {
                    extendedOptions.classList.remove('active');
                    if (menuBtn) {
                        menuBtn.classList.remove('active');
                    }
                }
            });

            // New Chat
            if (newChatItem) {
                newChatItem.addEventListener('click', () => {
                    saveCurrentChat();
                    if (conversationView) conversationView.innerHTML = '';
                    if (chatInput) chatInput.value = '';
                    currentChatId = generateChatId();
                    if (chatDropdown) chatDropdown.classList.remove('active');
                    if (menuBtn) menuBtn.classList.remove('active');

                    // Remove dropdown-active class from chat window
                    const chatWindow = document.getElementById('chat-window');
                    if (chatWindow) chatWindow.classList.remove('dropdown-active');

                    addMessage('How can I help you today?', 'ai', true);
                });
            }

            // Toggle Chat History View
            let historyExpanded = false;
            if (historyToggleItem) {
                historyToggleItem.addEventListener('click', () => {
                    historyExpanded = !historyExpanded;
                    if (historyExpanded) {
                        loadChatHistory();
                        if (chatHistoryList) chatHistoryList.style.display = 'block';
                        const titleEl = historyToggleItem.querySelector('.chat-dropdown-item-title');
                        if (titleEl) titleEl.textContent = 'Hide History';
                    } else {
                        if (chatHistoryList) chatHistoryList.style.display = 'none';
                        const titleEl = historyToggleItem.querySelector('.chat-dropdown-item-title');
                        if (titleEl) titleEl.textContent = 'Chat History';
                    }
                });
            }


            // Generate unique chat ID
            function generateChatId() {
                return `chat_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            }

            // Format timestamp for display
            function formatChatTimestamp(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const isToday = date.toDateString() === now.toDateString();
                const isYesterday = new Date(now - 86400000).toDateString() === date.toDateString();
                
                const timeStr = date.toLocaleTimeString('en-GB', { 
                    hour: '2-digit', 
                    minute: '2-digit',
                    hour12: false 
                });
                
                if (isToday) {
                    return `Today at ${timeStr}`;
                } else if (isYesterday) {
                    return `Yesterday at ${timeStr}`;
                } else {
                    const dateStr = date.toLocaleDateString('en-GB', { 
                        day: 'numeric',
                        month: 'short',
                        year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
                    });
                    return `${dateStr} at ${timeStr}`;
                }
            }

            // Save current chat to history
            function saveCurrentChat() {
                if (!currentChatId || conversationView.children.length === 0) return;

                const messages = Array.from(conversationView.querySelectorAll('.message')).map(msg => ({
                    type: msg.classList.contains('user-message') ? 'user' : 'ai',
                    text: msg.querySelector('.text-content')?.textContent || '',
                    timestamp: Date.now()
                }));

                // Filter out empty messages and common AI greeting messages
                const greetingPhrases = ['how can i help you', 'what can i help', 'how may i assist'];
                const validMessages = messages.filter(m => {
                    if (!m.text || m.text.trim() === '') return false;
                    // Skip common AI greeting messages for title purposes but keep in history
                    return true;
                });
                
                if (validMessages.length === 0) return;
                
                // Only save if there's at least one user message
                const hasUserMessage = validMessages.some(m => m.type === 'user');
                if (!hasUserMessage) return;

                // Find first user message for title (skip AI greetings)
                const firstUserMessage = validMessages.find(m => m.type === 'user');
                const title = firstUserMessage ? firstUserMessage.text.trim() : 'New conversation';

                const existingIndex = chatHistory.findIndex(c => c.id === currentChatId);
                const existingChat = existingIndex >= 0 ? chatHistory[existingIndex] : null;
                
                const chatData = {
                    id: currentChatId,
                    title: title.substring(0, 60) + (title.length > 60 ? '...' : ''),
                    preview: title.substring(0, 100),
                    messages: validMessages,
                    createdAt: existingChat?.createdAt || Date.now(),
                    updatedAt: Date.now(),
                    messageCount: validMessages.length
                };

                if (existingIndex >= 0) {
                    chatHistory[existingIndex] = chatData;
                } else {
                    chatHistory.unshift(chatData);
                }

                // Keep only last 50 chats
                chatHistory = chatHistory.slice(0, 50);
                localStorage.setItem('redGlassChatHistory', JSON.stringify(chatHistory));
                console.log('ðŸ’¾ Chat saved:', chatData.title);
            }

            // Reset dropdown state when closed
            function resetDropdownState() {
                const chatDropdownContent = document.getElementById('chat-dropdown-content');
                if (chatDropdownContent) {
                    chatDropdownContent.style.display = 'block';
                    chatDropdownContent.innerHTML = '<div class="chat-dropdown-message">Select a quick action above</div>';
                }
                if (chatHistoryList) {
                    chatHistoryList.style.display = 'none';
                }
            }
            
            // Load and display chat history
            function loadChatHistory() {
                chatHistoryList.innerHTML = '';
                
                // Hide the default dropdown content message when showing history
                const chatDropdownContent = document.getElementById('chat-dropdown-content');
                if (chatDropdownContent) {
                    chatDropdownContent.style.display = 'none';
                }

                if (chatHistory.length === 0) {
                    chatHistoryList.innerHTML = '<div class="chat-dropdown-empty">No chat history yet. Start a conversation!</div>';
                    return;
                }

                chatHistory.forEach(chat => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'chat-history-item';
                    
                    // Use createdAt if available, otherwise fall back to timestamp
                    const chatTimestamp = chat.createdAt || chat.timestamp || Date.now();
                    const formattedTime = formatChatTimestamp(chatTimestamp);
                    const messageCount = chat.messageCount || chat.messages?.length || 0;
                    
                    historyItem.innerHTML = `
                    <div class="chat-history-item-info">
                        <div class="chat-history-item-header">
                            <span class="chat-history-item-date">${formattedTime}</span>
                            <span class="chat-history-item-count">${messageCount} messages</span>
                        </div>
                        <div class="chat-history-item-title">${chat.title}</div>
                    </div>
                    <div class="chat-history-item-delete" data-id="${chat.id}" title="Delete conversation">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        </svg>
                    </div>
                `;

                    const infoElement = historyItem.querySelector('.chat-history-item-info');
                    if (infoElement) {
                        infoElement.addEventListener('click', () => {
                            loadChat(chat.id);
                        });
                    }

                    const deleteElement = historyItem.querySelector('.chat-history-item-delete');
                    if (deleteElement) {
                        deleteElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteChat(chat.id);
                        });
                    }

                    chatHistoryList.appendChild(historyItem);
                });
            }

            // Load specific chat
            function loadChat(chatId) {
                const chat = chatHistory.find(c => c.id === chatId);
                if (!chat) {
                    console.warn('âš ï¸ Chat not found:', chatId);
                    return;
                }

                console.log('ðŸ“‚ Loading chat:', chat.title, `(${chat.messages?.length || 0} messages)`);
                
                saveCurrentChat(); // Save current before switching
                conversationView.innerHTML = '';
                currentChatId = chatId;

                // Restore all messages from the saved conversation
                if (chat.messages && chat.messages.length > 0) {
                    chat.messages.forEach((msg, index) => {
                        if (msg.text && msg.text.trim()) {
                            addMessage(msg.text, msg.type, false, false);
                        }
                    });
                    console.log(`âœ… Loaded ${chat.messages.length} messages`);
                } else {
                    addMessage('How can I help you today?', 'ai', true);
                }

                // Close history panel
                if (chatDropdown) {
                    chatDropdown.classList.remove('active');
                    chatDropdown.style.transform = 'translateX(-50%) translateY(100%)';
                    chatDropdown.style.opacity = '0';
                    chatDropdown.style.visibility = 'hidden';
                }
                if (menuBtn) menuBtn.classList.remove('active');
                
                // Reset dropdown state
                resetDropdownState();
                
                // Close quick action buttons
                const quickActionButtons = document.getElementById('quick-action-buttons');
                if (quickActionButtons) quickActionButtons.classList.remove('active');

                // Remove dropdown-active class from chat window
                const chatWindow = document.getElementById('chat-window');
                if (chatWindow) {
                    chatWindow.classList.remove('dropdown-active');
                }
                
                // Reset history button state
                const chatHistoryBtn = document.getElementById('chat-history-btn');
                if (chatHistoryBtn) chatHistoryBtn.classList.remove('active');
                
                // Scroll to bottom of conversation
                setTimeout(() => {
                    conversationView.scrollTop = conversationView.scrollHeight;
                }, 100);
            }

            // Delete chat from history
            function deleteChat(chatId) {
                chatHistory = chatHistory.filter(c => c.id !== chatId);
                localStorage.setItem('redGlassChatHistory', JSON.stringify(chatHistory));
                loadChatHistory();
            }


            // Auto-save on new messages
            const originalAddMessage = addMessage;
            window.addEventListener('beforeunload', () => {
                saveCurrentChat();
            });

            // Compact Workflow functionality - REMOVED (using new workflow system below)

            // ================================
            // AUTHENTICATION FUNCTIONALITY
            // ================================

            // MongoDB connection configuration
            const MONGODB_CONFIG = {
                uri: 'mongodb+srv://YousefAly:Kubo0219@red-ai-app.ihzx0.mongodb.net/certificate_management',
                dbName: 'certificate_management',
                collection: 'users'
            };

            // Authentication state
            let currentUser = null;
            let isAuthenticating = false;

            // DOM Elements for Authentication
            const authInterface = document.getElementById('auth-interface');
            const userProfile = document.getElementById('user-profile');
            const loginTab = document.getElementById('login-tab');
            const registerTab = document.getElementById('register-tab');
            const loginForm = document.getElementById('login-form');
            const registerForm = document.getElementById('register-form');
            const authError = document.getElementById('auth-error');
            const authSuccess = document.getElementById('auth-success');
            const loginButton = document.getElementById('login-button');
            const registerButton = document.getElementById('register-button');
            const logoutBtn = document.getElementById('logout-btn');
            const userAvatar = document.getElementById('user-avatar');
            const userName = document.getElementById('user-name');
            const userEmail = document.getElementById('user-email');

            // Initialize authentication system
            function initializeAuth() {
                setupAuthEventListeners();
                checkAuthStatus();
                addLogoutButton();
            }

            // Add logout button to navigation
            function addLogoutButton() {
                // Check if user is authenticated
                if (window.electronAPI && window.electronAPI.getCurrentUser) {
                    window.electronAPI.getCurrentUser().then(result => {
                        if (result.success && result.isAuthenticated) {
                            createLogoutButton(result.user);
                        }
                    }).catch(error => {
                        console.error('Error checking auth status:', error);
                    });
                }
            }

            // Create logout button in navigation
            function createLogoutButton(user) {
                const navigation = document.querySelector('.navigation');
                if (!navigation || document.getElementById('logout-nav-btn')) return;

                const logoutBtn = document.createElement('button');
                logoutBtn.id = 'logout-nav-btn';
                logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i>';
                logoutBtn.title = `Sign out (${user.email})`;
                logoutBtn.style.cssText = `
                position: absolute;
                right: 15px;
                top: 50%;
                transform: translateY(-50%);
                width: 36px;
                height: 36px;
                border: 1px solid rgba(255, 255, 255, 0.2);
                border-radius: 50%;
                background: transparent;
                color: rgba(255, 255, 255, 0.7);
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 14px;
            `;

                // Hover effects
                logoutBtn.addEventListener('mouseenter', () => {
                    logoutBtn.style.background = 'rgba(239, 68, 68, 0.2)';
                    logoutBtn.style.borderColor = '#ef4444';
                    logoutBtn.style.color = '#ef4444';
                });

                logoutBtn.addEventListener('mouseleave', () => {
                    logoutBtn.style.background = 'transparent';
                    logoutBtn.style.borderColor = 'rgba(255, 255, 255, 0.2)';
                    logoutBtn.style.color = 'rgba(255, 255, 255, 0.7)';
                });

                // Logout functionality
                logoutBtn.addEventListener('click', async () => {
                    const confirmed = await customConfirm({
                        title: 'Sign Out',
                        message: 'Are you sure you want to sign out?',
                        confirmText: 'Sign Out',
                        type: 'info'
                    });
                    
                    if (confirmed) {
                        try {
                            if (window.electronAPI && window.electronAPI.logoutUser) {
                                await window.electronAPI.logoutUser();
                            }
                        } catch (error) {
                            console.error('Logout error:', error);
                        }
                    }
                });

                navigation.appendChild(logoutBtn);
            }

            // Setup event listeners for authentication
            function setupAuthEventListeners() {
                // Tab switching
                loginTab.addEventListener('click', () => switchAuthTab('login'));
                registerTab.addEventListener('click', () => switchAuthTab('register'));

                // Form submissions
                loginForm.addEventListener('submit', handleLogin);
                registerForm.addEventListener('submit', handleRegister);

                // Logout
                logoutBtn.addEventListener('click', handleLogout);

                // Profile actions
                document.getElementById('edit-profile-btn').addEventListener('click', () => {
                    showMessage('Profile editing feature coming soon!', 'success');
                });

                document.getElementById('change-password-btn').addEventListener('click', () => {
                    showMessage('Password change feature coming soon!', 'success');
                });

                document.getElementById('delete-account-btn').addEventListener('click', async () => {
                    const confirmed = await customConfirm({
                        title: 'Delete Account',
                        message: 'Are you sure you want to delete your account? This action cannot be undone.',
                        confirmText: 'Delete Account',
                        type: 'danger'
                    });
                    
                    if (confirmed) {
                        handleDeleteAccount();
                    }
                });
            }

            // Switch between login and register tabs
            function switchAuthTab(tab) {
                // Update tab appearance
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));

                if (tab === 'login') {
                    loginTab.classList.add('active');
                    loginForm.classList.add('active');
                } else {
                    registerTab.classList.add('active');
                    registerForm.classList.add('active');
                }

                clearMessages();
            }

            // Handle login form submission
            async function handleLogin(e) {
                e.preventDefault();

                if (isAuthenticating) return;

                const formData = new FormData(loginForm);
                const loginData = {
                    email: formData.get('email'),
                    password: formData.get('password')
                };

                try {
                    isAuthenticating = true;
                    setButtonLoading(loginButton, true);
                    clearMessages();

                    // Call backend API for authentication
                    const response = await authenticateUser(loginData);

                    if (response.success) {
                        currentUser = response.user;
                        showUserProfile();
                        showMessage('Welcome back! Successfully signed in.', 'success');
                    } else {
                        showMessage(response.error || 'Invalid email or password', 'error');
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    showMessage('Network error. Please try again.', 'error');
                } finally {
                    isAuthenticating = false;
                    setButtonLoading(loginButton, false);
                }
            }

            // Handle register form submission
            async function handleRegister(e) {
                e.preventDefault();

                if (isAuthenticating) return;

                const formData = new FormData(registerForm);
                const registerData = {
                    fullName: formData.get('fullName'),
                    email: formData.get('email'),
                    password: formData.get('password'),
                    confirmPassword: formData.get('confirmPassword')
                };

                // Validate password match
                if (registerData.password !== registerData.confirmPassword) {
                    showMessage('Passwords do not match', 'error');
                    return;
                }

                // Validate password strength
                if (registerData.password.length < 6) {
                    showMessage('Password must be at least 6 characters long', 'error');
                    return;
                }

                try {
                    isAuthenticating = true;
                    setButtonLoading(registerButton, true);
                    clearMessages();

                    // Call backend API for registration
                    const response = await registerUser(registerData);

                    if (response.success) {
                        currentUser = response.user;
                        showUserProfile();
                        showMessage('Account created successfully! Welcome to RED AI.', 'success');
                    } else {
                        showMessage(response.error || 'Registration failed. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    showMessage('Network error. Please try again.', 'error');
                } finally {
                    isAuthenticating = false;
                    setButtonLoading(registerButton, false);
                }
            }

            // Handle logout
            function handleLogout() {
                currentUser = null;
                localStorage.removeItem('redGlassUser');
                showAuthInterface();
                showMessage('Successfully signed out', 'success');
            }

            // Handle account deletion
            async function handleDeleteAccount() {
                if (!currentUser) return;

                try {
                    const response = await deleteUserAccount(currentUser._id);

                    if (response.success) {
                        currentUser = null;
                        localStorage.removeItem('redGlassUser');
                        showAuthInterface();
                        showMessage('Account deleted successfully', 'success');
                    } else {
                        showMessage('Failed to delete account. Please try again.', 'error');
                    }
                } catch (error) {
                    console.error('Delete account error:', error);
                    showMessage('Network error. Please try again.', 'error');
                }
            }

            // API call to authenticate user
            async function authenticateUser(loginData) {
                // For now, simulate API call - replace with actual MongoDB integration
                return new Promise((resolve) => {
                    setTimeout(() => {
                        // Simulate authentication logic
                        if (loginData.email === 'demo@redglass.ai' && loginData.password === 'demo123') {
                            resolve({
                                success: true,
                                user: {
                                    _id: '12345',
                                    fullName: 'Demo User',
                                    email: 'demo@redglass.ai',
                                    createdAt: new Date()
                                }
                            });
                        } else {
                            resolve({
                                success: false,
                                error: 'Invalid email or password'
                            });
                        }
                    }, 1000);
                });
            }

            // API call to register user
            async function registerUser(registerData) {
                // For now, simulate API call - replace with actual MongoDB integration
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({
                            success: true,
                            user: {
                                _id: Date.now().toString(),
                                fullName: registerData.fullName,
                                email: registerData.email,
                                createdAt: new Date()
                            }
                        });
                    }, 1500);
                });
            }

            // API call to delete user account
            async function deleteUserAccount(userId) {
                // For now, simulate API call - replace with actual MongoDB integration
                return new Promise((resolve) => {
                    setTimeout(() => {
                        resolve({ success: true });
                    }, 1000);
                });
            }

            // Check authentication status on app load
            function checkAuthStatus() {
                const savedUser = localStorage.getItem('redGlassUser');
                if (savedUser) {
                    try {
                        currentUser = JSON.parse(savedUser);
                        showUserProfile();
                    } catch (error) {
                        console.error('Error parsing saved user:', error);
                        localStorage.removeItem('redGlassUser');
                        showAuthInterface();
                    }
                } else {
                    showAuthInterface();
                }
            }

            // Show authentication interface
            function showAuthInterface() {
                authInterface.style.display = 'block';
                userProfile.classList.remove('active');
                clearForms();
            }

            // Show user profile
            function showUserProfile() {
                if (!currentUser) return;

                authInterface.style.display = 'none';
                userProfile.classList.add('active');

                // Update profile information
                const initials = currentUser.fullName
                    .split(' ')
                    .map(name => name[0])
                    .join('')
                    .toUpperCase()
                    .slice(0, 2);

                if (userAvatar) userAvatar.textContent = initials;
                if (userName) userName.textContent = currentUser.fullName;
                if (userEmail) userEmail.textContent = currentUser.email;

                // Save user to localStorage for persistence
                localStorage.setItem('redGlassUser', JSON.stringify(currentUser));
            }

            // Set button loading state
            function setButtonLoading(button, loading) {
                if (loading) {
                    button.disabled = true;
                    button.innerHTML = '<span class="loading-spinner"></span>Loading...';
                } else {
                    button.disabled = false;
                    button.innerHTML = button.id.includes('login') ? 'Sign In' : 'Create Account';
                }
            }

            // Show error or success messages
            function showMessage(message, type) {
                clearMessages();

                const messageElement = type === 'error' ? authError : authSuccess;
                messageElement.textContent = message;
                messageElement.style.display = 'block';

                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        messageElement.style.display = 'none';
                    }, 5000);
                }
            }

            // Clear all messages
            function clearMessages() {
                authError.style.display = 'none';
                authSuccess.style.display = 'none';
            }

            // Clear form fields
            function clearForms() {
                loginForm.reset();
                registerForm.reset();
                clearMessages();
            }

            // Get user information for other parts of the app
            function getCurrentUser() {
                return currentUser;
            }

            // Check if user is authenticated
            function isAuthenticated() {
                return currentUser !== null;
            }

            // ================================
            // ENHANCED WORKFLOWS FUNCTIONALITY
            // ================================

            // Workflow management variables
            let currentWorkflows = [];
            let isWorkflowModalOpen = false;
            let editingWorkflowId = null;

            // ===== WORKFLOWS SYSTEM =====
            // Workflow Storage (declared at top of file)

            // Workflow DOM Elements
            const workflowNameInput = document.getElementById('workflow-name-input');
            const workflowTriggerSelect = document.getElementById('workflow-trigger-select');
            const workflowTriggerCriteria = document.getElementById('workflow-trigger-criteria');
            const workflowActionSelect = document.getElementById('workflow-action-select');
            const workflowActionDetails = document.getElementById('workflow-action-details');
            const triggerCriteriaField = document.getElementById('trigger-criteria-field');
            const actionDetailsField = document.getElementById('action-details-field');
            const workflowSaveBtn = document.getElementById('workflow-save-btn');
            const workflowClearBtn = document.getElementById('workflow-clear-btn');
            const workflowsList = document.getElementById('workflows-list');

            // Initialize workflows functionality
            async function initializeWorkflows() {
                setupWorkflowEventListeners();
                renderWorkflows();
            }

            // Action definitions by trigger type
            const triggerActions = {
                'chat_message': [
                    { value: 'summarize_message', label: 'Summarize My Message', description: 'Create a brief summary' },
                    { value: 'elaborate', label: 'Elaborate on My Message', description: 'Expand with more details' },
                    { value: 'generate_email', label: 'Draft Email', description: 'Convert to professional email' },
                    { value: 'fix_grammar', label: 'Fix Grammar & Style', description: 'Improve writing quality' },
                    { value: 'translate', label: 'Translate', description: 'Translate to another language' },
                    { value: 'extract_action_items', label: 'Extract Action Items', description: 'Find tasks and to-dos' }
                ],
                'manual': [
                    { value: 'summarize_conversation', label: 'Summarize Conversation', description: 'Summary of last 5 messages' },
                    { value: 'generate_report', label: 'Generate Report', description: 'Create detailed report' },
                    { value: 'custom_prompt', label: 'Custom AI Prompt', description: 'Run your own prompt' }
                ]
            };

            // Setup Event Listeners
            function setupWorkflowEventListeners() {
                // Show/hide trigger criteria field and update actions
                workflowTriggerSelect.addEventListener('change', () => {
                    const trigger = workflowTriggerSelect.value;

                    // Show criteria field only for chat_message trigger
                    if (trigger === 'chat_message') {
                        triggerCriteriaField.style.display = 'block';
                    } else {
                        triggerCriteriaField.style.display = 'none';
                        workflowTriggerCriteria.value = '';
                    }

                    // Update available actions based on trigger
                    updateActionOptions(trigger);
                });

                // Show/hide action details field
                workflowActionSelect.addEventListener('change', () => {
                    const action = workflowActionSelect.value;
                    actionDetailsField.style.display = action ? 'block' : 'none';
                });

                // Save workflow
                workflowSaveBtn.addEventListener('click', saveWorkflow);

                // Clear form
                workflowClearBtn.addEventListener('click', clearWorkflowForm);
            }

            // Update action dropdown based on trigger type
            function updateActionOptions(trigger) {
                workflowActionSelect.innerHTML = '<option value="">Select action...</option>';

                if (trigger && triggerActions[trigger]) {
                    triggerActions[trigger].forEach(action => {
                        const option = document.createElement('option');
                        option.value = action.value;
                        option.textContent = action.label;
                        option.title = action.description;
                        workflowActionSelect.appendChild(option);
                    });
                }

                // Reset action details
                workflowActionSelect.value = '';
                actionDetailsField.style.display = 'none';
                workflowActionDetails.value = '';
            }

            // Save Workflow
            function saveWorkflow() {
                const name = workflowNameInput.value.trim();
                const trigger = workflowTriggerSelect.value;
                const triggerCriteria = workflowTriggerCriteria.value.trim();
                const action = workflowActionSelect.value;
                const actionDetails = workflowActionDetails.value.trim();

                if (!name) {
                    alert('Please enter a workflow name');
                    return;
                }

                if (!trigger) {
                    alert('Please select a trigger');
                    return;
                }

                if (!action) {
                    alert('Please select an action');
                    return;
                }

                const workflow = {
                    id: Date.now(),
                    name,
                    trigger,
                    triggerCriteria,
                    action,
                    actionDetails,
                    enabled: true,
                    createdAt: new Date().toISOString()
                };

                workflows.push(workflow);
                localStorage.setItem('redGlassWorkflows', JSON.stringify(workflows));

                renderWorkflows();
                clearWorkflowForm();

                // Show success message
                addMessage(`Workflow "${name}" created successfully!`, 'ai', true);
            }

            // Clear Workflow Form
            function clearWorkflowForm() {
                workflowNameInput.value = '';
                workflowTriggerSelect.value = '';
                workflowTriggerCriteria.value = '';
                workflowActionSelect.value = '';
                workflowActionDetails.value = '';
                triggerCriteriaField.style.display = 'none';
                actionDetailsField.style.display = 'none';
            }

            // Render Workflows
            function renderWorkflows() {
                if (workflows.length === 0) {
                    workflowsList.innerHTML = `
                    <div class="workflow-empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12h2a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h4a2 2 0 0 0 2-2v-4a2 2 0 0 1 2-2h2"></path>
                            <path d="M2 12h2a2 2 0 0 0 2-2V6a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 0 2 2h2"></path>
                        </svg>
                        <p>No workflows yet. Create your first workflow above!</p>
                    </div>
                `;
                    return;
                }

                workflowsList.innerHTML = workflows.map(workflow => {
                    const triggerLabels = {
                        'chat_message': 'Chat Message Sent',
                        'manual': 'Manual Trigger',
                        'schedule_daily': 'Daily Schedule',
                        'schedule_weekly': 'Weekly Schedule',
                        'file_upload': 'File Uploaded',
                        'screen_capture': 'Screen Captured'
                    };

                    const actionLabels = {
                        'summarize': 'Summarize Content',
                        'generate_email': 'Generate Email',
                        'generate_report': 'Generate Report',
                        'extract_data': 'Extract Key Data',
                        'translate': 'Translate Text',
                        'analyze_sentiment': 'Analyze Sentiment',
                        'custom_prompt': 'Custom AI Prompt'
                    };

                    return `
                    <div class="workflow-list-item">
                        <div class="workflow-list-item-header">
                            <div class="workflow-list-item-name">${workflow.name}</div>
                            <div class="workflow-list-item-actions">
                                <button class="workflow-action-icon" onclick="runWorkflow(${workflow.id})" title="Run">â–¶</button>
                                <button class="workflow-action-icon delete" onclick="deleteWorkflow(${workflow.id})" title="Delete">ðŸ—‘</button>
                            </div>
                        </div>
                        <div class="workflow-list-item-trigger">Trigger: ${triggerLabels[workflow.trigger] || workflow.trigger}</div>
                        <div class="workflow-list-item-action">Action: ${actionLabels[workflow.action] || workflow.action}</div>
                    </div>
                `;
                }).join('');
            }

            // Get action label for display
            function getActionLabel(actionValue) {
                for (const trigger in triggerActions) {
                    const action = triggerActions[trigger].find(a => a.value === actionValue);
                    if (action) return action.label.toLowerCase();
                }
                return 'process this';
            }

            // Run Workflow (called manually via play button)
            async function runWorkflow(workflowId, messageContext = null) {
                // Use the new animation-enabled function
                await runWorkflowWithAnimation(workflowId, messageContext);
                // Clear pending workflow
                window.pendingWorkflow = null;
            }

            // Delete Workflow
            function deleteWorkflow(workflowId) {
                if (!confirm('Are you sure you want to delete this workflow?')) return;

                workflows = workflows.filter(w => w.id !== workflowId);
                localStorage.setItem('redGlassWorkflows', JSON.stringify(workflows));
                renderWorkflows();
            }

            // Check if message triggers any workflow - returns true if workflow triggered
            async function checkWorkflowTriggers(message) {
                console.log('ðŸ” [Workflow Trigger] Checking message:', message);
                const messageLower = message.toLowerCase();

                // Combine local workflows and backend workflows
                let allWorkflows = [...workflows];
                console.log('ðŸ” [Workflow Trigger] Local workflows:', workflows.length);

                // Try to get workflows from backend
                try {
                    const result = await window.electronAPI.invoke('workflow-list');
                    const backendWorkflows = result?.workflows || [];
                    console.log('ðŸ” [Workflow Trigger] Backend workflows:', backendWorkflows.length);
                    if (backendWorkflows && Array.isArray(backendWorkflows)) {
                        // Add backend workflows that aren't already in local list
                        for (const bw of backendWorkflows) {
                            if (!allWorkflows.find(w => w.id === bw.id)) {
                                allWorkflows.push(bw);
                            }
                        }
                    }
                } catch (e) {
                    console.log('ðŸ” [Workflow Trigger] Could not fetch backend workflows:', e);
                }

                console.log('ðŸ” [Workflow Trigger] Total workflows to check:', allWorkflows.length);

                for (const workflow of allWorkflows) {
                    console.log('ðŸ” [Workflow Trigger] Checking workflow:', workflow.name, 'enabled:', workflow.enabled, 'trigger:', JSON.stringify(workflow.trigger));

                    // Skip disabled workflows
                    if (!workflow.enabled) {
                        console.log('ðŸ” [Workflow Trigger] Skipping disabled workflow:', workflow.name);
                        continue;
                    }

                    let keywords = [];
                    let isKeywordTrigger = false;

                    // Check NEW format from workflow-builder: trigger.type === 'keyword'
                    if (workflow.trigger && typeof workflow.trigger === 'object') {
                        if (workflow.trigger.type === 'keyword' && workflow.trigger.keywords) {
                            keywords = workflow.trigger.keywords;
                            isKeywordTrigger = true;
                            console.log('ðŸ” [Workflow Trigger] Found keyword trigger with keywords:', keywords);
                        }
                    }
                    // Check OLD format: trigger === 'chat_message' with triggerCriteria
                    else if (workflow.trigger === 'chat_message' && workflow.triggerCriteria) {
                        keywords = workflow.triggerCriteria.split(/[,\n]/).map(k => k.trim()).filter(k => k);
                        isKeywordTrigger = true;
                        console.log('ðŸ” [Workflow Trigger] Found chat_message trigger with criteria:', keywords);
                    }

                    if (!isKeywordTrigger || keywords.length === 0) {
                        console.log('ðŸ” [Workflow Trigger] No keyword trigger found for:', workflow.name);
                        continue;
                    }

                    // Check if any keyword matches the message
                    const matches = keywords.some(keyword => messageLower.includes(keyword.toLowerCase()));
                    console.log('ðŸ” [Workflow Trigger] Keyword match result:', matches, 'for message:', messageLower);

                    if (matches) {
                        console.log(`âœ… Workflow "${workflow.name}" triggered by keyword match`);
                        // Run workflow immediately with animation
                        runWorkflowWithAnimation(workflow.id, message);
                        return true; // Workflow triggered - stop normal processing
                    }
                }

                console.log('ðŸ” [Workflow Trigger] No workflow triggered');
                return false; // No workflow triggered
            }

            // Run workflow with visual animation in chat
            async function runWorkflowWithAnimation(workflowId, messageContext = null) {
                // Try to find in local workflows first, then fetch from backend
                let workflow = workflows.find(w => w.id === workflowId);

                // Also try to get from workflow executor (backend)
                if (!workflow) {
                    try {
                        const result = await window.electronAPI.invoke('workflow-list');
                        const backendWorkflows = result?.workflows || [];
                        if (backendWorkflows.length > 0) {
                            workflow = backendWorkflows.find(w => w.id === workflowId);
                        }
                    } catch (e) {
                        console.log('Could not fetch from backend:', e);
                    }
                }

                if (!workflow) {
                    console.error('Workflow not found:', workflowId);
                    return;
                }

                console.log('ðŸ”„ Running workflow with animation:', workflow.name);

                // Show workflow indicator in chat
                const workflowIndicator = addWorkflowIndicator(workflow.name);

                try {
                    // Get the message to process
                    let userMessage = messageContext;
                    if (!userMessage) {
                        const messages = conversationView.querySelectorAll('.message.user-message');
                        if (messages.length > 0) {
                            const lastUserMsg = messages[messages.length - 1];
                            userMessage = lastUserMsg.querySelector('.text-content')?.textContent || '';
                        }
                    }

                    let prompt = '';

                    // Check if workflow has NEW format (actions array from workflow-builder)
                    if (workflow.actions && workflow.actions.length > 0) {
                        // Execute through backend workflow executor
                        console.log('ðŸ“¤ Executing workflow via backend:', workflow.name);

                        try {
                            const result = await window.electronAPI.invoke('workflow-execute', { id: workflowId, context: { message: userMessage } });

                            // Mark indicator as complete
                            markWorkflowComplete(workflowIndicator, result?.success !== false);

                            // Show result in chat if there's an AI response
                            const executionResults = result?.execution?.results || [];
                            console.log('ðŸ“‹ Workflow execution results:', executionResults.length);

                            for (const actionResult of executionResults) {
                                // Check for AI prompt response
                                if (actionResult.result?.response) {
                                    console.log('ðŸ“ Adding AI response to chat:', actionResult.result.response.substring(0, 50) + '...');
                                    const messageElement = document.createElement('div');
                                    messageElement.classList.add('message', 'ai-message');

                                    const textContent = document.createElement('span');
                                    textContent.classList.add('text-content', 'typewriter-text');
                                    textContent.innerHTML = '';
                                    messageElement.appendChild(textContent);

                                    conversationView.appendChild(messageElement);
                                    typewriterEffect(textContent, renderMarkdown(actionResult.result.response));
                                    scrollToBottom();
                                }
                            }

                            console.log('âœ… Workflow completed via backend');
                            return;
                        } catch (error) {
                            console.error('Backend workflow execution failed:', error);
                            // Fall through to try frontend execution
                        }
                    }

                    // OLD format: use workflow.action and workflow.actionDetails
                    const details = workflow.actionDetails || '';

                    switch (workflow.action) {
                        case 'summarize_message':
                            prompt = `Please provide a brief summary of this message:\n\n"${userMessage}"\n\n${details}`;
                            break;
                        case 'elaborate':
                            prompt = `Please elaborate on this message with more details and context:\n\n"${userMessage}"\n\n${details}`;
                            break;
                        case 'generate_email':
                            prompt = `Convert this message into a professional email:\n\n"${userMessage}"\n\n${details || 'Make it clear, professional, and well-structured.'}`;
                            break;
                        case 'fix_grammar':
                            prompt = `Please fix the grammar and improve the writing style of this message:\n\n"${userMessage}"\n\n${details}`;
                            break;
                        case 'translate':
                            prompt = `Translate this message:\n\n"${userMessage}"\n\nTarget language: ${details || 'Spanish'}`;
                            break;
                        case 'extract_action_items':
                            prompt = `Extract all action items, tasks, and to-dos from this message:\n\n"${userMessage}"\n\n${details}`;
                            break;
                        case 'custom_prompt':
                            prompt = details ? details.replace('{{message}}', userMessage) : userMessage;
                            break;
                        default:
                            prompt = userMessage;
                    }

                    console.log('ðŸ“¤ Workflow sending prompt to API');

                    // Mark indicator as complete before getting response
                    setTimeout(() => {
                        markWorkflowComplete(workflowIndicator, true);
                    }, 500);

                    // Execute workflow through AI Text API
                    const history = getConversationHistory();
                    const res = await window.electronAPI.callAiText(prompt, null, undefined, history);

                    if (res?.success) {
                        // Add AI response to chat
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message', 'ai-message');

                        const textContent = document.createElement('span');
                        textContent.classList.add('text-content', 'typewriter-text');
                        textContent.innerHTML = '';
                        messageElement.appendChild(textContent);

                        conversationView.appendChild(messageElement);
                        typewriterEffect(textContent, renderMarkdown(res.response));
                    }

                    console.log('âœ… Workflow completed');

                } catch (error) {
                    console.error('âŒ Workflow error:', error);
                    markWorkflowComplete(workflowIndicator, false);
                    addMessage(`âŒ Workflow failed: ${error.message || 'Unknown error'}`, 'ai', false, false);
                }
            }

            // Offer workflow execution with confirmation
            function offerWorkflowExecution(workflowId, userMessage) {
                const workflow = workflows.find(w => w.id === workflowId);
                if (!workflow) return;

                // Get action label
                const actionLabel = getActionLabel(workflow.action);

                // Create confirmation message in chat
                const confirmMessage = `ðŸ¤– I can ${actionLabel} for you. Would you like me to do that?`;
                addMessage(confirmMessage, 'ai', false, false);

                // Store pending workflow for execution
                window.pendingWorkflow = { id: workflowId, message: userMessage };
            }

            // Evaluate trigger criteria using Gemini Live
            async function evaluateTriggerCriteria(message, criteria) {
                try {
                    const prompt = `Does this message match the following criteria? Answer only "yes" or "no".\n\nMessage: "${message}"\nCriteria: "${criteria}"`;

                    // For trigger evaluation, we'll use a simplified approach
                    // In a full implementation, you might want to create a separate evaluation endpoint
                    // For now, we'll use basic pattern matching as fallback
                    const lowerMessage = message.toLowerCase();
                    const lowerCriteria = criteria.toLowerCase();

                    // Simple keyword matching as fallback
                    const criteriaWords = lowerCriteria.split(/\s+/);
                    const matchCount = criteriaWords.filter(word => lowerMessage.includes(word)).length;
                    const matchRatio = matchCount / criteriaWords.length;

                    console.log('ðŸ” Trigger evaluation (pattern matching):', { message, criteria, matchRatio });

                    // Consider it a match if more than 50% of criteria words are found
                    return matchRatio > 0.5;
                } catch (error) {
                    console.error('âŒ Trigger evaluation error:', error);
                    return false;
                }
            }

            // Legacy workflow functions removed - using new simple workflow system

            // Make workflow functions globally available for onclick handlers
            window.runWorkflow = runWorkflow;
            window.deleteWorkflow = deleteWorkflow;

            // Initialize app when the page loads
            document.addEventListener('DOMContentLoaded', () => {
                initializeAuth();
                initializeWorkflows();
                initializeChat();
            });

            // Initialize immediately if DOM is already loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    initializeAuth();
                    initializeWorkflows();
                    initializeChat();
                });
            } else {
                initializeAuth();
                initializeWorkflows();
                initializeChat();
            }

            // Initialize chat system
            function initializeChat() {
                if (!currentChatId) {
                    currentChatId = generateChatId();
                }
            }

            // ============================================
            // Settings System
            // ============================================

            // Initialize account settings when window opens
            function initializeSettings() {
                console.log('ðŸ”§ ===== INITIALIZING SETTINGS WINDOW =====');

                // Check if the settings content container exists
                const settingsContainer = document.querySelector('.account-settings-content');
                console.log('ðŸ”§ Settings container exists?', !!settingsContainer);
                if (!settingsContainer) {
                    console.error('âŒ Settings container not found');
                    return;
                }

                // ALWAYS attach login button handler first (in case form is visible)
                attachLoginHandlers();

                console.log('ðŸ”§ Calling loadAccountData...');
                loadAccountData();

                // Set up event listeners after a small delay to ensure DOM is ready
                setTimeout(() => {
                    setupAccountEventListeners();
                }, 100);
            }

            // Attach login form handlers
            function attachLoginHandlers() {
                const loginBtn = document.getElementById('settings-login-btn');
                const emailInput = document.getElementById('settings-login-email');
                const passwordInput = document.getElementById('settings-login-password');

                console.log('ðŸ”§ Attaching login handlers...', {
                    loginBtn: !!loginBtn,
                    emailInput: !!emailInput,
                    passwordInput: !!passwordInput
                });

                if (loginBtn && !loginBtn.hasAttribute('data-listener-added')) {
                    console.log('âœ… Adding click listener to login button');
                    loginBtn.addEventListener('click', handleSettingsLogin);
                    loginBtn.setAttribute('data-listener-added', 'true');
                }

                if (emailInput && !emailInput.hasAttribute('data-listener-added')) {
                    emailInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleSettingsLogin();
                    });
                    emailInput.setAttribute('data-listener-added', 'true');
                }

                if (passwordInput && !passwordInput.hasAttribute('data-listener-added')) {
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') handleSettingsLogin();
                    });
                    passwordInput.setAttribute('data-listener-added', 'true');
                }
            }

            // Load account data from MongoDB
            async function loadAccountData() {
                try {
                    console.log('ðŸ” Loading account data...');

                    // First check OAuth authentication (primary auth system)
                    const oauthResult = await window.electronAPI.authGetCurrentUser();
                    if (oauthResult && oauthResult.user) {
                        console.log('âœ… OAuth user found, using loadUserData instead');
                        // OAuth user exists, let loadUserData handle the UI (already called or will be called)
                        if (window.loadUserData) {
                            await window.loadUserData();
                        }
                        return;
                    }

                    // Check if user is logged in via the subscription system (fallback)
                    const subscriptionResult = await window.electronAPI.subscriptionGet();

                    if (!subscriptionResult.success || !subscriptionResult.user) {
                        console.warn('âŒ No authenticated user found - showing login form');
                        displayLoginPrompt();
                        return;
                    }

                    console.log('âœ… User is logged in:', subscriptionResult.user.email);

                    // Show loading state only if user IS logged in
                    showAccountLoading();

                    // User is logged in, fetch full user data
                    const result = await window.electronAPI.invoke('mongodb-get-user-by-email', subscriptionResult.user.email);

                    if (result.success && result.user) {
                        displayAccountData(result.user);
                    } else {
                        console.error('Failed to load account data:', result.error);
                        displayAccountError(result.error || 'Failed to load account information');
                    }
                } catch (error) {
                    console.error('Error loading account data:', error);
                    displayAccountError('Failed to connect to account service');
                }
            }

            // Hide login form and show account sections
            function hideLoginPrompt() {
                console.log('ðŸ“ Hiding login form, showing account sections');

                const loginForm = document.getElementById('settings-login-form');
                if (loginForm) {
                    loginForm.style.display = 'none';
                }

                const accountSections = document.querySelectorAll('.account-section');
                accountSections.forEach(section => {
                    section.style.display = 'block';
                });
            }

            // Display account data in the UI
            function displayAccountData(user) {
                console.log('âœ… Displaying account data for:', user.email);

                // Hide login prompt and show account sections
                hideLoginPrompt();

                // Support both fullName (app) and name (landing page) fields
                const userName = user.fullName || user.name || 'Unknown User';

                // Update header
                document.getElementById('account-name').textContent = userName;
                document.getElementById('account-email').textContent = user.email || 'No email';

                // Update account information
                document.getElementById('display-full-name').textContent = userName;
                document.getElementById('display-email').textContent = user.email || 'Not set';

                // Format dates
                const memberSince = user.createdAt ? new Date(user.createdAt).toLocaleDateString('en-GB', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }) : 'Unknown';
                document.getElementById('member-since').textContent = memberSince;

                const lastLogin = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString('en-GB', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'Never';
                document.getElementById('last-login').textContent = lastLogin;

                // Update subscription information (support both formats)
                // Landing page uses 'plan' field, app uses 'subscription.tier'
                let tierName = 'free';
                if (user.subscription && user.subscription.tier) {
                    tierName = user.subscription.tier;
                } else if (user.plan) {
                    // Map landing page plan names to app tier names
                    const planMap = {
                        'Free': 'free',
                        'Test Plan': 'free',
                        'Super Red': 'super-red',
                        'Ultimate Red': 'ultra-red'
                    };
                    tierName = planMap[user.plan] || 'free';
                }

                const subscription = user.subscription || { tier: tierName, status: 'active' };
                const tierDisplayName = subscription.tier.split('-').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                ).join(' ');

                document.getElementById('subscription-tier').textContent = tierDisplayName + ' Plan';
                document.getElementById('subscription-status').textContent = subscription.status.charAt(0).toUpperCase() + subscription.status.slice(1);

                // Update status indicator
                const statusElement = document.getElementById('account-status');
                const statusText = statusElement.querySelector('.status-text');
                statusText.textContent = tierDisplayName + ' Plan';

                // Update usage statistics
                const usage = user.usage || {
                    totalMessages: 0,
                    messagesUsedToday: 0,
                    totalTranscriptions: 0,
                    transcriptionMinutesUsed: 0,
                    storageUsed: 0,
                    activeWorkflows: 0
                };
                document.getElementById('messages-used').textContent = subscription.tier === 'free' ? `${usage.messagesUsedToday || usage.totalMessages} / 20` : `${usage.messagesUsedToday || usage.totalMessages}`;
                document.getElementById('transcriptions-used').textContent = (usage.transcriptionMinutesUsed || usage.totalTranscriptions || 0).toString();
                document.getElementById('storage-used').textContent = `${(usage.storageUsed / (1024 * 1024)).toFixed(1)} MB`;
            }

            // Show loading state
            function showAccountLoading() {
                const loadingText = 'Loading...';
                const accountName = document.getElementById('account-name');
                const accountEmail = document.getElementById('account-email');
                const displayFullName = document.getElementById('display-full-name');
                const displayEmail = document.getElementById('display-email');
                const memberSince = document.getElementById('member-since');
                const lastLogin = document.getElementById('last-login');

                if (accountName) accountName.textContent = loadingText;
                if (accountEmail) accountEmail.textContent = loadingText;
                if (displayFullName) displayFullName.textContent = loadingText;
                if (displayEmail) displayEmail.textContent = loadingText;
                if (memberSince) memberSince.textContent = loadingText;
                if (lastLogin) lastLogin.textContent = loadingText;
            }

            // Display error message
            function displayAccountError(message) {
                document.getElementById('account-name').textContent = 'Error';
                document.getElementById('account-email').textContent = message;
                document.getElementById('display-full-name').textContent = 'Error loading data';
                document.getElementById('display-email').textContent = 'Error loading data';
                document.getElementById('member-since').textContent = 'Error loading data';
                document.getElementById('last-login').textContent = 'Error loading data';
            }

            // Display login prompt when not authenticated
            function displayLoginPrompt() {
                console.log('ðŸ“ Showing login form');

                // Update header
                const accountName = document.getElementById('account-name');
                const accountEmail = document.getElementById('account-email');
                if (accountName) accountName.textContent = 'Not Signed In';
                if (accountEmail) accountEmail.textContent = 'Please sign in to continue';

                // Show login form, hide account sections
                const loginForm = document.getElementById('settings-login-form');
                const accountSections = document.querySelectorAll('.account-section');

                if (loginForm) {
                    loginForm.style.display = 'block';
                    console.log('âœ… Login form shown');
                }

                accountSections.forEach(section => {
                    section.style.display = 'none';
                });
            }

            // Handle login from settings page (GLOBAL function for onclick)
            window.handleSettingsLogin = async function () {
                console.log('ðŸ” ===== LOGIN BUTTON CLICKED =====');

                const email = document.getElementById('settings-login-email');
                const password = document.getElementById('settings-login-password');
                const errorDiv = document.getElementById('settings-login-error');
                const loginBtn = document.getElementById('settings-login-btn');

                console.log('ðŸ” Form elements found:', {
                    email: !!email,
                    password: !!password,
                    errorDiv: !!errorDiv,
                    loginBtn: !!loginBtn
                });

                if (!email || !password) {
                    console.error('âŒ Login form elements not found');
                    return;
                }

                const emailValue = email.value.trim();
                const passwordValue = password.value;

                if (!emailValue || !passwordValue) {
                    errorDiv.textContent = 'Please enter both email and password';
                    errorDiv.style.display = 'block';
                    return;
                }

                // Disable button and show loading
                loginBtn.disabled = true;
                loginBtn.textContent = 'Signing in...';
                errorDiv.style.display = 'none';

                try {
                    console.log('ðŸ” Attempting to authenticate:', emailValue);
                    const result = await window.electronAPI.mongodbAuthenticate(emailValue, passwordValue);

                    if (result.success) {
                        console.log('âœ… Authentication successful!');
                        loginBtn.textContent = 'âœ“ Success! Loading...';

                        // Small delay to show success state
                        await new Promise(resolve => setTimeout(resolve, 300));

                        // Reload the settings page to show dashboard
                        console.log('ðŸ”„ Reloading settings to show dashboard...');
                        initializeSettings();
                    } else {
                        console.error('âŒ Authentication failed:', result.error);
                        errorDiv.textContent = result.error || 'Invalid email or password';
                        errorDiv.style.display = 'block';
                        loginBtn.disabled = false;
                        loginBtn.textContent = 'Sign In';
                    }
                } catch (error) {
                    console.error('âŒ Login error:', error);
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.style.display = 'block';
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Sign In';
                }
            }; // End of window.handleSettingsLogin

            // Setup event listeners for account actions
            function setupAccountEventListeners() {
                // Edit name functionality
                const editNameBtn = document.getElementById('edit-name-btn');
                const displayFullName = document.getElementById('display-full-name');
                const editFullNameInput = document.getElementById('edit-full-name');

                editNameBtn?.addEventListener('click', () => {
                    displayFullName.style.display = 'none';
                    editNameBtn.style.display = 'none';
                    editFullNameInput.style.display = 'block';
                    editFullNameInput.value = displayFullName.textContent;
                    editFullNameInput.focus();
                    showSaveButtons();
                });

                // Edit email functionality
                const editEmailBtn = document.getElementById('edit-email-btn');
                const displayEmail = document.getElementById('display-email');
                const editEmailInput = document.getElementById('edit-email');

                editEmailBtn?.addEventListener('click', () => {
                    displayEmail.style.display = 'none';
                    editEmailBtn.style.display = 'none';
                    editEmailInput.style.display = 'block';
                    editEmailInput.value = displayEmail.textContent;
                    editEmailInput.focus();
                    showSaveButtons();
                });

                // Save changes
                const saveChangesBtn = document.getElementById('save-changes-btn');
                saveChangesBtn?.addEventListener('click', async () => {
                    await saveAccountChanges();
                });

                // Cancel changes
                const cancelChangesBtn = document.getElementById('cancel-changes-btn');
                cancelChangesBtn?.addEventListener('click', () => {
                    cancelAccountChanges();
                });

                // Refresh account
                const refreshAccountBtn = document.getElementById('refresh-account-btn');
                refreshAccountBtn?.addEventListener('click', () => {
                    loadAccountData();
                });

                // Logout button
                const logoutBtn = document.getElementById('logout-btn');
                logoutBtn?.addEventListener('click', async () => {
                    const confirmed = await customConfirm({
                        title: 'Log Out',
                        message: 'Are you sure you want to log out?',
                        confirmText: 'Log Out',
                        type: 'info'
                    });
                    
                    if (confirmed) {
                        await handleSettingsLogout();
                    }
                });

                // Delete account
                const deleteAccountBtn = document.getElementById('delete-account-btn');
                deleteAccountBtn?.addEventListener('click', () => {
                    confirmDeleteAccount();
                });
            }

            // Handle logout from settings page
            async function handleSettingsLogout() {
                try {
                    await window.electronAPI.mongodbLogout();
                    showNotification('Logged out successfully', 'success');
                    // Reload to show login form
                    loadAccountData();
                } catch (error) {
                    console.error('Logout error:', error);
                    showNotification('Error logging out', 'error');
                }
            }

            // Show save/cancel buttons
            function showSaveButtons() {
                document.getElementById('save-changes-btn').style.display = 'flex';
                document.getElementById('cancel-changes-btn').style.display = 'flex';
            }

            // Hide save/cancel buttons
            function hideSaveButtons() {
                document.getElementById('save-changes-btn').style.display = 'none';
                document.getElementById('cancel-changes-btn').style.display = 'none';
            }

            // Save account changes
            async function saveAccountChanges() {
                try {
                    // Get current user first
                    const subscriptionResult = await window.electronAPI.subscriptionGet();
                    if (!subscriptionResult.success || !subscriptionResult.user) {
                        alert('Not logged in');
                        return;
                    }

                    // Get user ID via email
                    const userResult = await window.electronAPI.invoke('mongodb-get-user-by-email', subscriptionResult.user.email);
                    if (!userResult.success || !userResult.user) {
                        alert('Failed to get user information');
                        return;
                    }

                    const editFullNameInput = document.getElementById('edit-full-name');
                    const editEmailInput = document.getElementById('edit-email');

                    const updates = {};

                    if (editFullNameInput.style.display === 'block') {
                        updates.fullName = editFullNameInput.value.trim();
                    }

                    if (editEmailInput.style.display === 'block') {
                        updates.email = editEmailInput.value.trim();
                    }

                    if (Object.keys(updates).length === 0) {
                        cancelAccountChanges();
                        return;
                    }

                    // Validate email if being updated
                    if (updates.email && !isValidEmail(updates.email)) {
                        alert('Please enter a valid email address');
                        return;
                    }

                    // Update via MongoDB service
                    const result = await window.electronAPI.invoke('mongodb-update-user', userResult.user._id, updates);

                    if (result.success) {
                        // Refresh display
                        loadAccountData();
                        cancelAccountChanges();

                        // Show success message
                        showNotification('Account updated successfully', 'success');
                    } else {
                        console.error('Failed to update account:', result.error);
                        alert('Failed to update account: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error saving account changes:', error);
                    alert('Failed to save changes. Please try again.');
                }
            }

            // Cancel account changes
            function cancelAccountChanges() {
                // Hide input fields and show display values
                const displayFullName = document.getElementById('display-full-name');
                const editFullNameInput = document.getElementById('edit-full-name');
                const editNameBtn = document.getElementById('edit-name-btn');

                displayFullName.style.display = 'block';
                editFullNameInput.style.display = 'none';
                editNameBtn.style.display = 'flex';

                const displayEmail = document.getElementById('display-email');
                const editEmailInput = document.getElementById('edit-email');
                const editEmailBtn = document.getElementById('edit-email-btn');

                displayEmail.style.display = 'block';
                editEmailInput.style.display = 'none';
                editEmailBtn.style.display = 'flex';

                hideSaveButtons();
            }

            // Confirm account deletion
            function confirmDeleteAccount() {
                const confirmed = confirm(
                    'Are you sure you want to delete your account? This action cannot be undone and will permanently remove all your data.'
                );

                if (confirmed) {
                    const doubleConfirmed = confirm(
                        'This is your final warning. Deleting your account will permanently remove all your conversations, transcriptions, and settings. Type "DELETE" to confirm.'
                    );

                    if (doubleConfirmed) {
                        deleteAccount();
                    }
                }
            }

            // Delete account
            async function deleteAccount() {
                try {
                    const result = await window.electronAPI.invoke('mongodb-delete-user', currentUser._id);

                    if (result.success) {
                        // Clear current user
                        currentUser = null;

                        // Show success message and redirect to login
                        alert('Account deleted successfully. You will now be logged out.');

                        // Trigger logout
                        logout();
                    } else {
                        console.error('Failed to delete account:', result.error);
                        alert('Failed to delete account: ' + (result.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Failed to delete account. Please try again.');
                }
            }

            // Email validation helper
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // Show notification helper
            function showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.textContent = message;
                notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                font-weight: 600;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
            `;

                document.body.appendChild(notification);

                // Remove after 3 seconds
                setTimeout(() => {
                    notification.style.animation = 'slideOutRight 0.3s ease';
                    setTimeout(() => {
                        document.body.removeChild(notification);
                    }, 300);
                }, 3000);
            }

            async function loadAllSettings() {
                try {
                    const result = await window.electronAPI.invoke('settings-get-all');
                    if (result.success) {
                        const settings = result.settings;

                        // Load General Settings
                        document.getElementById('theme-select').value = settings.general.theme || 'system';
                        document.getElementById('fontsize-select').value = settings.general.fontSize || 'medium';
                        document.getElementById('language-select').value = settings.general.language || 'en';
                        const opacityValue = settings.general.windowOpacity !== undefined ? settings.general.windowOpacity : 0.95;
                        document.getElementById('opacity-slider').value = opacityValue;
                        document.getElementById('opacity-value').textContent = Math.round(opacityValue * 100);
                        const transparencyValue = settings.general.backgroundTransparency !== undefined ? settings.general.backgroundTransparency : 1.0;
                        document.getElementById('transparency-slider').value = transparencyValue;
                        document.getElementById('transparency-value').textContent = Math.round(transparencyValue * 100);
                        const blurValue = settings.general.backgroundBlur !== undefined ? settings.general.backgroundBlur : 60;
                        document.getElementById('blur-slider').value = blurValue;
                        document.getElementById('blur-value').textContent = blurValue;
                        document.getElementById('start-on-login').checked = settings.general.startOnLogin || false;
                        document.getElementById('minimize-to-tray').checked = settings.general.minimizeToTray || false;
                        document.getElementById('close-to-tray').checked = settings.general.closeToTray !== false;
                        document.getElementById('show-notifications').checked = settings.general.showNotifications !== false;
                        document.getElementById('auto-update').checked = settings.general.autoUpdate !== false;

                        // Load API Keys
                        document.getElementById('ai-provider-select').value = settings.apiKeys.selectedProvider || 'gemini';
                        document.getElementById('gemini-key').value = settings.apiKeys.gemini || '';
                        document.getElementById('openai-key').value = settings.apiKeys.openai || '';
                        document.getElementById('deepseek-key').value = settings.apiKeys.deepseek || '';
                        document.getElementById('gemini-model-select').value = settings.apiKeys.geminiModel || 'gemini-2.5-flash';
                        document.getElementById('openai-model-select').value = settings.apiKeys.openaiModel || 'gpt-4';
                        document.getElementById('deepseek-model-select').value = settings.apiKeys.deepseekModel || 'deepseek-chat';
                        document.getElementById('temperature-slider').value = settings.apiKeys.temperature || 0.7;
                        document.getElementById('temperature-value').textContent = settings.apiKeys.temperature || 0.7;
                        document.getElementById('max-tokens-input').value = settings.apiKeys.maxTokens || 2000;

                        // Load Audio Settings
                        document.getElementById('input-device-select').value = settings.audio.inputDevice || 'default';
                        document.getElementById('output-device-select').value = settings.audio.outputDevice || 'default';
                        document.getElementById('input-volume-slider').value = settings.audio.inputVolume || 100;
                        document.getElementById('input-volume-value').textContent = settings.audio.inputVolume || 100;
                        document.getElementById('output-volume-slider').value = settings.audio.outputVolume || 100;
                        document.getElementById('output-volume-value').textContent = settings.audio.outputVolume || 100;
                        document.getElementById('noise-reduction').checked = settings.audio.noiseReduction !== false;
                        document.getElementById('echo-cancellation').checked = settings.audio.echoCancellation !== false;
                        document.getElementById('auto-gain-control').checked = settings.audio.autoGainControl !== false;
                        document.getElementById('transcription-provider-select').value = settings.audio.transcriptionProvider || 'deepgram';
                        document.getElementById('sample-rate-select').value = settings.audio.sampleRate || '16000';

                        // Load Shortcuts
                        document.getElementById('toggle-window-shortcut').value = settings.shortcuts.toggleWindow || 'CommandOrControl+Shift+Space';
                        document.getElementById('capture-screen-shortcut').value = settings.shortcuts.captureScreen || 'CommandOrControl+Return';
                        document.getElementById('start-transcription-shortcut').value = settings.shortcuts.startTranscription || 'CommandOrControl+Shift+T';
                        document.getElementById('clear-chat-shortcut').value = settings.shortcuts.clearChat || 'CommandOrControl+K';
                        document.getElementById('focus-input-shortcut').value = settings.shortcuts.focusInput || 'CommandOrControl+L';

                        // Load Integrations
                        document.getElementById('google-calendar-enabled').checked = settings.integrations.googleCalendar?.enabled || false;
                        document.getElementById('google-sheets-enabled').checked = settings.integrations.googleSheets?.enabled || false;
                        document.getElementById('notion-enabled').checked = settings.integrations.notion?.enabled || false;
                        document.getElementById('gmail-enabled').checked = settings.integrations.gmail?.enabled || false;

                        // Load Privacy
                        document.getElementById('save-conversations').checked = settings.privacy.saveConversationHistory !== false;
                        document.getElementById('save-transcriptions').checked = settings.privacy.saveTranscriptions !== false;
                        document.getElementById('analytics-enabled').checked = settings.privacy.analyticsEnabled || false;
                        document.getElementById('crash-reports').checked = settings.privacy.crashReportsEnabled !== false;
                        document.getElementById('improve-models').checked = settings.privacy.improveModels || false;

                        // Load Advanced
                        document.getElementById('hardware-acceleration').checked = settings.advanced.hardwareAcceleration !== false;
                        document.getElementById('developer-mode').checked = settings.advanced.developerMode || false;
                        document.getElementById('log-level-select').value = settings.advanced.logLevel || 'info';
                        document.getElementById('max-cache-size').value = settings.advanced.maxCacheSize || 500;
                        document.getElementById('network-timeout').value = settings.advanced.networkTimeout || 30000;

                        // Load data statistics
                        loadDataStatistics();
                    }
                } catch (error) {
                    console.error('Error loading settings:', error);
                }
            }

            function setupGeneralSettings() {
                // Theme
                document.getElementById('theme-select').addEventListener('change', async (e) => {
                    await saveSetting('general', 'theme', e.target.value);
                });

                // Font Size
                document.getElementById('fontsize-select').addEventListener('change', async (e) => {
                    await saveSetting('general', 'fontSize', e.target.value);
                });

                // Window Opacity
                document.getElementById('opacity-slider').addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    document.getElementById('opacity-value').textContent = Math.round(value * 100);
                    // Apply opacity in real-time as user drags slider
                    applyWindowOpacity(value);
                });

                document.getElementById('opacity-slider').addEventListener('change', async (e) => {
                    const value = parseFloat(e.target.value);
                    await saveSetting('general', 'windowOpacity', value);
                });

                // Background Transparency
                document.getElementById('transparency-slider').addEventListener('input', (e) => {
                    const value = parseFloat(e.target.value);
                    document.getElementById('transparency-value').textContent = Math.round(value * 100);
                    // Apply transparency in real-time as user drags slider
                    applyBackgroundTransparency(value);
                });

                document.getElementById('transparency-slider').addEventListener('change', async (e) => {
                    const value = parseFloat(e.target.value);
                    await saveSetting('general', 'backgroundTransparency', value);
                });

                // Background Blur
                document.getElementById('blur-slider').addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    document.getElementById('blur-value').textContent = value;
                    // Apply blur in real-time as user drags slider
                    applyBackgroundBlur(value);
                });

                document.getElementById('blur-slider').addEventListener('change', async (e) => {
                    const value = parseInt(e.target.value);
                    await saveSetting('general', 'backgroundBlur', value);
                });

                // Language
                document.getElementById('language-select').addEventListener('change', async (e) => {
                    await saveSetting('general', 'language', e.target.value);
                });

                // Checkboxes
                ['start-on-login', 'minimize-to-tray', 'close-to-tray', 'show-notifications', 'auto-update'].forEach(id => {
                    document.getElementById(id).addEventListener('change', async (e) => {
                        const key = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                        await saveSetting('general', key, e.target.checked);
                    });
                });
            }

            function setupAPIKeysSettings() {
                // Provider
                document.getElementById('ai-provider-select').addEventListener('change', async (e) => {
                    await saveSetting('apiKeys', 'selectedProvider', e.target.value);
                });

                // Temperature slider
                document.getElementById('temperature-slider').addEventListener('input', (e) => {
                    document.getElementById('temperature-value').textContent = e.target.value;
                });

                document.getElementById('temperature-slider').addEventListener('change', async (e) => {
                    await saveSetting('apiKeys', 'temperature', parseFloat(e.target.value));
                });

                // Max tokens
                document.getElementById('max-tokens-input').addEventListener('change', async (e) => {
                    await saveSetting('apiKeys', 'maxTokens', parseInt(e.target.value));
                });

                // Save API Keys button
                document.getElementById('save-api-keys-btn').addEventListener('click', async () => {
                    const geminiKey = document.getElementById('gemini-key').value;
                    const openaiKey = document.getElementById('openai-key').value;
                    const deepseekKey = document.getElementById('deepseek-key').value;
                    const geminiModel = document.getElementById('gemini-model-select').value;
                    const openaiModel = document.getElementById('openai-model-select').value;
                    const deepseekModel = document.getElementById('deepseek-model-select').value;

                    try {
                        await window.electronAPI.invoke('settings-save-api-keys', { gemini: geminiKey, openai: openaiKey, deepseek: deepseekKey });
                        await saveSetting('apiKeys', 'geminiModel', geminiModel);
                        await saveSetting('apiKeys', 'openaiModel', openaiModel);
                        await saveSetting('apiKeys', 'deepseekModel', deepseekModel);

                        alert('API keys saved successfully!');
                    } catch (error) {
                        alert('Error saving API keys: ' + error.message);
                    }
                });

                // Test API button
                document.getElementById('test-api-btn').addEventListener('click', async () => {
                    alert('API connection test - Feature coming soon!');
                });
            }

            function setupAudioSettings() {
                // Volume sliders
                document.getElementById('input-volume-slider').addEventListener('input', (e) => {
                    document.getElementById('input-volume-value').textContent = e.target.value;
                });

                document.getElementById('input-volume-slider').addEventListener('change', async (e) => {
                    await saveSetting('audio', 'inputVolume', parseInt(e.target.value));
                });

                document.getElementById('output-volume-slider').addEventListener('input', (e) => {
                    document.getElementById('output-volume-value').textContent = e.target.value;
                });

                document.getElementById('output-volume-slider').addEventListener('change', async (e) => {
                    await saveSetting('audio', 'outputVolume', parseInt(e.target.value));
                });

                // Checkboxes
                ['noise-reduction', 'echo-cancellation', 'auto-gain-control'].forEach(id => {
                    document.getElementById(id).addEventListener('change', async (e) => {
                        const key = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                        await saveSetting('audio', key, e.target.checked);
                    });
                });

                // Selects
                document.getElementById('transcription-provider-select').addEventListener('change', async (e) => {
                    await saveSetting('audio', 'transcriptionProvider', e.target.value);
                });

                document.getElementById('sample-rate-select').addEventListener('change', async (e) => {
                    await saveSetting('audio', 'sampleRate', parseInt(e.target.value));
                });
            }

            function setupShortcutsSettings() {
                document.getElementById('reset-shortcuts-btn').addEventListener('click', async () => {
                    const confirmed = await customConfirm({
                        title: 'Reset Shortcuts',
                        message: 'Reset all shortcuts to defaults?',
                        confirmText: 'Reset',
                        type: 'warning'
                    });
                    
                    if (confirmed) {
                        await window.electronAPI.invoke('settings-reset-category', 'shortcuts');
                        await loadAllSettings();
                    }
                });
            }

            function setupIntegrationsSettings() {
                // Toggle integration configs
                ['google-calendar', 'google-sheets', 'notion', 'gmail'].forEach(integration => {
                    const checkbox = document.getElementById(integration + '-enabled');
                    const config = document.getElementById(integration + '-config');

                    if (checkbox && config) {
                        checkbox.addEventListener('change', (e) => {
                            config.style.display = e.target.checked ? 'block' : 'none';
                        });
                    }
                });

                // Connection buttons (placeholders)
                document.getElementById('connect-google-calendar-btn')?.addEventListener('click', () => {
                    alert('Google Calendar integration - Coming soon!');
                });

                document.getElementById('connect-google-sheets-btn')?.addEventListener('click', () => {
                    alert('Google Sheets integration - Coming soon!');
                });

                document.getElementById('connect-notion-btn')?.addEventListener('click', () => {
                    alert('Notion integration - Coming soon!');
                });

                document.getElementById('connect-gmail-btn')?.addEventListener('click', () => {
                    alert('Gmail integration - Coming soon!');
                });
            }

            function setupPrivacySettings() {
                ['save-conversations', 'save-transcriptions', 'analytics-enabled', 'crash-reports', 'improve-models'].forEach(id => {
                    document.getElementById(id).addEventListener('change', async (e) => {
                        const key = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                        await saveSetting('privacy', key, e.target.checked);
                    });
                });
            }

            function setupAdvancedSettings() {
                // Checkboxes
                ['hardware-acceleration', 'developer-mode'].forEach(id => {
                    document.getElementById(id).addEventListener('change', async (e) => {
                        const key = id.replace(/-([a-z])/g, g => g[1].toUpperCase());
                        await saveSetting('advanced', key, e.target.checked);
                    });
                });

                // Selects and inputs
                document.getElementById('log-level-select').addEventListener('change', async (e) => {
                    await saveSetting('advanced', 'logLevel', e.target.value);
                });

                document.getElementById('max-cache-size').addEventListener('change', async (e) => {
                    await saveSetting('advanced', 'maxCacheSize', parseInt(e.target.value));
                });

                document.getElementById('network-timeout').addEventListener('change', async (e) => {
                    await saveSetting('advanced', 'networkTimeout', parseInt(e.target.value));
                });

                // Clear data
                document.getElementById('clear-data-btn').addEventListener('click', async () => {
                    const options = {
                        conversations: document.getElementById('clear-conversations').checked,
                        transcriptions: document.getElementById('clear-transcriptions').checked,
                        cache: document.getElementById('clear-cache').checked,
                        workflows: document.getElementById('clear-workflows').checked
                    };

                    if (!Object.values(options).some(v => v)) {
                        alert('Please select at least one data type to clear.');
                        return;
                    }

                    const confirmed = await customConfirm({
                        title: 'Clear Data',
                        message: 'Are you sure you want to clear selected data? This cannot be undone.',
                        confirmText: 'Clear Data',
                        type: 'danger'
                    });
                    
                    if (confirmed) {
                        const result = await window.electronAPI.invoke('settings-clear-data', options);
                        if (result.success) {
                            alert('Data cleared: ' + result.cleared.join(', '));
                            loadDataStatistics();
                        } else {
                            alert('Error clearing data: ' + result.error);
                        }
                    }
                });

                // Export settings
                document.getElementById('export-settings-btn').addEventListener('click', async () => {
                    const result = await window.electronAPI.invoke('settings-export');
                    if (result.success) {
                        const dataStr = JSON.stringify(result.data, null, 2);
                        const dataBlob = new Blob([dataStr], { type: 'application/json' });
                        const url = URL.createObjectURL(dataBlob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = 'red-glass-settings-' + new Date().toISOString().split('T')[0] + '.json';
                        link.click();
                    }
                });

                // Import settings
                document.getElementById('import-settings-btn').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = async (e) => {
                        const file = e.target.files[0];
                        const reader = new FileReader();
                        reader.onload = async (event) => {
                            try {
                                const data = JSON.parse(event.target.result);
                                const result = await window.electronAPI.invoke('settings-import', data);
                                if (result.success) {
                                    alert('Settings imported successfully!');
                                    await loadAllSettings();
                                } else {
                                    alert('Error importing settings: ' + result.error);
                                }
                            } catch (error) {
                                alert('Invalid settings file: ' + error.message);
                            }
                        };
                        reader.readAsText(file);
                    };
                    input.click();
                });

                // Reset all settings
                document.getElementById('reset-all-settings-btn').addEventListener('click', async () => {
                    const confirmed = await customConfirm({
                        title: 'Reset All Settings',
                        message: 'Are you sure you want to reset all settings to defaults? This cannot be undone.',
                        confirmText: 'Reset All',
                        type: 'danger'
                    });
                    
                    if (confirmed) {
                        await window.electronAPI.invoke('settings-reset-all');
                        alert('All settings have been reset to defaults.');
                        await loadAllSettings();
                    }
                });

                // Delete all data
                document.getElementById('delete-account-btn').addEventListener('click', async () => {
                    const confirmation = prompt('Type "DELETE" to permanently delete all data:');
                    if (confirmation === 'DELETE') {
                        const options = {
                            conversations: true,
                            transcriptions: true,
                            cache: true,
                            workflows: true
                        };
                        await window.electronAPI.invoke('settings-clear-data', options);
                        await window.electronAPI.invoke('settings-reset-all');
                        alert('All data has been deleted.');
                    }
                });
            }

            async function saveSetting(category, key, value) {
                try {
                    const result = await window.electronAPI.invoke('settings-set-setting', { category, key, value });
                    if (!result.success) {
                        console.error('Error saving setting:', result.error);
                    }
                } catch (error) {
                    console.error('Error saving setting:', error);
                }
            }

            async function loadDataStatistics() {
                try {
                    const result = await window.electronAPI.invoke('settings-get-data-stats');
                    if (result.success) {
                        const stats = result.stats;
                        document.getElementById('conversations-stat').textContent =
                            `${stats.conversations.count} files (${stats.conversations.sizeFormatted})`;
                        document.getElementById('transcriptions-stat').textContent =
                            `${stats.transcriptions.count} files (${stats.transcriptions.sizeFormatted})`;
                        document.getElementById('cache-stat').textContent = stats.cache.sizeFormatted;
                        document.getElementById('total-stat').textContent = stats.total.sizeFormatted;
                    }
                } catch (error) {
                    console.error('Error loading data statistics:', error);
                }
            }

            // Initialize settings when settings window is shown
            listItems.forEach((item, index) => {
                item.addEventListener('click', () => {
                    if (item.dataset.target === 'settings-window') {
                        initializeSettings();
                    }
                });
            });

            // ================================
            // GEMINI LIVE INTEGRATION
            // ================================

            let geminiLiveActive = false;
            let currentGeminiResponse = null;
            let geminiTextBuffer = '';
            let geminiTypewriterActive = false;

            // Initialize Gemini Live event listeners
            function initializeGeminiLive() {
                // Listen for Gemini Live text responses
                window.ipcRenderer.on('gemini-text', (_e, data) => {
                    console.log('ðŸ¤– Gemini Live text:', data);
                    if (data.text) {
                        if (!currentGeminiResponse) {
                            // Create new response message with empty text
                            const messageElement = document.createElement('div');
                            messageElement.classList.add('message', 'ai-message');

                            const textElement = document.createElement('span');
                            textElement.classList.add('text-content', 'typewriter-text');
                            textElement.innerHTML = '';
                            messageElement.appendChild(textElement);

                            conversationView.appendChild(messageElement);
                            currentGeminiResponse = textElement;
                            geminiTextBuffer = '';
                        }

                        // Add new text to buffer
                        geminiTextBuffer += data.text;

                        // Start typewriter if not already active
                        if (!geminiTypewriterActive) {
                            geminiTypewriterActive = true;
                            streamingTypewriterEffect(currentGeminiResponse, () => geminiTextBuffer);
                        }

                        scrollToBottom();
                    }
                });

                // Listen for Gemini Live audio responses
                window.ipcRenderer.on('gemini-audio', (_e, data) => {
                    console.log('ðŸ¤– Gemini Live audio received');
                    if (data.data) {
                        // Play audio response
                        playGeminiAudio(data.data);
                    }
                });

                // Listen for turn complete (response finished)
                window.ipcRenderer.on('gemini-turn-complete', (_e, data) => {
                    console.log('ðŸ¤– Gemini Live turn complete');
                    if (currentGeminiResponse) {
                        // Stop the typewriter and prepare for next response
                        geminiTypewriterActive = false;
                        // Don't reset currentGeminiResponse immediately to allow typewriter to finish
                        setTimeout(() => {
                            currentGeminiResponse = null;
                            geminiTextBuffer = '';
                        }, 1500);
                    }
                });

                // Listen for Gemini Live status updates
                window.ipcRenderer.on('gemini-status', (_e, data) => {
                    console.log('ðŸ¤– Gemini Live status:', data);
                    geminiLiveActive = data.running;
                    updateGeminiLiveUI();

                    // If Gemini Live stopped, finalize the typewriter
                    if (!data.running && currentGeminiResponse) {
                        geminiTypewriterActive = false;
                        currentGeminiResponse = null;
                        geminiTextBuffer = '';
                    }
                });

                // Listen for Gemini Live errors
                window.ipcRenderer.on('gemini-error', (_e, data) => {
                    console.error('ðŸ¤– Gemini Live error:', data);
                    addMessage(`âŒ Gemini Live Error: ${data.message}`, 'ai', false, false);

                    // Reset Gemini Live state
                    geminiTypewriterActive = false;
                    currentGeminiResponse = null;
                    geminiTextBuffer = '';
                });

                // Check initial Gemini Live status
                window.electronAPI.getGeminiLiveStatus().then(status => {
                    geminiLiveActive = status.running;
                    updateGeminiLiveUI();
                });
            }

            function playGeminiAudio(base64AudioData) {
                try {
                    // Convert base64 to audio blob and play
                    const audioData = atob(base64AudioData);
                    const audioArray = new Uint8Array(audioData.length);
                    for (let i = 0; i < audioData.length; i++) {
                        audioArray[i] = audioData.charCodeAt(i);
                    }

                    const audioBlob = new Blob([audioArray], { type: 'audio/wav' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    const audio = new Audio(audioUrl);

                    audio.play().catch(error => {
                        console.error('Error playing Gemini Live audio:', error);
                    });

                    // Clean up URL after playing
                    audio.onended = () => {
                        URL.revokeObjectURL(audioUrl);
                    };
                } catch (error) {
                    console.error('Error processing Gemini Live audio:', error);
                }
            }

            function updateGeminiLiveUI() {
                // Update UI to show Gemini Live status
                // You can add visual indicators here
                console.log('ðŸ¤– Gemini Live UI updated, active:', geminiLiveActive);
            }

            // Enhanced message processing with Gemini Live
            async function processMessageWithGeminiLive(text) {
                // Clear any previous response
                currentGeminiResponse = null;

                // Check if screen capture is active (fallback to false if not defined)
                const captureActive = typeof isCaptureActive !== 'undefined' ? isCaptureActive : false;

                // Start Gemini Live if not active
                if (!geminiLiveActive) {
                    console.log('ðŸ¤– Starting Gemini Live service...');
                    const startResult = await window.electronAPI.startGeminiLive({
                        mode: 'none', // start without capture by default
                        enableAudio: true,
                        enableVideo: false
                    });

                    if (!startResult.success) {
                        console.error('Failed to start Gemini Live:', startResult.error);
                        addMessage(`âŒ Failed to start Gemini Live: ${startResult.error}`, 'ai', false, false);
                        return;
                    }
                }

                // Send message to Gemini Live
                const sendResult = await window.electronAPI.sendToGeminiLive(text);
                if (!sendResult.success) {
                    console.error('Failed to send message to Gemini Live:', sendResult.error);
                    addMessage(`âŒ Failed to send message: ${sendResult.error}`, 'ai', false, false);
                    return;
                }

                console.log('ðŸ¤– Message sent to Gemini Live, waiting for response...');
                // Response will come via events
            }

            // Initialize Gemini Live when page loads
            document.addEventListener('DOMContentLoaded', function () {
                initializeGeminiLive();
            });

            // Also initialize if DOM is already loaded
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeGeminiLive);
            } else {
                initializeGeminiLive();
            }

        }; // End of initializeNavigationUI function

    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&display=swap" rel="stylesheet">
    <script src="load-mcp.js"></script>
    <script src="load-workflow-builder.js"></script>
    <!-- Liquid Glass Canvas -->
    <canvas id="liquid-glass-canvas"
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; pointer-events: none;"></canvas>

    <!-- Shaders -->
    <script id="fragmentShader" type="x-shader/x-fragment">
        precision mediump float;
        uniform float u_dpr;
        uniform sampler2D u_background;
        uniform vec2 u_resolution;
        
        // Support up to 10 items
        #define MAX_ITEMS 10
        uniform int u_count;
        uniform vec2 u_centers[MAX_ITEMS];
        uniform vec2 u_sizes[MAX_ITEMS];
        uniform float u_radii[MAX_ITEMS];

        varying vec2 v_uv;
    
        float roundedBoxSDF(vec2 p, vec2 b, float r) {
            vec2 d = abs(p) - b + vec2(r);
            return length(max(d, 0.0)) - r;
        }

        // Returns distance and index of closest box
        vec2 getClosestDist(vec2 pixelUV) {
            float minDist = 10000.0;
            float closestIndex = -1.0;

            for (int i = 0; i < MAX_ITEMS; i++) {
                // In WebGL 1, loops must be unrollable. 
                // We cannot break dynamically based on a uniform in some drivers.
                // We continue but check index against u_count in the logic.
                
                if (i < u_count) {
                    vec2 center = u_centers[i];
                    vec2 size = u_sizes[i] * 0.5; // Half-size for SDF
                    float radius = u_radii[i];

                    float dist = roundedBoxSDF(pixelUV - center, size, radius);
                    if (dist < minDist) {
                        minDist = dist;
                        closestIndex = float(i);
                    }
                }
            }
            return vec2(minDist, closestIndex);
        }
    
        vec2 getNormal(vec2 uv, int index) {
            vec2 eps = vec2(1.0) / u_resolution * 2.0;
            
            // We cannot use a variable index for array access in WebGL 1 in some cases.
            // But since we are inside a function called with a variable, it's tricky.
            // However, we can iterate again to find the matching index.
            
            vec2 center = vec2(0.0);
            vec2 size = vec2(0.0);
            float radius = 0.0;
            
            for (int i = 0; i < MAX_ITEMS; i++) {
                if (i == index) {
                    center = u_centers[i];
                    size = u_sizes[i] * 0.5;
                    radius = u_radii[i];
                }
            }
            
            vec2 p = uv - center;
    
            float dx = (roundedBoxSDF(p + vec2(eps.x, 0.0), size, radius) - roundedBoxSDF(p - vec2(eps.x, 0.0), size, radius)) * 0.5;
            float dy = (roundedBoxSDF(p + vec2(0.0, eps.y), size, radius) - roundedBoxSDF(p - vec2(0.0, eps.y), size, radius)) * 0.5;
    
            return normalize(vec2(dx, dy));
        }
    
        void main() {
            vec2 pixelUV = (v_uv * u_resolution) / u_dpr;
            
            // Find closest UI element
            vec2 closest = getClosestDist(pixelUV);
            float dist = closest.x;
            int index = int(closest.y);

            if (dist > 1.0 || index == -1) {
                gl_FragColor = texture2D(u_background, v_uv);
                return;
            }

            // Retrieve props for the found index
            vec2 center = vec2(0.0);
            vec2 size = vec2(0.0);
            
            for (int i = 0; i < MAX_ITEMS; i++) {
                if (i == index) {
                    center = u_centers[i];
                    size = u_sizes[i] * 0.5;
                }
            }

            vec2 local = (pixelUV - center) / size;
            
            // Edge contour refraction
            float contourFalloff = exp(-abs(dist) * 0.4); 
            vec2 normal = getNormal(pixelUV, index);
            
            // Simple refraction based on normal
            float eta = 1.0 / 1.5;
            vec2 domeNormal = normal * pow(contourFalloff, 1.0);
            vec2 refractVec = refract(vec2(0.0), domeNormal, eta);
            
            vec2 refractUV = v_uv + refractVec * 0.02 * contourFalloff;

            vec3 refracted = texture2D(u_background, refractUV).rgb;
            
            vec3 base = refracted;

            // Edge glow
            float edge = 1.0 - smoothstep(0.0, 0.03, dist * -2.0);
            vec3 glow = vec3(0.8);
            vec3 color = mix(base, glow, edge * 0.4);

            gl_FragColor = vec4(color, 1.0);
        }
    </script>
    <script id="vertexShader" type="x-shader/x-vertex">
        attribute vec2 a_position;
        varying vec2 v_uv;
        void main() {
            v_uv = vec2(a_position.x, -a_position.y) * 0.5 + 0.5;
            gl_Position = vec4(a_position, 0.0, 1.0);
        }
    </script>
    <script src="liquid-glass-shader.js"></script>

    <!-- Custom Confirm Modal -->
    <div class="custom-confirm-overlay" id="custom-confirm-overlay">
        <div class="custom-confirm-dialog">
            <div class="custom-confirm-header">
                <div class="custom-confirm-icon danger" id="custom-confirm-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                </div>
                <h3 class="custom-confirm-title" id="custom-confirm-title">Confirm Action</h3>
            </div>
            <p class="custom-confirm-message" id="custom-confirm-message">Are you sure you want to proceed?</p>
            <div class="custom-confirm-actions">
                <button class="custom-confirm-btn cancel" id="custom-confirm-cancel">Cancel</button>
                <button class="custom-confirm-btn confirm" id="custom-confirm-ok">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Custom Confirm Dialog
        window.customConfirm = function(options) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('custom-confirm-overlay');
                const titleEl = document.getElementById('custom-confirm-title');
                const messageEl = document.getElementById('custom-confirm-message');
                const iconEl = document.getElementById('custom-confirm-icon');
                const cancelBtn = document.getElementById('custom-confirm-cancel');
                const confirmBtn = document.getElementById('custom-confirm-ok');
                
                // Handle string or object options
                if (typeof options === 'string') {
                    options = { message: options };
                }
                
                const {
                    title = 'Confirm',
                    message = 'Are you sure?',
                    confirmText = 'Delete',
                    cancelText = 'Cancel',
                    type = 'danger', // danger, warning, info
                    icon = null
                } = options;
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                confirmBtn.textContent = confirmText;
                cancelBtn.textContent = cancelText;
                
                // Set icon type
                iconEl.className = 'custom-confirm-icon ' + type;
                
                // Set confirm button style
                confirmBtn.className = 'custom-confirm-btn confirm';
                if (type === 'info') {
                    confirmBtn.classList.add('primary');
                }
                
                // Update icon based on type
                const icons = {
                    danger: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 6h18"></path>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>`,
                    warning: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                        <line x1="12" y1="9" x2="12" y2="13"></line>
                        <line x1="12" y1="17" x2="12.01" y2="17"></line>
                    </svg>`,
                    info: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>`
                };
                
                iconEl.innerHTML = icon || icons[type] || icons.danger;
                
                // Show modal
                overlay.classList.add('visible');
                
                // Clean up previous listeners
                const newCancelBtn = cancelBtn.cloneNode(true);
                const newConfirmBtn = confirmBtn.cloneNode(true);
                cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                function closeModal(result) {
                    overlay.classList.remove('visible');
                    resolve(result);
                }
                
                newCancelBtn.addEventListener('click', () => closeModal(false));
                newConfirmBtn.addEventListener('click', () => closeModal(true));
                
                // Close on overlay click
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) closeModal(false);
                });
                
                // Close on Escape key
                const handleEscape = (e) => {
                    if (e.key === 'Escape') {
                        closeModal(false);
                        document.removeEventListener('keydown', handleEscape);
                    }
                };
                document.addEventListener('keydown', handleEscape);
            });
        };
    </script>
</body>

</html>